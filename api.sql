-- POSTGRESQL 
-- *********************************************************************
-- Ces sources sont la propriete du GIE SIPS et elles ne peuvent etre  *
-- utilisees sans un accord prealable du GIE SIPS. Elles ne peuvent en *
-- aucun cas etre modifiees et/ou transmises.                          *
-- *********************************************************************
-- 2016-02-10 : V2.00 Version API SQL EVOLUTIONS
-->		GET_THE_VOIE_SPE : Supprimé => utiliser GET_THE_FORME_SPE_V2
-->		GET_THE_FORME_SPE : Supprimé => utiliser GET_THE_FORME_SPE_V2
-->		GET_THE_FORME_COMP_SPE : Supprimé => utiliser GET_THE_FORME_SPE_V2
-->		GET_THE_LAB_TXT : Supprimé => utiliser GET_THE_LABO_EXPLOIT_SPE
-->		GET_THE_LAB_ID : Supprimé => utiliser GET_THE_LABO_EXPLOIT_SPE
-->		GET_THE_LAB_SPE : Supprimé => utiliser GET_THE_LABO_EXPLOIT_SPE
-->		GET_THE_REF_EFFIND : Supprimé => utiliser GET_THE_EFFET_INDE_SPE
-->		GET_THE_EFFIND_ID : Supprimé => utiliser GET_THE_EFFET_INDE_SPE
-->		GET_THE_FCO_ID_BY_SPE : Supprimé => utiliser GET_THE_VIGI_CONDUCT
-->		GET_THE_DET_FCO : Supprimé => utiliser GET_THE_VIGI_CONDUCT
-->		GET_THE_EFFIND_SPE : Supprimé => utiliser GET_THE_EFFET_INDE_SPE
-->		GET_THE_DET_EFFIND : Supprimé => utiliser GET_THE_EFFET_INDE_SPE
-->		GET_THE_DET_EFFIND_SD : Supprimé => utiliser GET_THE_EFFET_INDE_SPE
-->		GET_THE_SUB_TXT : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_SUB_ID : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_EXP_ID : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_SUB_SPE : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_SUB_PRECCOMP_SPE : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_SUB_TENEUR_SPE : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_DET_EXP : Supprimé => utiliser les API de la rubrique 6E
-->		GET_THE_DET_SUBACT : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_IND_TXT : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_IND_SPE : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_IND_SPE_PRF : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_DET_IND : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_REF_IND : Supprimé => utiliser les API de la rubrique 6
-->		GET_THE_SMR_SPE : Supprimé => utiliser GET_THE_SMR_ASMR_SPE
-->		GET_THE_SPECIALITE : Supprimé => utiliser GET_THE_SPE_DETAILS
-->		GET_THE_NIV_GRAV : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_CIPEMG : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_DET_CIPEMG : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_REF_CIPEMG : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_REF_CIPEMG_RCP : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_CIPEMG_SPE : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_CIPEMG_SPE_TER : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_CIM10_CHAPT : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_ATC_TXT : Supprimé => utiliser GET_THE_ATC_DDD_V2
-->		GET_THE_ATC_ID : Supprimé => utiliser GET_THE_ATC_DDD_V2
-->		GET_THE_ATC_ATC : Supprimé => utiliser GET_THE_ATC_DDD_V2
-->		GET_THE_ATC_SPE : Supprimé => utiliser GET_THE_ATC_DDD_V2
-->		GET_THE_ATC_SPE_SP : Supprimé => utiliser GET_THE_ATC_DDD_V2
-->		GET_THE_ATC_DDD : Supprimé => utiliser GET_THE_ATC_DDD_V2
-->		GET_THE_ATC_DDD : Supprimé => utiliser GET_THE_ATC_DDD_V2
-->		GET_THE_EPHMRA_SPE : Supprimé => utiliser les API de la rubrique 2
-->		GET_THE_POSO : Supprimé => utiliser les API de la rubrique 8
-->		GET_THE_POSO_COM_UTI : Supprimé => utiliser les API de la rubrique 8
-->		GET_THE_POSO_TEXT : Supprimé => utiliser les API de la rubrique 8
-->		GET_THE_DET_POSO_SPE : Supprimé => utiliser les API de la rubrique 8
-->		GET_THE_GTIAM_ID : rSupprimé => utiliser GET_THE_INTER_SACINTER_SAC
-->		GET_THE_GEN_SPE : Supprimé => utiliser GET_THE_GEN_EQUIV
-->		GET_THE_GTIAM_DET : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_INTER_SPE : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_INCOMP_ID : Supprimé => utiliser GET_THE_INCOMPAT_SPE_SAC
-->		GET_THE_INCOMP_ID_UN : Supprimé => utiliser GET_THE_INCOMPAT_SPE_SAC
-->		GET_THE_INCOMP_DET : renommé => GET_THE_INCOMPAT_FICHE
-->		GET_THE_CIM10 : Supprimé => utiliser GET_THE_CODE_CIM10
-->		GET_THE_CIM10_V2 : Supprimé => utiliser GET_THE_CODE_CIM10
-->		GET_THE_TERRAIN : Supprimé => utiliser les API de la rubrique 10
-->		GET_THE_PRESENTATION : Supprimé => utiliser les API de la rubrique 2
-->		GET_THE_PRE_CDT : Supprimé => utiliser les API de la rubrique 2
-->		GET_THE_PRE_STATUT : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_PRE_PRI : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_SPE_STATUT : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_PRE_DSP : Supprimé => utiliser les API de la rubrique 2
-->		GET_THE_PRE_CSV : Supprimé => utiliser GET_THE_CONSERVATION_SPE
-->		GET_THE_PRE_RBT : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_GR_FIC_SPE : Supprimé => utiliser GET_THE_TER_CIPEMG_GR
-->		GET_THE_AL_FIC_SPE : Supprimé => utiliser GET_THE_TER_CIPEMG_AL
-->		GET_THE_GR_SPE : Supprimé => utiliser GET_THE_TER_CIPEMG_GR
-->		GET_THE_AL_SPE : Supprimé => utiliser GET_THE_TER_CIPEMG_AL
-->		GET_THE_FPRO_SPE : Supprimé => utiliser GET_THE_PROC_SPEV2
-->		GET_THE_PRF_PAT : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_PRF_FILS : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_PRF_INDIC : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_PRF_POSO : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_PRF_HYPER : Supprimé => utiliser les API de la rubrique 5
-->		GET_THE_REDON1 : Supprimé => utiliser GET_THE_REDON_SPE

-->     2016-05-12 : V2.02 Ajout API
-->     GET_THE_IS_OR_BIO : Retourne O si la spécialité est d'origine biologique sinon N
-->	    GET_THE_POSO_V2   : Retourne pathologie CIM10 au lieu CDF_CODIF 'NN'
-->
-->	    2016-06-24 : GET_THE_PRODUIT_DOP correction anomalie cas 1
-->                : GET_THE_COMPO_SYNTH_GSP extension LEFT JOIN
-->
-->	    2016-07-07 : GET_THE_SPE_BY_IND_UCDIND NSFP, NC via SP_INFORMATIONS
-->                : GET_THE_SPE_BY_IND_UCD NSFP, NC via SP_INFORMATIONS
-->                : GET_THE_GSP_INDIC_BY_CIM10 NSFP, NC via SP_INFORMATIONS
-->                : GET_THE_SPE_INDIC_BY_CIM10 NSFP, NC via SP_INFORMATIONS
-->                : GET_THE_RESERVE_HOSP_GSP NSFP, NC via SP_INFORMATIONS
-->
-->	    2016-09-15 : GET_THE_SPE_DSP Parenthèse sur choix 2
-->
-->     V2.06
-->	    2016-10-11 : GET_THE_SPE_DETAILS, Ajout option 0 pour recherche par nom
-->                : GET_THE_SPE_INTEROP : Equivalence des codes.
-->
-->     V2.07
-->	    2016-10-21 : GET_THE_SPE_HORMONO, Spécialités hormonotherapie
-->    
-->     V2.07b
-->	    2016-11-18 : GET_THE_GTIAM_TXT, Textes GTIAM
-->    
-->     V2.07c
-->	    2016-12-19 : GET_THE_CIPE_SPE_CIM10
-->                : GET_THE_CIPE_GSP_CIM10
-->
-->     V2.07d
-->	    2017-01-16 : GET_THE_CIPEMG_ID correction typage (NUMERIC, VARCHAR => NUMERIC, NUMERIC)
-->
-->	    2017-01-17 : GET_THE_INTER_SPE_SAC Ajout terrain favorisant et son code
-->
-->     V2.07e
-->	    2017-03-10 : GET_THE_COMPO_SPE Retourne désormais substance père
-->
-->     V2.08
-->	    2017-04-20 : GET_THE_POSO_V2 Précision fiche poso
-->
-->     V2.09
-->	    2017-06-26 : GET_THE_ANTIBIO_SPE SUPPRIME devient GET_THE_ANTIBIO_LOC_SPE et GET_THE_ANTIBIO_SYST_SPE
-->
-->	               : GET_THE_ANTIBIO_GSP SUPPRIME devient GET_THE_ANTIBIO_LOC_GSP et GET_THE_ANTIBIO_SYST_GSP
-->
-->	               : GET_THE_ANTIBIO_SYST_SPE Antibiotiques SYSTEMIQUES
-->
-->	               : GET_THE_ANTIBIO_SYST_GSP Antibiotiques SYSTEMIQUES
-->
-- >     V2.11
-- >	    2017-11-16 : Ajouts
-- >			   : GET_THE_RESERVE_HOSP_CIP Reserve Hospitalière au CIP


set search_path = thesorimed;

CREATE CAST (varchar AS numeric)
    WITHOUT FUNCTION
    AS IMPLICIT;

CREATE CAST (numeric AS varchar)
    WITHOUT FUNCTION
    AS IMPLICIT;

-- 
-- Cette fonction retourne une liste de CIP (exemple : pour IDSPE = 156
--
CREATE OR REPLACE FUNCTION thesorimed.get_cip (NUMERIC(6)) RETURNS character varying AS '
DECLARE
  idspe ALIAS FOR $1;
  rec RECORD;
  nb INTEGER := 0;
  LST_CIP character varying;
BEGIN
    FOR rec IN
        SELECT PRE_CODE_PK AS CIP FROM PRE_PRESENTATION WHERE PRE_SP_CODE_FK = idspe AND PRE_ETAT_COMMER = ''D''
            LOOP
                IF nb = 0 THEN
                    LST_CIP := rec.CIP;
                ELSE
                    LST_CIP := LST_CIP || '', '' || rec.CIP;
                END IF;
                nb := nb + 1;
            END LOOP;
  RETURN LST_CIP;
END;

' LANGUAGE 'plpgsql';

-- 
-- Cette fonction retourne une liste des formes idspe = 4561
--
CREATE OR REPLACE FUNCTION thesorimed.get_frm (NUMERIC(6)) RETURNS character varying AS '
DECLARE
  idspe ALIAS FOR $1;
  rec RECORD;
  nb INTEGER := 0;
  LST_FRM character varying;
BEGIN
    FOR rec IN
        SELECT CDF_NOM as FRM FROM CDF_CODIF, SPFO_SPECIALITE_FORME WHERE SPFO_SP_CODE_FK_PK = idspe AND CDF_CODE_PK = SPFO_CDF_FO_CODE_FK_PK AND CDF_NUMERO_PK = ''06'' ORDER BY SPFO_NUMORD
            LOOP
                IF nb = 0 THEN
                    LST_FRM := rec.FRM;
                ELSE
                    LST_FRM := LST_FRM || '', '' || rec.FRM;
                END IF;
                nb := nb + 1;
            END LOOP;
  RETURN LST_FRM;
END;

' LANGUAGE 'plpgsql';

-- 
-- Cette fonction retourne une liste des voies idspe = 4561
--
CREATE OR REPLACE FUNCTION thesorimed.get_voie (NUMERIC(6)) RETURNS character varying AS '
DECLARE
  idspe ALIAS FOR $1;
  rec RECORD;
  nb INTEGER := 0;
  LST_VOIE character varying;
BEGIN
    FOR rec IN
        SELECT CDF_NOM as VOIE FROM CDF_CODIF, SPVO_SPECIALITE_VOIE WHERE SPVO_SP_CODE_FK_PK = idspe AND CDF_CODE_PK = SPVO_CDF_VO_CODE_FK_PK AND CDF_NUMERO_PK = ''18'' ORDER BY SPVO_NUMSEQ
            LOOP
                IF nb = 0 THEN
                    LST_VOIE := rec.VOIE;
                ELSE
                    LST_VOIE := LST_VOIE || '', '' || rec.VOIE;
                END IF;
                nb := nb + 1;
            END LOOP;
  RETURN LST_VOIE;
END;

' LANGUAGE 'plpgsql';

-- 
-- Cette fonction retourne le statut ATU O ou N test : idspe = 7087 (PROSTIGMIN : Oui) / 8849 (EPREX : Non)
--
CREATE OR REPLACE FUNCTION thesorimed.is_atu (NUMERIC(6)) RETURNS character varying AS '
DECLARE
  idspe ALIAS FOR $1;
  rec RECORD;
  O INTEGER := 0;
  N INTEGER := 0;
  ATU character varying;
BEGIN

        SELECT DISTINCT COUNT(*) INTO O
        FROM SP_SPECIALITE
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''15''
          AND CDF.CDF_CODE_PK = ''6'')
        WHERE SP_CODE_SQ_PK = idspe;

        SELECT DISTINCT COUNT(*) INTO N
        FROM SP_SPECIALITE
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''15''
          AND CDF.CDF_CODE_PK != ''6'')
        WHERE SP_CODE_SQ_PK = idspe;
        
        IF (N > O ) THEN
            ATU = ''N'';
        ELSE
            ATU = ''O'';
        END IF;
  RETURN ATU;
END;

' LANGUAGE 'plpgsql';

-- 
-- Cette fonction retourne le statut RETROCESSION test : idspe = 36271 (TIVICAY : Oui) / 8849 (EPREX : Non)
--
CREATE OR REPLACE FUNCTION thesorimed.is_retro (NUMERIC(6)) RETURNS character varying AS '
DECLARE
  idspe ALIAS FOR $1;
  rec RECORD;
  O INTEGER := 0;
  N INTEGER := 0;
  RETRO character varying;
BEGIN

        SELECT DISTINCT COUNT(*) INTO O
        FROM SP_SPECIALITE SP, PRE_PRESENTATION PRE, PREDICO_COMMENT_DISPENSAT PREDICO, CDF_CODIF RET
        WHERE SP.SP_CODE_SQ_PK = idspe
        AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
        AND PRE.PRE_CODE_PK = PREDICO.PREDICO_PRE_CODE_FK_PK
        AND RET.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
        AND RET.CDF_NUMERO_PK = ''29''
        AND RET.CDF_CODE_PK = ''3'';

        SELECT DISTINCT COUNT(*) INTO N
        FROM SP_SPECIALITE SP2
        WHERE SP2.SP_CODE_SQ_PK = idspe
        AND SP2.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP, PRE_PRESENTATION PRE, PREDICO_COMMENT_DISPENSAT PREDICO, CDF_CODIF RET
          WHERE SP.SP_CODE_SQ_PK = idspe
          AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
          AND PRE.PRE_CODE_PK = PREDICO.PREDICO_PRE_CODE_FK_PK
          AND RET.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
          AND RET.CDF_NUMERO_PK = ''29''
          AND RET.CDF_CODE_PK = ''3''
          );
        
        IF (N > O ) THEN
            RETRO = ''N'';
        ELSE
            RETRO = ''O'';
        END IF;
  RETURN RETRO;
END;

' LANGUAGE 'plpgsql';

-- 
-- Cette fonction retourne le statut T2A test : idspe = 8849 (EPREX : Oui)
--
CREATE OR REPLACE FUNCTION thesorimed.is_t2a (NUMERIC(6)) RETURNS character varying AS '
DECLARE
  idspe ALIAS FOR $1;
  rec RECORD;
  O INTEGER := 0;
  N INTEGER := 0;
  T2A character varying;
BEGIN

        SELECT DISTINCT COUNT(*) INTO O
        FROM SP_SPECIALITE SP, PRE_PRESENTATION PRE, PRESTR_STATUT_REMBOURST PRESTR, CDF_CODIF
        WHERE SP.SP_CODE_SQ_PK = idspe
        AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
        AND PRE.PRE_CODE_PK = PRESTR.PRESTR_PRE_CODE_FK_PK
        AND CDF_CODE_PK = PRESTR.PRESTR_CDF_STR_CODE_FK_PK
        AND CDF_NUMERO_PK = ''14''
        AND (CDF_CODE_PK LIKE ''R1'' OR CDF_CODE_PK LIKE ''R4'');

        SELECT DISTINCT COUNT(*) INTO N
        FROM SP_SPECIALITE SP2
        WHERE SP2.SP_CODE_SQ_PK = @idspe
        AND SP2.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP3.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP3, PRE_PRESENTATION PRE, PRESTR_STATUT_REMBOURST PRESTR, CDF_CODIF
          WHERE SP3.SP_CODE_SQ_PK = @idspe
          AND SP3.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
          AND PRE.PRE_CODE_PK = PRESTR.PRESTR_PRE_CODE_FK_PK
          AND CDF_CODE_PK = PRESTR.PRESTR_CDF_STR_CODE_FK_PK
          AND CDF_NUMERO_PK = ''14''
          AND (CDF_CODE_PK LIKE ''R1'' OR CDF_CODE_PK LIKE ''R4'')
          );        
        IF (N > O ) THEN
            T2A = ''N'';
        ELSE
            T2A = ''O'';
        END IF;
  RETURN T2A;
END;

' LANGUAGE 'plpgsql';

-- 
-- Cette fonction retourne les conditions de conservation pour un CIP donné test : 3400955849513
--
CREATE OR REPLACE FUNCTION thesorimed.get_cons (VARCHAR(13)) RETURNS character varying AS '
DECLARE
  cip ALIAS FOR $1;
  rec RECORD;
  nb INTEGER := 0;
  LST_CONS character varying;
BEGIN
    FOR rec IN
        SELECT CDF_NOM as CONS FROM PERCS_PERIODE_COND_CSV, CDF_CODIF WHERE PERCS_PRE_CODE_FK_PK = cip AND CDF_CODE_PK = PERCS_CDF_CSV_CODE_FK_PK AND CDF_NUMERO_PK = ''03'' GROUP BY CDF_NOM
            LOOP
                IF nb = 0 THEN
                    LST_CONS := rec.CONS;
                ELSE
                    LST_CONS := LST_CONS || '', '' || rec.CONS;
                END IF;
                nb := nb + 1;
            END LOOP;
  RETURN LST_CONS;
END;

' LANGUAGE 'plpgsql';

-- 
-- Cette fonction retourne le statut Hormonothérapie : idspe = 33454 (ETHINYLESTRADIOL : Oui)
--
CREATE OR REPLACE FUNCTION thesorimed.is_hormono (NUMERIC(6)) RETURNS character varying AS '
DECLARE
  idspe ALIAS FOR $1;
  rec RECORD;
  O INTEGER := 0;
  N INTEGER := 0;
  HOR character varying;
BEGIN

        SELECT count(*) INTO O
        FROM SP_SPECIALITE
        WHERE SP_CODE_SQ_PK = idspe
		AND SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''ZZG'');

        SELECT count(*) INTO N
        FROM SP_SPECIALITE
        WHERE SP_CODE_SQ_PK = idspe
		AND SP_CATC_CODE_FK NOT IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''ZZG'');
        
        IF (N > O ) THEN
            HOR = ''N''''est pas une médicament d''''hormonothérapie'';
        ELSE
            HOR = ''Médicament d''''hormonothérapie (Hors insulines)'';
        END IF;
  RETURN HOR;
END;

' LANGUAGE 'plpgsql';




-- API GET_THE_GEN_EQUIV
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_GEN_EQUIV(NUMERIC,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_GEN_EQUIV (NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  CODEID ALIAS FOR $1;  VARTYP ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF VARTYP = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT A.SP_NOM AS GSP_NOM, A.SP_CODE_SQ_PK AS SP_CODE_EQUIV, GSP_NOM AS LIB_VIRT, B.SP_NOM AS SP_PARAM, B.SP_CODE_SQ_PK AS SP_CODE_SQ_PK
FROM SP_SPECIALITE A, PRE_PRESENTATION, SP_SPECIALITE B, GSP_GENERIQUE_SPECIALITE
WHERE B.SP_GSP_CODE_FK = A.SP_GSP_CODE_FK
AND B.SP_CODE_SQ_PK =  ''''''||CODEID||''''''
AND A.SP_CODE_SQ_PK = PRE_SP_CODE_FK
AND A.SP_CODE_SQ_PK <> ''''''||CODEID||''''''
AND GSP_CODE_SQ_PK = B.SP_GSP_CODE_FK
UNION
SELECT A.SP_NOM AS GSP_NOM, A.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, GSP_NOM AS LIB_VIRT, A.SP_NOM AS SP_PARAM, A.SP_CODE_SQ_PK
FROM SP_SPECIALITE A, GSP_GENERIQUE_SPECIALITE
WHERE A.SP_CODE_SQ_PK =  ''''''||CODEID||''''''
AND GSP_CODE_SQ_PK = A.SP_GSP_CODE_FK
ORDER BY GSP_NOM
        '';
  END IF;
  IF VARTYP = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT B.SP_NOM AS GSP_NOM, B.SP_CODE_SQ_PK AS SP_CODE_EQUIV, GSP_NOM AS LIB_VIRT, A.SP_NOM AS SP_PARAM, A.SP_CODE_SQ_PK AS SP_CODE
FROM SPGREFG_GROUPE_SPE_GENE, SP_SPECIALITE B, SP_SPECIALITE A, GSP_GENERIQUE_SPECIALITE
WHERE SPGREFG_SP_CODE_FK_PK = B.SP_CODE_SQ_PK
AND SPGREFG_GREF_CODE_FK_PK = B.SP_GREF_FK
AND SPGREFG_GREF_DATECR_FK_PK = B.SP_GREF_DATECR_FK
AND SPGREFG_DATESG  IS NULL
AND A.SP_CODE_SQ_PK = ''''''||CODEID||''''''
AND SPGREFG_GREF_CODE_FK_PK = A.SP_GREF_FK
AND GSP_CODE_SQ_PK = A.SP_GSP_CODE_FK
        '';
  END IF;
  IF VARTYP = 3 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP_NOM AS GSP_NOM, SP_CODE_SQ_PK AS SP_CODE_EQUIV, GSP_NOM AS LIB_VIRT, GSP_NOM AS SP_PARAM, GSP_CODE_SQ_PK AS SP_CODE
FROM SP_SPECIALITE, GSP_GENERIQUE_SPECIALITE
WHERE SP_GSP_CODE_FK = ''''''||CODEID||''''''
AND GSP_CODE_SQ_PK = SP_GSP_CODE_FK
        '';
  END IF;
  IF VARTYP = 4 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT(GSP_NOM) AS GSP_NOM, GSP_CODE_SQ_PK AS SP_CODE_EQUIV, GSP_NOM AS LIB_VIRT, GSP_NOM AS SP_PARAM, GSP_CODE_SQ_PK AS SP_CODE
FROM SP_SPECIALITE, GSP_GENERIQUE_SPECIALITE
WHERE SP_GSP_CODE_FK = ''''''||CODEID||''''''
AND GSP_CODE_SQ_PK = SP_GSP_CODE_FK
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API GET_THE_SPE_DETAILS
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_SPE_DETAILS(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SPE_DETAILS (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  CODEID ALIAS FOR $1;  VARTYP ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF VARTYP = 0 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP.SP_CATC_CODE_FK, SP.SP_CEPH_CODE_FK,
      SP.SP_TYPE_SPE, SP.SP_NOM, SP.SP_NOMCOMP, SP.SP_CIPUCD, SP.SP_NL, SP.SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
      where SP.SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP.SP_CDF_LI_CODE_FK = b.CDF_CODE_PK
      and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP.SP_NOM LIKE ''''''||CODEID||'''''' and (SP.SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP.SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
 order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 1 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP.SP_CATC_CODE_FK, SP.SP_CEPH_CODE_FK,
      SP.SP_TYPE_SPE, SP.SP_NOM, SP.SP_NOMCOMP, SP.SP_CIPUCD, SP.SP_NL, SP.SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
      where SP.SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP.SP_CDF_LI_CODE_FK = b.CDF_CODE_PK
      and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP.SP_CODE_SQ_PK = ''''''||CODEID||'''''' and (SP.SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP.SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
 order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 2 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP.SP_CATC_CODE_FK, SP.SP_CEPH_CODE_FK,
      SP.SP_TYPE_SPE, SP.SP_NOM, SP.SP_NOMCOMP, SP.SP_CIPUCD, SP.SP_NL, SP.SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
      where SP.SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP.SP_CDF_LI_CODE_FK = b.CDF_CODE_PK
      and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP.SP_CIPUCD = ''''''||CODEID||'''''' and (SP.SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP.SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 3 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP.SP_CATC_CODE_FK, SP.SP_CEPH_CODE_FK,
      SP.SP_TYPE_SPE, SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, PRE_PRESENTATION, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK AND PRE_CODE_PK = ''''''||CODEID||'''''' and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 4 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK, SP_TYPE_SPE,
      SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, SPLAB_SPECIALITE_LABO, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SPLAB_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK and SPLAB_CDF_LAB_CODE_FK_PK = ''''''||CODEID||''''''  and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 5 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK, SP_TYPE_SPE,
      SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, SPLABEX_SPE_LABO_EXPLOITANT, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SPLABEX_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK and SPLABEX_CDF_LAB_CODE_FK_PK = ''''''||CODEID||'''''' and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 6 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK, SP_TYPE_SPE,
      SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
       CDF_CODIF a, CDF_CODIF b, finsp_indspe, sp_informations INF
        where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and finsp_sp_code_fk_pk = SP.SP_CODE_SQ_PK and finsp_fin_code_fk_pk = ''''''||CODEID||'''''' and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
       order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 7 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK,
      SP_TYPE_SPE, SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' AND SP.SP_CODE_SQ_PK  in (select distinct COSAC_SP_CODE_FK_PK from COSAC_COMPO_SUBACT  where COSAC_SAC_CODE_FK_PK = ''''''||CODEID||'''''') and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      ORDER BY SP_NOM asc
        '';
  END IF;
  IF VARTYP = 8 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK,
      SP_TYPE_SPE, SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK  and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP.SP_CODE_SQ_PK in (select distinct COSAU_SP_CODE_FK_PK from COSAU_COMPO_SUBAUX where COSAU_SAU_CODE_FK_PK = ''''''||CODEID||'''''') and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      ORDER BY SP_NOM asc
        '';
  END IF;
  IF VARTYP = 9 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK,
      SP_TYPE_SPE, SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP_CEPH_CODE_FK like ''''''||CODEID||'''''' || ''''%'''' and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 10 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK,
      SP_TYPE_SPE, SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP_CATC_CODE_FK like ''''''||CODEID||'''''' || ''''%'''' and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 11 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK, SP_TYPE_SPE,
      SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, SPCPH_SPECIALITE_CLASSEPH, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP.SP_CODE_SQ_PK = SPCPH_SP_CODE_FK_PK and SPCPH_CPH_CODE_FK_PK = ''''''||CODEID||'''''' and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 12 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP_CATC_CODE_FK, SP_CEPH_CODE_FK, SP_TYPE_SPE,
      SP_NOM, SP_NOMCOMP, SP_CIPUCD, SP_NL, SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
       where SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK and SP_CDF_LI_CODE_FK = b.CDF_CODE_PK and a.CDF_NUMERO_PK = ''''15'''' and b.CDF_NUMERO_PK = ''''08'''' and SP_CGE_CODE_FK = ''''''||CODEID||'''''' and (SP_CDF_SLAB_CODE_FK  <> ''''7'''' and SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 13 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT a.SP_CODE_SQ_PK, d.CDF_NOM, a.SP_CATC_CODE_FK, a.SP_CEPH_CODE_FK, a.SP_TYPE_SPE,
      a.SP_NOM, a.SP_NOMCOMP, a.SP_CIPUCD, a.SP_NL, a.SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(a.SP_CODE_SQ_PK) AS CIP, get_frm(a.SP_CODE_SQ_PK) AS FORME,
      get_voie(a.SP_CODE_SQ_PK) AS VOIE, is_atu(a.SP_CODE_SQ_PK) AS ATU, is_retro(a.SP_CODE_SQ_PK) AS RETRO, is_t2a(a.SP_CODE_SQ_PK) AS T2A
      FROM sp_specialite a
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = a.SP_GSP_CODE_FK,
      pre_presentation, sp_specialite b, CDF_CODIF c, CDF_CODIF d, sp_informations INF
       WHERE b.SP_GSP_CODE_FK = a.SP_GSP_CODE_FK and a.SP_CDF_SLAB_CODE_FK = c.CDF_CODE_PK and a.SP_CDF_LI_CODE_FK = d.CDF_CODE_PK and c.CDF_NUMERO_PK = ''''15'''' and d.CDF_NUMERO_PK = ''''08'''' and b.sp_code_sq_pk = ''''''||CODEID||''''''  and (b.SP_CDF_SLAB_CODE_FK  <> ''''7'''' and b.SP_CDF_SLAB_CODE_FK <> ''''3'''') AND a.sp_code_sq_pk = pre_sp_code_fk and a.sp_code_sq_pk <> ''''''||CODEID||'''''' and (a.SP_CDF_SLAB_CODE_FK  <> ''''7'''' and a.SP_CDF_SLAB_CODE_FK <> ''''3'''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = a.SP_CODE_SQ_PK
      order by a.SP_NOM asc
        '';
  END IF;
  IF VARTYP = 14 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT b.SP_CODE_SQ_PK, d.CDF_NOM, b.SP_CATC_CODE_FK, b.SP_CEPH_CODE_FK,
      b.SP_TYPE_SPE, b.SP_NOM, b.SP_NOMCOMP, b.SP_CIPUCD, b.SP_NL, b.SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(b.SP_CODE_SQ_PK) AS CIP, get_frm(b.SP_CODE_SQ_PK) AS FORME,
      get_voie(b.SP_CODE_SQ_PK) AS VOIE, is_atu(b.SP_CODE_SQ_PK) AS ATU, is_retro(b.SP_CODE_SQ_PK) AS RETRO, is_t2a(b.SP_CODE_SQ_PK) AS T2A
FROM  SP_SPECIALITE b
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = b.SP_GSP_CODE_FK,
      CDF_CODIF c,  CDF_CODIF d, sp_informations INF
WHERE b.SP_CODE_SQ_PK IN (
    select distinct(SPGREFG_SP_CODE_FK_PK) from SPGREFG_GROUPE_SPE_GENE, SP_SPECIALITE a
    where SPGREFG_GREF_CODE_FK_PK = a.SP_GREF_FK
    and a.SP_CODE_SQ_PK = ''''''||CODEID||''''''
    AND SPGREFG_DATESG  is null
--    AND SPGREFG_GREF_DATECR_FK_PK = a.SP_GREF_DATECR_FK
)
 and c.CDF_CODE_PK = b.SP_CDF_SLAB_CODE_FK
 and d.CDF_CODE_PK = b.SP_CDF_LI_CODE_FK
 and c.CDF_NUMERO_PK = ''''15''''
 and d.CDF_NUMERO_PK = ''''08''''  
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = b.SP_CODE_SQ_PK
UNION
      SELECT b.SP_CODE_SQ_PK, d.CDF_NOM, b.SP_CATC_CODE_FK, b.SP_CEPH_CODE_FK,
      b.SP_TYPE_SPE, b.SP_NOM, b.SP_NOMCOMP, b.SP_CIPUCD, b.SP_NL, b.SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(b.SP_CODE_SQ_PK) AS CIP, get_frm(b.SP_CODE_SQ_PK) AS FORME,
      get_voie(b.SP_CODE_SQ_PK) AS VOIE, is_atu(b.SP_CODE_SQ_PK) AS ATU, is_retro(b.SP_CODE_SQ_PK) AS RETRO, is_t2a(b.SP_CODE_SQ_PK) AS T2A
FROM  SP_SPECIALITE b
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = b.SP_GSP_CODE_FK,
      CDF_CODIF c,  CDF_CODIF d, sp_informations INF
WHERE b.SP_CODE_SQ_PK IN (
    select distinct(SPGREFR_SP_CODE_FK_PK) from SPGREFR_GROUPE_SPE_REF, SP_SPECIALITE a
    where SPGREFR_GREF_CODE_FK_PK = a.SP_GREF_FK
    and a.SP_CODE_SQ_PK = ''''''||CODEID||''''''
--    AND SPGREFR_GREF_DATECR_FK_PK = a.SP_GREF_DATECR_FK
)
 and c.CDF_CODE_PK = b.SP_CDF_SLAB_CODE_FK
 and d.CDF_CODE_PK = b.SP_CDF_LI_CODE_FK
 and c.CDF_NUMERO_PK = ''''15''''
 and d.CDF_NUMERO_PK = ''''08''''  
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = b.SP_CODE_SQ_PK
order by SP_NOM asc
        '';
  END IF;
  IF VARTYP = 15 THEN 
    OPEN CURRET FOR EXECUTE ''select SP.SP_CODE_SQ_PK, b.CDF_NOM, SP.SP_CATC_CODE_FK, SP.SP_CEPH_CODE_FK, SP.SP_TYPE_SPE,
      SP.SP_NOM, SP.SP_NOMCOMP, SP.SP_CIPUCD, SP.SP_NL, SP.SP_NOMLONG,
      PRODUIT_DOPANT, ETAT_COMMERCIALISATION AS ETA_COM, RESERVE_HOSPITALIERE AS RH, GSP.GSP_NOM AS MED_VIRT,get_cip(SP.SP_CODE_SQ_PK) AS CIP, get_frm(SP.SP_CODE_SQ_PK) AS FORME,
      get_voie(SP.SP_CODE_SQ_PK) AS VOIE, is_atu(SP.SP_CODE_SQ_PK) AS ATU, is_retro(SP.SP_CODE_SQ_PK) AS RETRO, is_t2a(SP.SP_CODE_SQ_PK) AS T2A
      from SP_SPECIALITE SP
      LEFT JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK,
      CDF_CODIF a, CDF_CODIF b, sp_informations INF
      where SP.SP_CDF_SLAB_CODE_FK = a.CDF_CODE_PK
      and SP.SP_CDF_LI_CODE_FK = b.CDF_CODE_PK
      and a.CDF_NUMERO_PK = ''''15''''
      and b.CDF_NUMERO_PK = ''''08''''
      and upper(SP.SP_NOM) like upper(''''''||CODEID||'''''')
      -- Evolution 2,00
      AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
      order by SP.SP_NOM asc
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- DROP FUNCTION GET_THE_CIM10(NUMERIC);
CREATE OR REPLACE FUNCTION thesorimed.GET_THE_CIM10 (NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  CODEID ALIAS FOR $1;
  curRet REFCURSOR;
BEGIN
    OPEN curRet FOR select CIMCDF_CIM_CODE_FK_PK, CIMCDF_CDF_NUMERO_FK_PK, CIM_LIBELLE_COURT, CIM_LIBELLE_LONG  from CIMCDF_CIM10_CODIF, CIM10,FIN_FICHEINDIC where CIMCDF_CDF_CODE_FK_PK=FIN_FICHEINDIC.FIN_CDF_NAIN_CODE_FK_PK AND CIMCDF_CDF_NUMERO_FK_PK=''NN'' AND FIN_FICHEINDIC.FIN_CODE_SQ_PK = CODEID AND CIMCDF_CIM_CODE_FK_PK=CIM_CODE_PK union select  CIMCDF_CIM_CODE_FK_PK, CIMCDF_CDF_NUMERO_FK_PK , CIM_LIBELLE_COURT, CIM_LIBELLE_LONG from CIMCDF_CIM10_CODIF, CIM10, FINCO_FINDCOMMENT where CIMCDF_CDF_CODE_FK_PK = FINCO_CDF_COIN_CODE_FK_PK AND FINCO_FIN_CODE_FK_PK=CODEID AND CIMCDF_CDF_NUMERO_FK_PK=''NC'' AND CIMCDF_CIM_CODE_FK_PK=CIM_CODE_PK AND CIM_CODE_PK NOT IN  (select CIMCDF_CIM_CODE_FK_PK from CIMCDF_CIM10_CODIF, FIN_FICHEINDIC  where CIMCDF_CDF_CODE_FK_PK=FIN_FICHEINDIC.FIN_CDF_NAIN_CODE_FK_PK AND CIMCDF_CDF_NUMERO_FK_PK=''NN'' AND FIN_FICHEINDIC.FIN_CODE_SQ_PK = CODEID) union select CIMCDF_CIM_CODE_FK_PK, CIMCDF_CDF_NUMERO_FK_PK, CIM_LIBELLE_COURT,CIM_LIBELLE_LONG from CIMCDF_CIM10_CODIF, CIM10, FINCON_FINDCOMMENT_NATURE where CIMCDF_CDF_CODE_FK_PK = FINCON_CDF_COIN_CODE_FK_PK AND FINCON_FIN_CODE_FK_PK=CODEID AND CIMCDF_CDF_NUMERO_FK_PK=''NC'' AND CIMCDF_CIM_CODE_FK_PK=CIM_CODE_PK AND CIM_CODE_PK NOT IN (select CIMCDF_CIM_CODE_FK_PK from CIMCDF_CIM10_CODIF, FIN_FICHEINDIC where CIMCDF_CDF_CODE_FK_PK=FIN_FICHEINDIC.FIN_CDF_NAIN_CODE_FK_PK AND CIMCDF_CDF_NUMERO_FK_PK=''NN'' AND FIN_FICHEINDIC.FIN_CODE_SQ_PK = CODEID) order by CIMCDF_CDF_NUMERO_FK_PK DESC,CIMCDF_CIM_CODE_FK_PK;
  RETURN curRet;
END;

' LANGUAGE plpgsql;


-- DROP FUNCTION GET_THE_CIPEMG_ID(NUMERIC,NUMERIC);
CREATE OR REPLACE FUNCTION thesorimed.GET_THE_CIPEMG_ID (NUMERIC,VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  IDCIPEMG ALIAS FOR $1;  TYPID ALIAS FOR $2;
  curRet REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN curRet FOR SELECT DISTINCT FCPMSP_SP_CODE_FK_PK AS CODESPE, FCPMTER_NATURE_CIPEMG_PK AS NATURE, FCPMTER_NUMSEQ_PK AS SEQUENCE, FCPMTER_CDF_TER_CODE_FK_PK AS MEMO_CODE_TERRAIN, CDF_NOM AS TERRAIN 
FROM CDF_CODIF, FCPMSP_CIPEMG_SPE,FCPM_FICHECIPEMG, FCPMTER_FCPM_TERRAIN LEFT JOIN AUTCOM_AUTRE_COMMENTAIRE ON (FCPMTER_FCPM_CODE_FK_PK = AUTCOM_FCPM_CODE_FK_PK) WHERE FCPMSP_FCPM_CODE_FK_PK = FCPM_CODE_SQ_PK AND FCPM_CODE_SQ_PK = FCPMTER_FCPM_CODE_FK_PK AND CDF_CODE_PK = FCPMTER_CDF_TER_CODE_FK_PK AND FCPMSP_FCPM_CODE_FK_PK = IDCIPEMG AND FCPMTER_NATURE_CIPEMG_PK = ''C'' AND CDF_NUMERO_PK = ''CS'' ;
  END IF;
  IF TYPID = 2 THEN 
    OPEN curRet FOR SELECT DISTINCT FCPMSP_SP_CODE_FK_PK AS CODESPE, FCPMTER_NATURE_CIPEMG_PK AS NATURE, FCPMTER_NUMSEQ_PK AS SEQUENCE, FCPMTER_CDF_TER_CODE_FK_PK AS MEMO_CODE_TERRAIN, CDF_NOM AS TERRAIN 
FROM CDF_CODIF, FCPMSP_CIPEMG_SPE,FCPM_FICHECIPEMG, FCPMTER_FCPM_TERRAIN LEFT JOIN AUTCOM_AUTRE_COMMENTAIRE ON (FCPMTER_FCPM_CODE_FK_PK = AUTCOM_FCPM_CODE_FK_PK) WHERE FCPMSP_FCPM_CODE_FK_PK = FCPM_CODE_SQ_PK AND FCPM_CODE_SQ_PK = FCPMTER_FCPM_CODE_FK_PK AND CDF_CODE_PK = FCPMTER_CDF_TER_CODE_FK_PK AND FCPMSP_FCPM_CODE_FK_PK = IDCIPEMG AND FCPMTER_NATURE_CIPEMG_PK = ''P'' AND CDF_NUMERO_PK = ''CS'' ;
  END IF;
  IF TYPID = 3 THEN 
    OPEN curRet FOR SELECT DISTINCT FCPMSP_SP_CODE_FK_PK AS CODESPE, FCPMTER_NATURE_CIPEMG_PK AS NATURE, FCPMTER_NUMSEQ_PK AS SEQUENCE, FCPMTER_CDF_TER_CODE_FK_PK AS MEMO_CODE_TERRAIN, CDF_NOM AS TERRAIN 
FROM CDF_CODIF, FCPMSP_CIPEMG_SPE,FCPM_FICHECIPEMG, FCPMTER_FCPM_TERRAIN LEFT JOIN AUTCOM_AUTRE_COMMENTAIRE ON (FCPMTER_FCPM_CODE_FK_PK = AUTCOM_FCPM_CODE_FK_PK) WHERE FCPMSP_FCPM_CODE_FK_PK = FCPM_CODE_SQ_PK AND FCPM_CODE_SQ_PK = FCPMTER_FCPM_CODE_FK_PK AND CDF_CODE_PK = FCPMTER_CDF_TER_CODE_FK_PK AND FCPMSP_FCPM_CODE_FK_PK = IDCIPEMG AND FCPMTER_NATURE_CIPEMG_PK = ''N'' AND CDF_NUMERO_PK = ''CS'' ;
  END IF;
  IF TYPID = 4 THEN 
    OPEN curRet FOR SELECT DISTINCT FCPMSP_SP_CODE_FK_PK AS CODESPE, FCPMTER_NATURE_CIPEMG_PK AS NATURE, FCPMTER_NUMSEQ_PK AS SEQUENCE, FCPMTER_CDF_TER_CODE_FK_PK AS MEMO_CODE_TERRAIN, CDF_NOM AS TERRAIN 
FROM CDF_CODIF, FCPMSP_CIPEMG_SPE,FCPM_FICHECIPEMG, FCPMTER_FCPM_TERRAIN LEFT JOIN AUTCOM_AUTRE_COMMENTAIRE ON (FCPMTER_FCPM_CODE_FK_PK = AUTCOM_FCPM_CODE_FK_PK) WHERE FCPMSP_FCPM_CODE_FK_PK = FCPM_CODE_SQ_PK AND FCPM_CODE_SQ_PK = FCPMTER_FCPM_CODE_FK_PK AND CDF_CODE_PK = FCPMTER_CDF_TER_CODE_FK_PK AND FCPMSP_FCPM_CODE_FK_PK = IDCIPEMG AND FCPMTER_NATURE_CIPEMG_PK = ''I'' AND CDF_NUMERO_PK = ''CS'' ;
  END IF;
  IF TYPID = 5 THEN 
    OPEN curRet FOR SELECT DISTINCT FCPMSP_SP_CODE_FK_PK AS CODESPE, FCPMTER_NATURE_CIPEMG_PK AS NATURE, FCPMTER_NUMSEQ_PK AS SEQUENCE, FCPMTER_CDF_TER_CODE_FK_PK AS MEMO_CODE_TERRAIN, CDF_NOM AS TERRAIN 
FROM CDF_CODIF, FCPMSP_CIPEMG_SPE,FCPM_FICHECIPEMG, FCPMTER_FCPM_TERRAIN LEFT JOIN AUTCOM_AUTRE_COMMENTAIRE ON (FCPMTER_FCPM_CODE_FK_PK = AUTCOM_FCPM_CODE_FK_PK) WHERE FCPMSP_FCPM_CODE_FK_PK = FCPM_CODE_SQ_PK AND FCPM_CODE_SQ_PK = FCPMTER_FCPM_CODE_FK_PK AND CDF_CODE_PK = FCPMTER_CDF_TER_CODE_FK_PK AND FCPMSP_FCPM_CODE_FK_PK = IDCIPEMG AND FCPMTER_NATURE_CIPEMG_PK IN (''C'',''P'',''N'',''I'') AND CDF_NUMERO_PK = ''CS'' ;
  END IF;
  RETURN curRet;
END;

' LANGUAGE plpgsql;



-- API GET_THE_INCOMPAT_FICHE
-- EXEMPLE: LISTID := '1167,2111'

-- DROP FUNCTION GET_THE_INCOMPAT_FICHE(NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INCOMPAT_FICHE (NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  NOFIC ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''select DISTINCT FIC_CODE_SQ_PK AS NO_FIC, 
  SAC1.SAC_NOM AS SAC_NOM_T1, SAC1.SAC_CODE_SQ_PK AS SAC_CODE_T1, SAC2.SAC_NOM AS SAC_NOM_T2, SAC2.SAC_CODE_SQ_PK AS SAC_CODE_T2,
  A.SP_NOM AS LIB_SPE_T1, A.SP_CODE_SQ_PK AS ID_SPE_T1, B.SP_NOM AS LIB_SPE_T2, B.SP_CODE_SQ_PK AS ID_SPE_T2
FROM SP_SPECIALITE A, SP_SPECIALITE B, IC1SP_TERME1SPECIALITE, IC2SP_TERME2SPECIALITE,
  COSAC_COMPO_SUBACT CO1, SAC_SUBACTIVE SAC1, COSAC_COMPO_SUBACT CO2, SAC_SUBACTIVE SAC2, FIC_INCOMPATIBILITE
where IC1SP_SP_CODE_FK_PK = A.SP_CODE_SQ_PK
AND IC2SP_SP_CODE_FK_PK = B.SP_CODE_SQ_PK
AND IC1SP_FIC_CODE_FK_PK = FIC_CODE_SQ_PK
AND IC2SP_FIC_CODE_FK_PK = FIC_CODE_SQ_PK
AND CO1.COSAC_SP_CODE_FK_PK = A.SP_CODE_SQ_PK
AND SAC1.SAC_CODE_SQ_PK = CO1.COSAC_SAC_CODE_FK_PK
AND CO2.COSAC_SP_CODE_FK_PK = B.SP_CODE_SQ_PK
AND SAC2.SAC_CODE_SQ_PK = CO2.COSAC_SAC_CODE_FK_PK
AND FIC_CODE_SQ_PK = ''''''||NOFIC||''''''
AND FIC_TYPE = ''''I''''
ORDER BY NO_FIC, LIB_SPE_T1, LIB_SPE_T2'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;



-- DROP FUNCTION GET_THE_INTER(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION thesorimed.GET_THE_INTER (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTSPE ALIAS FOR $1;  NIVINTER ALIAS FOR $2;
  curRet REFCURSOR;
BEGIN
    OPEN curRet FOR EXECUTE ''SELECT IT1SP_FIT_CODE_FK_PK AS IDINTER,IT1SP_SP_CODE_FK_PK AS IDSPE1,IT2SP_SP_CODE_FK_PK AS IDSPE2,FIT_TEXTE AS TEXTE,NIVEAU.CDF_NOM AS NIVEAU
FROM IT1SP_TERME1SPECIALITE, IT2SP_TERME2SPECIALITE, FIT_FICHEINTERAC, 
     FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION,CDF_CODIF NIVEAU
WHERE IT1SP_FIT_CODE_FK_PK = IT2SP_FIT_CODE_FK_PK
  AND IT1SP_SP_CODE_FK_PK IN (''||LISTSPE||'')
  AND IT2SP_SP_CODE_FK_PK IN (''||LISTSPE||'')
  AND IT1SP_SP_CODE_FK_PK <> IT2SP_SP_CODE_FK_PK
  AND IT1SP_FIT_CODE_FK_PK = FIT_CODE_SQ_PK
  AND IT1SP_FIT_CODE_FK_PK = FITNA_FIT_CODE_FK_PK 
  AND FITNA_CDF_NAIT_CODE_FK_PK = ''''''||NIVINTER||''''''
  AND IT1SP_FIT_CODE_FK_PK = FITVA_FIT_CODE_FK_PK
  AND FITVA_CDF_VAIT_CODE_FK_PK = 1
  AND FITVA_CDF_VAIT_CODE_FK_PK = NIVEAU.CDF_CODE_PK
  AND NIVEAU.CDF_NUMERO_PK = ''''IV''''
ORDER BY FITNA_CDF_NAIT_CODE_FK_PK'';
  RETURN curRet;
END;

' LANGUAGE plpgsql;



-- API GET_THE_CONSERVATION_SPE
-- EXEMPLE: LISTID := '1167,2111'

-- DROP FUNCTION GET_THE_CONSERVATION_SPE(VARCHAR);
CREATE OR REPLACE FUNCTION GET_THE_CONSERVATION_SPE (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  CIPUCD ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP_CIPUCD AS CIP, get_cons(PRE_CODE_PK) AS COND_CONS, PREPER_DUREE AS DUR_CONS, DUR.CDF_NOM AS UNIT_CONS
FROM SP_SPECIALITE, PRE_PRESENTATION
LEFT JOIN PREPER_PRESENTATION_PERIO_CSV ON PREPER_PRE_CODE_FK_PK = PRE_CODE_PK
LEFT JOIN CDF_CODIF DUR ON ( DUR.CDF_CODE_PK = PREPER_CDF_UT_CODE_FK AND DUR.CDF_NUMERO_PK = ''''PU'''')
WHERE SP_CIPUCD = ''''''||CIPUCD||''''''
AND PRE_SP_CODE_FK = SP_CODE_SQ_PK
UNION
SELECT DISTINCT PRE_CODE_PK AS CIP, get_cons(PRE_CODE_PK) AS COND_CONS, PREPER_DUREE AS DUR_CONS, DUR.CDF_NOM AS UNIT_CONS
FROM PRE_PRESENTATION
LEFT JOIN PREPER_PRESENTATION_PERIO_CSV ON PREPER_PRE_CODE_FK_PK = PRE_CODE_PK
LEFT JOIN CDF_CODIF DUR ON ( DUR.CDF_CODE_PK = PREPER_CDF_UT_CODE_FK AND DUR.CDF_NUMERO_PK = ''''PU'''' )
WHERE PRE_CODE_PK = ''''''||CIPUCD||''''''
'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API GET_THE_INTER_SACINTER_SAC
-- EXEMPLE: LISTID := '1299,1761' ET TYPID := 5

-- DROP FUNCTION GET_THE_INTER_SACINTER_SAC(VARCHAR,VARCHAR);
CREATE OR REPLACE FUNCTION GET_THE_INTER_SACINTER_SAC (VARCHAR,VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTESAC ALIAS FOR $1;  GRAVITE ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF GRAVITE = ''5'' THEN 
    OPEN CURRET FOR EXECUTE ''SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER, A.SAC_NOM AS TERME_1, SP1.SP_NOM AS SP_NOM1,B.SAC_NOM AS TERME_2, SP2.SP_NOM AS SP_NOM2,
       SP1.SP_CODE_SQ_PK AS ID_T1,  
       SP2.SP_CODE_SQ_PK AS ID_T2,
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND NOT EXISTS (SELECT IT1SAC_FIT_CODE_FK_PK, IT1SAC_SAC_CODE_FK_PK
                FROM IT1SAC_TERME1SUBACTIVE 
                WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
                AND IT1SAC_SAC_CODE_FK_PK = IT2SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK <= ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
UNION
SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER, A.SAC_NOM AS TERME_1, SP1.SP_NOM AS SP_NOM1,B.SAC_NOM AS TERME_2, SP2.SP_NOM AS SP_NOM2,
       SP1.SP_CODE_SQ_PK AS ID_T1,  
       SP2.SP_CODE_SQ_PK AS ID_T2,
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND NOT EXISTS (SELECT IT2SAC_FIT_CODE_FK_PK, IT2SAC_SAC_CODE_FK_PK
                FROM IT2SAC_TERME2SUBACTIVE 
                WHERE IT2SAC_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
                AND IT2SAC_SAC_CODE_FK_PK = IT1SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK <= ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
UNION
SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END AS TERME_1,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END AS SP_NOM1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END AS TERME_2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END AS SP_NOM2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END AS ID_T1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END AS ID_T2,  
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND NOT EXISTS (SELECT IT2SAC_FIT_CODE_FK_PK, IT2SAC_SAC_CODE_FK_PK
                FROM IT2SAC_TERME2SUBACTIVE
                WHERE IT2SAC_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
                AND IT2SAC_SAC_CODE_FK_PK = IT1SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK <= ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
GROUP BY IT1SAC_FIT_CODE_FK_PK, CDF_NOM,
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END, 
       FITNA_CDF_NAIT_CODE_FK_PK 
HAVING COUNT(*) > 1
UNION
SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER,
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END AS TERME_1,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END AS SP_NOM1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END AS TERME_2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END AS SP_NOM2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END AS ID_T1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END AS ID_T2,  
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND EXISTS (SELECT IT2SAC_FIT_CODE_FK_PK, IT2SAC_SAC_CODE_FK_PK
                FROM IT2SAC_TERME2SUBACTIVE 
                WHERE IT2SAC_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
                AND IT2SAC_SAC_CODE_FK_PK = IT1SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK <= ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
GROUP BY IT1SAC_FIT_CODE_FK_PK, CDF_NOM,
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END, 
       FITNA_CDF_NAIT_CODE_FK_PK 
HAVING COUNT(*) > 1
ORDER BY IDINTER, NIVEAU
        '';
  ELSE 
    OPEN CURRET FOR EXECUTE ''SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER, A.SAC_NOM AS TERME_1, SP1.SP_NOM AS SP_NOM1,B.SAC_NOM AS TERME_2, SP2.SP_NOM AS SP_NOM2,
       SP1.SP_CODE_SQ_PK AS ID_T1,  
       SP2.SP_CODE_SQ_PK AS ID_T2,
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND NOT EXISTS (SELECT IT1SAC_FIT_CODE_FK_PK, IT1SAC_SAC_CODE_FK_PK
                FROM IT1SAC_TERME1SUBACTIVE 
                WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
                AND IT1SAC_SAC_CODE_FK_PK = IT2SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK = ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
UNION
SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER, A.SAC_NOM AS TERME_1, SP1.SP_NOM AS SP_NOM1,B.SAC_NOM AS TERME_2, SP2.SP_NOM AS SP_NOM2,
       SP1.SP_CODE_SQ_PK AS ID_T1,  
       SP2.SP_CODE_SQ_PK AS ID_T2,
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND NOT EXISTS (SELECT IT2SAC_FIT_CODE_FK_PK, IT2SAC_SAC_CODE_FK_PK
                FROM IT2SAC_TERME2SUBACTIVE 
                WHERE IT2SAC_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
                AND IT2SAC_SAC_CODE_FK_PK = IT1SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK = ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
UNION
SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END AS TERME_1,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END AS SP_NOM1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END AS TERME_2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END AS SP_NOM2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END AS ID_T1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END AS ID_T2,  
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND NOT EXISTS (SELECT IT2SAC_FIT_CODE_FK_PK, IT2SAC_SAC_CODE_FK_PK
                FROM IT2SAC_TERME2SUBACTIVE
                WHERE IT2SAC_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
                AND IT2SAC_SAC_CODE_FK_PK = IT1SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK = ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
GROUP BY IT1SAC_FIT_CODE_FK_PK, CDF_NOM,
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END, 
       FITNA_CDF_NAIT_CODE_FK_PK 
HAVING COUNT(*) > 1
UNION
SELECT IT1SAC_FIT_CODE_FK_PK AS IDINTER,
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END AS TERME_1,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END AS SP_NOM1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END AS TERME_2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END AS SP_NOM2,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END AS ID_T1, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END AS ID_T2,  
       FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU
FROM IT1SAC_TERME1SUBACTIVE, IT2SAC_TERME2SUBACTIVE, FITNA_INTERACTION_NATURE, FITVA_NIVEAU_VALIDATION, CDF_CODIF, SAC_SUBACTIVE A
JOIN COSAC_COMPO_SUBACT COS1 on ( COS1.COSAC_SAC_CODE_FK_PK = A.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = COS1.COSAC_SP_CODE_FK_PK),
 SAC_SUBACTIVE B
JOIN COSAC_COMPO_SUBACT COS2 on ( COS2.COSAC_SAC_CODE_FK_PK = B.SAC_CODE_SQ_PK)
JOIN SP_SPECIALITE SP2 ON (SP2.SP_CODE_SQ_PK = COS2.COSAC_SP_CODE_FK_PK)
WHERE IT1SAC_FIT_CODE_FK_PK = IT2SAC_FIT_CODE_FK_PK
AND IT1SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT2SAC_SAC_CODE_FK_PK IN (''||LISTESAC||'')
AND IT1SAC_SAC_CODE_FK_PK <> IT2SAC_SAC_CODE_FK_PK
AND A.SAC_CODE_SQ_PK = IT1SAC_SAC_CODE_FK_PK
AND B.SAC_CODE_SQ_PK = IT2SAC_SAC_CODE_FK_PK
AND EXISTS (SELECT IT2SAC_FIT_CODE_FK_PK, IT2SAC_SAC_CODE_FK_PK
                FROM IT2SAC_TERME2SUBACTIVE 
                WHERE IT2SAC_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
                AND IT2SAC_SAC_CODE_FK_PK = IT1SAC_SAC_CODE_FK_PK)
AND FITNA_CDF_NAIT_CODE_FK_PK = ''''''||GRAVITE||''''''
AND FITNA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND FITVA_CDF_VAIT_CODE_FK_PK = 1
AND FITVA_FIT_CODE_FK_PK = IT1SAC_FIT_CODE_FK_PK
AND CDF_CODE_PK = FITVA_CDF_VAIT_CODE_FK_PK
AND CDF_NUMERO_PK = ''''IV''''
GROUP BY IT1SAC_FIT_CODE_FK_PK, CDF_NOM,
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN B.SAC_NOM ELSE A.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN A.SAC_NOM ELSE B.SAC_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END, 
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END,  
       CASE WHEN IT1SAC_SAC_CODE_FK_PK>IT2SAC_SAC_CODE_FK_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END, 
       FITNA_CDF_NAIT_CODE_FK_PK 
HAVING COUNT(*) > 1
ORDER BY IDINTER, NIVEAU
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- DROP FUNCTION GET_THE_CIM10_BY_CODE(VARCHAR);

CREATE OR REPLACE FUNCTION GET_THE_CIM10_BY_CODE (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  CODE ALIAS FOR $1;
  curRet REFCURSOR;
BEGIN
    OPEN curRet FOR SELECT CIM_CODE_PK, CIM_LIBELLE_LONG, CDF_CODE_PK, CDF_NOM
  FROM CIM10 A, CIMCDF_CIM10_CODIF B, CDF_CODIF C
WHERE A.CIM_CODE_PK = '' || CODE || ''
AND B.CIMCDF_CIM_CODE_FK_PK = A.CIM_CODE_PK
AND C.CDF_CODE_PK = B.CIMCDF_CDF_CODE_FK_PK
AND C.CDF_NUMERO_PK = B.CIMCDF_CDF_NUMERO_FK_PK
ORDER BY CDF_CODE_PK;
  RETURN curRet;
END;
' LANGUAGE plpgsql;

-- DROP FUNCTION GET_THE_SPE_BY_IND_UCD(VARCHAR);

CREATE OR REPLACE FUNCTION GET_THE_SPE_BY_IND_UCD (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LSTCDF ALIAS FOR $1;
  curRet REFCURSOR;
BEGIN
    OPEN curRet FOR EXECUTE ''SELECT FINSP_SP_CODE_FK_PK AS CODSP, SP_CIPUCD AS CODUCD, SP_NOM AS NOMSP
FROM FIN_FICHEINDIC, FINSP_INDSPE, SP_SPECIALITE SP, SP_INFORMATIONS INF
WHERE FIN_CDF_NAIN_CODE_FK_PK IN (''||LSTCDF||'')
AND FINSP_FIN_CODE_FK_PK = FIN_CODE_SQ_PK
AND SP.SP_CODE_SQ_PK = FINSP_SP_CODE_FK_PK
AND SP.SP_CDF_SLAB_CODE_FK != 7 
AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
AND (INF.ETAT_COMMERCIALISATION NOT IN (''''S'''', ''''NC'''') AND INF.ETAT_COMMERCIALISATION IS NOT NULL)
ORDER BY SP_NOM'';
  RETURN curRet;
END;
' LANGUAGE plpgsql;

-- DROP FUNCTION GET_THE_SPE_BY_IND_UCDIND(VARCHAR);
CREATE OR REPLACE FUNCTION GET_THE_SPE_BY_IND_UCDIND (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LSTCDF ALIAS FOR $1;
  curRet REFCURSOR;
BEGIN
    OPEN curRet FOR EXECUTE ''SELECT FIN_CODE_SQ_PK AS COD_IND, FINSP_SP_CODE_FK_PK AS CODSP, SP_CIPUCD AS CODUCD, SP_NOM AS NOMSP, FIN_TEXTE AS TXTIND
FROM FIN_FICHEINDIC, FINSP_INDSPE, SP_SPECIALITE SP, SP_INFORMATIONS INF
WHERE FIN_CDF_NAIN_CODE_FK_PK IN (''||LSTCDF||'')
AND FINSP_FIN_CODE_FK_PK = FIN_CODE_SQ_PK
AND SP.SP_CODE_SQ_PK = FINSP_SP_CODE_FK_PK
AND SP.SP_CDF_SLAB_CODE_FK != 7 
AND INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
AND (INF.ETAT_COMMERCIALISATION NOT IN (''''S'''', ''''NC'''') AND INF.ETAT_COMMERCIALISATION IS NOT NULL)
ORDER BY SP_NOM'';
  RETURN curRet;
END;
' LANGUAGE plpgsql;

-- 2009-12-21 Roland Imbert
-- Ajout FUNCTION GET_THE_CIPEMG_TEXT_SP(NUMERIC,VARCHAR);
-- TYPID = 1 Contre indication; TYPID = 2 Prec. emploi, Mise en garde
-- Precision texte fait l'objet d'une nouvelle api du fait de son cote systematique (Le texte est associe a une specialite)
CREATE OR REPLACE FUNCTION thesorimed.GET_THE_CIPEMG_TEXT_SP (NUMERIC,VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  CODEID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  curRet REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN curRet FOR SELECT to_char(FCPT_DATECR, ''DD/MM/YYYY'') AS DATE_CRE, FCPTTX1_TXTCI AS TXT_CIPEMG
FROM thesorimed.FCPTSP_CIPEMG_SPE, thesorimed.FCPTAFS_CIPEMG_AFSSAPS, thesorimed.FCPT_FICHECIPEMG, thesorimed.FCPTTX1_CIPEMG_TXCI
WHERE FCPTSP_SP_CODE_FK_PK = CODEID
AND FCPTAFS_SP_CODE_FK_PK = FCPTSP_SP_CODE_FK_PK
AND FCPT_CODE_SQ_PK = FCPTSP_FCPT_CODE_FK_PK
AND FCPTTX1_FCPT_CODE_FK_PK = FCPT_CODE_SQ_PK;
  END IF;
  IF TYPID = 2 THEN 
    OPEN curRet FOR SELECT to_char(FCPT_DATECR, ''DD/MM/YYYY'') AS DATE_CRE, FCPTTX2_TXTPEMG AS TXT_CIPEMG
FROM thesorimed.FCPTSP_CIPEMG_SPE, thesorimed.FCPTAFS_CIPEMG_AFSSAPS, thesorimed.FCPT_FICHECIPEMG, thesorimed.FCPTTX2_CIPEMG_TXPEMG
WHERE FCPTSP_SP_CODE_FK_PK = CODEID
AND FCPTAFS_SP_CODE_FK_PK = FCPTSP_SP_CODE_FK_PK
AND FCPT_CODE_SQ_PK = FCPTSP_FCPT_CODE_FK_PK
AND FCPTTX2_FCPT_CODE_FK_PK = FCPT_CODE_SQ_PK;
  END IF;
  RETURN curRet;
END;

' LANGUAGE plpgsql;

-- 2010-01-15 Roland Imbert
-- Ajout des fonctions pour traitement hypersensibilites (experimental)
-- fonction : GET_THE_HYPER_CODE_BY_NAME obtenir code hyper depuis libelle

-- DROP FUNCTION GET_THE_HYPER_CODE_BY_NAME(VARCHAR);

CREATE OR REPLACE FUNCTION GET_THE_HYPER_CODE_BY_NAME (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  HYPER ALIAS FOR $1;
  curRet REFCURSOR;
BEGIN
    OPEN curRet FOR SELECT CDF_CODE_PK AS CODE, CDF_NOM as HYPER_NAME
FROM THESORIMED.CDF_CODIF
WHERE (CDF_CODE_PK LIKE ''E%'' OR CDF_CODE_PK LIKE ''H%'' OR CDF_CODE_PK LIKE ''L%'')
AND CDF_CODE_PK != ''E18''
AND CDF_NUMERO_PK = ''CC''
AND SUBSTRING(CDF_NOM, 18, LENGTH(CDF_NOM)) LIKE UPPER(HYPER)
ORDER BY CDF_NOM;
  RETURN curRet;
END;
' LANGUAGE plpgsql;

-- DROP FUNCTION GET_THE_SPE_SAME_CLS(VARCHAR);

CREATE OR REPLACE FUNCTION GET_THE_SPE_SAME_CLS (NUMERIC, NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  CODEID ALIAS FOR $1;
  TYP ALIAS FOR $2;
  curRet REFCURSOR;
  BEGIN
    IF TYP = 1 THEN 
      OPEN curRet FOR -- PHARMACO
SELECT SP_CIPUCD AS UCD, SP_NOMLONG AS NOM, CPH_NOM AS CLASSE, SPCPH_NUMORD AS NUMORD
FROM SP_SPECIALITE, SPCPH_SPECIALITE_CLASSEPH, CPH_CLASSEPHARMTHER
WHERE SPCPH_CPH_CODE_FK_PK IN (
SELECT SPCPH_CPH_CODE_FK_PK FROM SPCPH_SPECIALITE_CLASSEPH
WHERE SPCPH_SP_CODE_FK_PK = CODEID)
AND SP_CODE_SQ_PK = SPCPH_SP_CODE_FK_PK
AND SUBSTRING(SP_NOMLONG,1,1) != ''#''
AND SP_CIPUCD IS NOT NULL
AND CPH_CODE_PK = SPCPH_CPH_CODE_FK_PK
ORDER BY SPCPH_NUMORD, SP_NOM;
    END IF;
    IF TYP = 2 THEN 
      OPEN curRet FOR -- ATC
SELECT SP_CIPUCD AS UCD, SP_NOMLONG AS NOM, CATC_NOMF AS CLASSE, 1 AS NUMORD
FROM SP_SPECIALITE, CATC_CLASSEATC
WHERE SP_CATC_CODE_FK IN (
SELECT SP_CATC_CODE_FK FROM SP_SPECIALITE
WHERE SP_CODE_SQ_PK = CODEID)
AND SUBSTRING(SP_NOMLONG,1,1) != ''#''
AND SP_CIPUCD IS NOT NULL
AND CATC_CODE_PK = SP_CATC_CODE_FK
ORDER BY NUMORD, NOM;
    END IF;
    IF TYP = 3 THEN 
      OPEN curRet FOR -- EPHMRA
SELECT SP_CIPUCD AS UCD, SP_NOMLONG AS NOM, CEPH_NOMF AS CLASSE, 1 AS NUMORD
FROM SP_SPECIALITE, CEPH_CLASSEEPHMRA
WHERE SP_CEPH_CODE_FK IN (
SELECT SP_CEPH_CODE_FK FROM SP_SPECIALITE
WHERE SP_CODE_SQ_PK = 3318)
AND SUBSTRING(SP_NOMLONG,1,1) != ''#''
AND SP_CIPUCD IS NOT NULL
AND CEPH_CODE_PK = SP_CEPH_CODE_FK
ORDER BY NUMORD, NOM;
    END IF;
  RETURN curRet;
END;

' LANGUAGE plpgsql;

-- API GET_THE_CODE_CIM10
-- EXEMPLE: LISTID := '1167,2111'

-- DROP FUNCTION GET_THE_CODE_CIM10(VARCHAR);
CREATE OR REPLACE FUNCTION GET_THE_CODE_CIM10 (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  TERME1 ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT CIM_CODE, CIM_LIBELLE FROM CIM10V2
WHERE LOWER(CIM_LIBELLE) LIKE LOWER(''''''||TERME1||'''''')
AND CIM_CODE NOT LIKE ''''NC%''''
ORDER BY UPPER(CIM_LIBELLE)'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;



-- API SMR ET ASMR DE LA SPECIALITE
-- EXEMPLE: LISTID := '14584,31544,4289,7286' ET TYPID := 0 POUR SMR OU LISTID := '14584,31544,4289,7286' ET TYPID := 1 POUR ASMR

-- DROP FUNCTION GET_THE_SMR_ASMR_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SMR_ASMR_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, TO_CHAR(MAX(SPSMR.SPSMR_DATE),''''DD/MM/YYYY'''') AS DATE_SMR, CDF_NOM AS SMR
        FROM SP_SPECIALITE SP, SPSMR_SERVICE_MEDICAL_RENDU SPSMR, CDF_CODIF CDF
        WHERE SP.SP_CODE_SQ_PK = SPSMR.SPSMR_SP_CODE_FK_PK
        AND SPSMR.SPSMR_CDF_SMR_CODE_FK_PK = CDF.CDF_CODE_PK
        AND CDF.CDF_NUMERO_PK = ''''27''''
        AND (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        GROUP BY SP.SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM, CDF_NOM
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, TO_CHAR(MAX(ATR.ATR_DATE_REDACTION),''''DD/MM/YYYY'''') AS DATE_SMR, CDF.CDF_NOM AS SMR, (null) AS DESCRIPTION
      FROM SP_SPECIALITE SP
      JOIN SPATR_SPEC_AVISTRANSPARENCE SPATR ON SPATR.SPATR_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
      JOIN ATR_AVISCOMMISSIONTRANSPARENCE ATR ON ATR.ATR_CODE_SQ_PK = SPATR.SPATR_ATR_CODE_FK_PK
      JOIN ATRASMR_AVISCOMTRANS_ASMR ATRASMR ON ATRASMR.ATRASMR_ATR_CODE_FK_PK = ATR.ATR_CODE_SQ_PK
      JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = ATRASMR.ATRASMR_CDF_ASMR_CODE_FK_PK
        AND CDF.CDF_NUMERO_PK = ''''23''''
        AND CDF.CDF_CODE_PK LIKE ''''A%'''')
      WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
      AND (SP.SP_TYPE_SPE LIKE ''''R'''' OR SP.SP_TYPE_SPE IS NULL)
      GROUP BY SP.SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM, CDF.CDF_NOM
      UNION
      SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, TO_CHAR(MAX(ATR.ATR_DATE_REDACTION),''''DD/MM/YYYY'''') AS DATE_SMR, CDF.CDF_NOM AS SMR, ''''Pas d ASMR évalué pour cette spécialité mais le princeps dont elle dépend a le niveau d ASMR indiqué'''' AS DESCRIPTION
      FROM SP_SPECIALITE SP
      JOIN SP_SPECIALITE SP2 ON SP2.SP_GREF_FK = SP.SP_GREF_FK
      JOIN SPATR_SPEC_AVISTRANSPARENCE SPATR ON SPATR.SPATR_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
      JOIN ATR_AVISCOMMISSIONTRANSPARENCE ATR ON ATR.ATR_CODE_SQ_PK = SPATR.SPATR_ATR_CODE_FK_PK
      JOIN ATRASMR_AVISCOMTRANS_ASMR ATRASMR ON ATRASMR.ATRASMR_ATR_CODE_FK_PK = ATR.ATR_CODE_SQ_PK
      JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = ATRASMR.ATRASMR_CDF_ASMR_CODE_FK_PK
        AND CDF.CDF_NUMERO_PK = ''''23''''
        AND CDF.CDF_CODE_PK LIKE ''''A%'''')
      WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
      AND SP.SP_TYPE_SPE LIKE ''''G''''
      GROUP BY SP.SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM, CDF.CDF_NOM
      ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API SMR ET ASMR DU M?DICAMENT VIRTUEL
-- EXEMPLE: LISTID := '14584,31544,4289,7286' ET TYPID := 1 POUR SMR OU LISTID := '14584,31544,4289,7286' ET TYPID := 2 POUR ASMR

-- DROP FUNCTION GET_THE_SMR_ASMR_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SMR_ASMR_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, TO_CHAR(MAX(SPSMR.SPSMR_DATE),''''DD/MM/YYYY'''') AS DATE_SMR, CDF_NOM AS SMR
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, SPSMR_SERVICE_MEDICAL_RENDU SPSMR, CDF_CODIF CDF
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CODE_SQ_PK = SPSMR.SPSMR_SP_CODE_FK_PK
        AND SPSMR.SPSMR_CDF_SMR_CODE_FK_PK = CDF.CDF_CODE_PK
        AND CDF.CDF_NUMERO_PK = ''''27''''
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        GROUP BY GSP.GSP_CODE_SQ_PK, GSP.GSP_NOM, CDF_NOM
        ORDER BY 1'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, TO_CHAR(MAX(ATR.ATR_DATE_REDACTION),''''DD/MM/YYYY'''') AS DATE_SMR, CDF.CDF_NOM AS SMR
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN SPATR_SPEC_AVISTRANSPARENCE SPATR ON SPATR.SPATR_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN ATR_AVISCOMMISSIONTRANSPARENCE ATR ON ATR.ATR_CODE_SQ_PK = SPATR.SPATR_ATR_CODE_FK_PK
        JOIN ATRASMR_AVISCOMTRANS_ASMR ATRASMR ON ATRASMR.ATRASMR_ATR_CODE_FK_PK = ATR.ATR_CODE_SQ_PK
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = ATRASMR.ATRASMR_CDF_ASMR_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''23''''
          AND CDF.CDF_CODE_PK LIKE ''''A%'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        GROUP BY GSP.GSP_CODE_SQ_PK, GSP.GSP_NOM, CDF.CDF_NOM
        ORDER BY 1'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API PRODUIT STUPEFIANT
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_PRODUIT_STUP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PRODUIT_STUP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS STUP
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CDF_LI_CODE_FK = ''''3''''
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS STUP
        FROM SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
        WHERE SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
        AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
        AND CDF14.CDF_NUMERO_PK = ''''14''''
        AND CDF14.CDF_CODE_PK = ''''S95''''
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS STUP
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CDF_LI_CODE_FK = ''''3''''
          UNION
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
          WHERE SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
          AND CDF14.CDF_NUMERO_PK = ''''14''''
          AND CDF14.CDF_CODE_PK = ''''S95'''')'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS STUP
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP.SP_CDF_LI_CODE_FK = ''''3''''
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS STUP
        FROM SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
        AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
        AND CDF14.CDF_NUMERO_PK = ''''14''''
        AND ''''S95'''' = CDF14.CDF_CODE_PK
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS STUP
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CDF_LI_CODE_FK = ''''3''''
          UNION
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
          WHERE SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
          AND CDF14.CDF_NUMERO_PK = ''''14''''
          AND CDF14.CDF_CODE_PK = ''''S95'''')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API PRODUIT STUPEFIANT GSP
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_PRODUIT_STUP_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PRODUIT_STUP_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CDF_LI_CODE_FK = ''''3''''
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
        AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
        AND CDF14.CDF_NUMERO_PK = ''''14''''
        AND CDF14.CDF_CODE_PK = ''''S95''''
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CDF_LI_CODE_FK = ''''3''''
          UNION
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
          AND CDF14.CDF_NUMERO_PK = ''''14''''
          AND CDF14.CDF_CODE_PK = ''''S95'''')'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CDF_LI_CODE_FK = ''''3''''
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
        AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
        AND CDF14.CDF_NUMERO_PK = ''''14''''
        AND CDF14.CDF_CODE_PK = ''''S95''''
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CDF_LI_CODE_FK = ''''3''''
          UNION
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, SPCPD_SPE_CDT_PRESCR SPCPD, CDF_CODIF CDF14
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CODE_SQ_PK = SPCPD.SPCPD_SP_CODE_FK_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = CDF14.CDF_CODE_PK
          AND CDF14.CDF_NUMERO_PK = ''''14''''
          AND CDF14.CDF_CODE_PK = ''''S95'''')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API PRODUIT DOPANT
-- EXEMPLE: LISTID := '7990,11278,7335,4289,5925' ET TYPID := 1

-- DROP FUNCTION GET_THE_PRODUIT_DOP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PRODUIT_DOP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS PRODUIT_DOPANT
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
        JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON (AUTCOM.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
          AND AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17'''')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS PRODUIT_DOPANT
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP1.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP1
          JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK)
          JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
          JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
          JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON (AUTCOM.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
            AND AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS PRODUIT_DOPANT
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
        JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON (AUTCOM.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
          AND AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS PRODUIT_DOPANT
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP1.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP1
          JOIN FCPMSP_CIPEMG_SPE FCPMSP1 ON (FCPMSP1.FCPMSP_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK)
          JOIN FCPM_FICHECIPEMG FCPM1 ON (FCPM1.FCPM_CODE_SQ_PK = FCPMSP1.FCPMSP_FCPM_CODE_FK_PK)
          JOIN FCPMTER_FCPM_TERRAIN FCPMTER1 ON (FCPMTER1.FCPMTER_FCPM_CODE_FK_PK = FCPM1.FCPM_CODE_SQ_PK)
          JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM1 ON (AUTCOM1.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER1.FCPMTER_CDF_TER_CODE_FK_PK
            AND AUTCOM1.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17'''')
            AND SP1.SP_CODE_SQ_PK IN (''||LISTID||''))
        AND SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API PRODUIT DOPANT GSP
-- EXEMPLE: LISTID := '7990,11278,7335,4289,5925' ET TYPID := 1

-- DROP FUNCTION GET_THE_PRODUIT_DOP_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PRODUIT_DOP_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS PRODUIT_DOPANT
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
        JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON (AUTCOM.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
          AND AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17'''')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS PRODUIT_DOPANT
        FROM GSP_GENERIQUE_SPECIALITE GSP
        WHERE GSP.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP1.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP1
          JOIN SP_SPECIALITE SP1 ON (SP1.SP_GSP_CODE_FK = GSP1.GSP_CODE_SQ_PK
            AND GSP1.GSP_NB_SUB < 4)
          JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK)
          JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
          JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
          JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON (AUTCOM.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
            AND AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS PRODUIT_DOPANT
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
        JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON (AUTCOM.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
          AND AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS PRODUIT_DOPANT
        FROM GSP_GENERIQUE_SPECIALITE GSP
        WHERE GSP.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP1.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP1
          JOIN SP_SPECIALITE SP1 ON (SP1.SP_GSP_CODE_FK = GSP1.GSP_CODE_SQ_PK
            AND GSP1.GSP_NB_SUB < 4)
          JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK)
          JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
          JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
          JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON (AUTCOM.AUTCOM_CDF_TER_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
            AND AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK = ''''Z17'''')
          WHERE GSP1.GSP_CODE_SQ_PK IN (''||LISTID||''))
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API RESERVE HOSPITALIERE
-- EXEMPLE: LISTID := '7990,11278,7335,4289,5925' ET TYPID := 1

-- DROP FUNCTION GET_THE_RESERVE_HOSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_RESERVE_HOSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SP_INFOS.RESERVE_HOSPITALIERE AS RESERVE_HOSPITALIERE
        FROM SP_SPECIALITE SP
        JOIN SP_INFORMATIONS SP_INFOS ON SP_INFOS.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SP_INFOS.RESERVE_HOSPITALIERE AS RESERVE_HOSPITALIERE
        FROM SP_SPECIALITE SP
        JOIN SP_INFORMATIONS SP_INFOS ON SP_INFOS.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API RESERVE HOSPITALIERE GSP
-- EXEMPLE: LISTID := '7990,11278,7335,4289,5925' ET TYPID := 1

-- DROP FUNCTION GET_THE_RESERVE_HOSP_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_RESERVE_HOSP_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT
          GSP.GSP_CODE_SQ_PK,
          GSP.GSP_NOM,
          CASE WHEN EXISTS(SELECT 1
                           FROM SP_SPECIALITE SPE
                             JOIN SP_INFORMATIONS INFOS ON INFOS.SP_CODE_SQ_PK = SPE.SP_CODE_SQ_PK
                           WHERE SPE.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
                           AND INFOS.RESERVE_HOSPITALIERE = ''''NON'''') THEN ''''NON''''
          ELSE ''''OUI'''' END AS RESERVE_HOSPITALIERE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP
        ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
        AND SP_NOM NOT LIKE ''''%NSFP''''
        AND SP_NOM NOT LIKE ''''%NC''''
        AND GSP.GSP_NB_SUB < 4)
        GROUP BY GSP.GSP_CODE_SQ_PK, GSP.GSP_NOM
        ORDER BY GSP.GSP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT
          GSP.GSP_CODE_SQ_PK,
          GSP.GSP_NOM,
          CASE WHEN EXISTS(SELECT 1
                           FROM SP_SPECIALITE SPE
                             JOIN SP_INFORMATIONS INFOS ON INFOS.SP_CODE_SQ_PK = SPE.SP_CODE_SQ_PK
                           WHERE SPE.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
                           AND INFOS.RESERVE_HOSPITALIERE = ''''NON'''') THEN ''''NON''''
          ELSE ''''OUI'''' END AS RESERVE_HOSPITALIERE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP
        ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
        AND SP_NOM NOT LIKE ''''%NSFP''''
        AND SP_NOM NOT LIKE ''''%NC''''
        AND GSP.GSP_NB_SUB < 4)
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        GROUP BY GSP.GSP_CODE_SQ_PK, GSP.GSP_NOM
        ORDER BY GSP.GSP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API STATUT DE PRESCRIPTION RESTREINTE SPECIALITE
-- EXEMPLE: LISTID := '7690,7335,4289,28001,5925,7849' ET TYPID := 1

-- DROP FUNCTION GET_THE_PRESCR_REST(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PRESCR_REST (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS PRESCRIPTION_RESTREINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 24, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''14'''')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS PRESCRIPTION_RESTREINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP1.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP1
          JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
            AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''14''''))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS PRESCRIPTION_RESTREINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 24, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''14'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS PRESCRIPTION_RESTREINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP1.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP1
          JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
            AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''14'''')
          WHERE SP1.SP_CODE_SQ_PK IN (''||LISTID||''))
        AND SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API STATUT DE PRESCRIPTION RESTREINTE MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '17,68,1011' ET TYPID := 1

-- DROP FUNCTION GET_THE_PRESCR_REST_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PRESCR_REST_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_GSP_CODE_FK AS CODE_GSP, GSP_SPE.GSP_NOM AS GSP_NOM, ''''O'''' AS PRESCRIPTION_RESTREINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 24, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
        JOIN GSP_GENERIQUE GSP ON (GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
          AND GSP_SPE.GSP_NB_SUB < 4)
        JOIN SP_SPECIALITE SP ON SP.SP_GSP_CODE_FK = GSP.GSP_GSP_CODE_FK
        JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''14'''')
        UNION
        SELECT SP.SP_GSP_CODE_FK AS CODE_GSP, GSP_SPE.GSP_NOM AS GSP_NOM, ''''N'''' AS PRESCRIPTION_RESTREINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
        JOIN GSP_GENERIQUE GSP ON (GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
          AND GSP_SPE.GSP_NB_SUB < 4)
        JOIN SP_SPECIALITE SP ON SP.SP_GSP_CODE_FK = GSP.GSP_GSP_CODE_FK
        WHERE SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP1.SP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
          JOIN GSP_GENERIQUE GSP ON (GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
            AND GSP_SPE.GSP_NB_SUB < 4)
          JOIN SP_SPECIALITE SP1 ON SP1.SP_GSP_CODE_FK = GSP.GSP_GSP_CODE_FK
          JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
            AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''14''''))
        ORDER BY CODE_GSP'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_GSP_CODE_FK AS CODE_GSP, GSP_SPE.GSP_NOM AS GSP_NOM, ''''O'''' AS PRESCRIPTION_RESTREINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 24, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
        JOIN GSP_GENERIQUE GSP ON (GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
          AND GSP_SPE.GSP_NB_SUB < 4)
        JOIN SP_SPECIALITE SP ON SP.SP_GSP_CODE_FK = GSP.GSP_GSP_CODE_FK
        JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''14'''')
        WHERE SP.SP_GSP_CODE_FK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_GSP_CODE_FK AS CODE_GSP, GSP_SPE.GSP_NOM AS GSP_NOM, ''''N'''' AS PRESCRIPTION_RESTREINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
        JOIN GSP_GENERIQUE GSP ON (GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
          AND GSP_SPE.GSP_NB_SUB < 4)
        JOIN SP_SPECIALITE SP ON SP.SP_GSP_CODE_FK = GSP.GSP_GSP_CODE_FK
        WHERE SP.SP_GSP_CODE_FK NOT IN (
          SELECT SP1.SP_GSP_CODE_FK
          FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
          JOIN GSP_GENERIQUE GSP ON (GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
            AND GSP_SPE.GSP_NB_SUB < 4)
          JOIN SP_SPECIALITE SP1 ON SP1.SP_GSP_CODE_FK = GSP.GSP_GSP_CODE_FK
          JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
            AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK IN (''''S24'''',''''S46'''',''''S47'''',''''S50'''',''''S96''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPCPD.SPCPD_CDF_STP_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''14'''')
          WHERE SP1.SP_GSP_CODE_FK IN (''||LISTID||''))
        AND SP.SP_GSP_CODE_FK IN (''||LISTID||'')
        ORDER BY CODE_GSP'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API STATUT DE DELIVRANCE RESTREINTE
-- EXEMPLE: LISTID := '7690,7335,4289,28001,5925,7849' ET TYPID := 1

-- DROP FUNCTION GET_THE_DELIVR_REST(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_DELIVR_REST (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT PRE.PRE_CODE_PK AS CODE_PRESENTATION, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS DELIVRANCE_RESTEINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 28, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
          AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''29'''')
        UNION
        SELECT PRE.PRE_CODE_PK AS CODE_PRESENTATION, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS DELIVRANCE_RESTEINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        AND SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
          JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
            AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''29''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT PRE.PRE_CODE_PK AS CODE_PRESENTATION, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS DELIVRANCE_RESTEINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 28, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
          AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''29'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT PRE.PRE_CODE_PK AS CODE_PRESENTATION, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS DELIVRANCE_RESTEINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP1.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP1
          JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP1.SP_CODE_SQ_PK
          JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
            AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''29'''')
          WHERE SP1.SP_CODE_SQ_PK IN (''||LISTID||''))'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API STATUT DE DELIVRANCE RESTREINTE GSP
-- EXEMPLE: LISTID := '7690,7335,4289,28001,5925,7849' ET TYPID := 1

-- DROP FUNCTION GET_THE_DELIVR_REST_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_DELIVR_REST_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS DELIVRANCE_RESTEINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 28, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
          AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''29'''')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS DELIVRANCE_RESTEINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        WHERE GSP.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP1.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP1
          JOIN SP_SPECIALITE SP ON(SP.SP_GSP_CODE_FK = GSP1.GSP_CODE_SQ_PK
            AND GSP1.GSP_NB_SUB < 4)
          JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
          JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
            AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''29''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS DELIVRANCE_RESTEINTE, CDF_NOM AS DUREE, REPLACE(SUBSTRING(CDF.CDF_NOM, 26, 2), '''' '''', '''''''') AS TEMPS, REPLACE(SUBSTRING(CDF.CDF_NOM, 28, 9), '''' '''', '''''''') AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
          AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''29'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS DELIVRANCE_RESTEINTE, '''''''' AS DUREE, '''''''' AS TEMPS, '''''''' AS UNITE_TEMPS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        WHERE GSP.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP1.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP1
          JOIN SP_SPECIALITE SP ON(SP.SP_GSP_CODE_FK = GSP1.GSP_CODE_SQ_PK
            AND GSP1.GSP_NB_SUB < 4)
          JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
          JOIN PREDICO_COMMENT_DISPENSAT PREDICO ON (PREDICO.PREDICO_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
            AND PREDICO.PREDICO_CDF_COM_CODE_FK_PK IN (''''4'''',''''5'''',''''8''''))
          JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
            AND CDF.CDF_NUMERO_PK = ''''29'''')
          WHERE GSP1.GSP_CODE_SQ_PK IN (''||LISTID||''))
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API STATUT GENERIQUE OU REFERENT
-- EXEMPLE: LISTID := '3737,16815,22613,4289,7286,156,15305' ET TYPID := 1

-- DROP FUNCTION GET_THE_GEN_REF(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_GEN_REF (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SP.SP_TYPE_SPE AS SP_TYPE_SPE, SP.SP_GSP_CODE_FK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE SP.SP_TYPE_SPE IS NOT NULL
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''E'''' AS SP_TYPE_SPE, SP.SP_GSP_CODE_FK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE SP.SP_TYPE_SPE <> ''''G''''
        AND SP.SP_GSP_CODE_FK = (
          SELECT SP2.SP_GSP_CODE_FK
          FROM SP_SPECIALITE SP2
          WHERE SP2.SP_GSP_CODE_FK = SP.SP_GSP_CODE_FK
          GROUP BY SP2.SP_GSP_CODE_FK
          HAVING COUNT(*) > 1)'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SP.SP_TYPE_SPE AS SP_TYPE_SPE, SP.SP_GSP_CODE_FK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP.SP_TYPE_SPE IS NOT NULL
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''E'''' AS SP_TYPE_SPE, SP.SP_GSP_CODE_FK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP.SP_TYPE_SPE <> ''''G''''
        AND SP.SP_GSP_CODE_FK = (
          SELECT SP2.SP_GSP_CODE_FK
          FROM SP_SPECIALITE SP2
          WHERE SP2.SP_GSP_CODE_FK = SP.SP_GSP_CODE_FK
          GROUP BY SP2.SP_GSP_CODE_FK
          HAVING COUNT(*) > 1)'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API STATUT T2A / RETROCESSION / PRODUIT ONEREUX
-- EXEMPLE: LISTID := '25398,15985,22093,14654' ET TYPID := 1    ||     LISTID := '9182190,8211,9161294,17341,17090' ET TYPID := 2;

-- DROP FUNCTION GET_THE_SPE_DSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SPE_DSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS RETROCESSION
        FROM SP_SPECIALITE SP, PRE_PRESENTATION PRE, PREDICO_COMMENT_DISPENSAT PREDICO, CDF_CODIF RETRO
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
        AND PRE.PRE_CODE_PK = PREDICO.PREDICO_PRE_CODE_FK_PK
        AND RETRO.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
        AND RETRO.CDF_NUMERO_PK = ''''29''''
        AND RETRO.CDF_CODE_PK = ''''3''''
        UNION
        SELECT SP2.SP_CIPUCD AS SP_CIPUCD, SP2.SP_CODE_SQ_PK, SP2.SP_NOM AS SP_NOM, ''''N'''' AS RETROCESSION
        FROM SP_SPECIALITE SP2
        WHERE SP2.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP2.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP, PRE_PRESENTATION PRE, PREDICO_COMMENT_DISPENSAT PREDICO, CDF_CODIF RETRO
          WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
          AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
          AND PRE.PRE_CODE_PK = PREDICO.PREDICO_PRE_CODE_FK_PK
          AND RETRO.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
          AND RETRO.CDF_NUMERO_PK = ''''29''''
          AND RETRO.CDF_CODE_PK = ''''3'''')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS PRODUIT_ONEREUX
        FROM SP_SPECIALITE SP, PRE_PRESENTATION PRE, PRESTR_STATUT_REMBOURST PRESTR, CDF_CODIF T2A
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
        AND PRE.PRE_CODE_PK = PRESTR.PRESTR_PRE_CODE_FK_PK
        AND T2A.CDF_CODE_PK = PRESTR.PRESTR_CDF_STR_CODE_FK_PK
        AND T2A.CDF_NUMERO_PK = ''''14''''
        AND (T2A.CDF_CODE_PK LIKE ''''R1'''' OR T2A.CDF_CODE_PK LIKE ''''R4'''')
        UNION
        SELECT SP2.SP_CIPUCD AS SP_CIPUCD, SP2.SP_CODE_SQ_PK, SP2.SP_NOM AS SP_NOM, ''''N'''' AS PRODUIT_ONEREUX
        FROM SP_SPECIALITE SP2
        WHERE SP2.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND SP2.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP, PRE_PRESENTATION PRE, PRESTR_STATUT_REMBOURST PRESTR, CDF_CODIF T2A
          WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
          AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
          AND PRE.PRE_CODE_PK = PRESTR.PRESTR_PRE_CODE_FK_PK
          AND T2A.CDF_CODE_PK = PRESTR.PRESTR_CDF_STR_CODE_FK_PK
          AND T2A.CDF_NUMERO_PK = ''''14''''
          AND (T2A.CDF_CODE_PK LIKE ''''R1'''' OR T2A.CDF_CODE_PK LIKE ''''R4''''))'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API STATUT T2A / RETROCESSION / PRODUIT ONEREUX GSP
-- EXEMPLE: LISTID := '25398,15985,22093,14654' ET TYPID := 1    ||     LISTID := '9182190,8211,9161294,17341,17090' ET TYPID := 2;

-- DROP FUNCTION GET_THE_GSP_DSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_GSP_DSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS RETROCESSION
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, PRE_PRESENTATION PRE, PREDICO_COMMENT_DISPENSAT PREDICO, CDF_CODIF RETRO
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
        AND PRE.PRE_CODE_PK = PREDICO.PREDICO_PRE_CODE_FK_PK
        AND RETRO.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
        AND RETRO.CDF_NUMERO_PK = ''''29''''
        AND RETRO.CDF_CODE_PK = ''''3''''
        UNION
        SELECT GSP2.GSP_CODE_SQ_PK AS GSP_CODE, GSP2.GSP_NOM AS GSP_NOM, ''''N'''' AS RETROCESSION
        FROM GSP_GENERIQUE_SPECIALITE GSP2
        WHERE GSP2.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP2.GSP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, PRE_PRESENTATION PRE, PREDICO_COMMENT_DISPENSAT PREDICO, CDF_CODIF RETRO
          WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
          AND GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
          AND PRE.PRE_CODE_PK = PREDICO.PREDICO_PRE_CODE_FK_PK
          AND RETRO.CDF_CODE_PK = PREDICO.PREDICO_CDF_COM_CODE_FK_PK
          AND RETRO.CDF_NUMERO_PK = ''''29''''
          AND RETRO.CDF_CODE_PK = ''''3'''')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS PRODUIT_ONEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, PRE_PRESENTATION PRE, PRESTR_STATUT_REMBOURST PRESTR, CDF_CODIF T2A
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
        AND PRE.PRE_CODE_PK = PRESTR.PRESTR_PRE_CODE_FK_PK
        AND T2A.CDF_CODE_PK = PRESTR.PRESTR_CDF_STR_CODE_FK_PK
        AND T2A.CDF_NUMERO_PK = ''''14''''
        AND (T2A.CDF_CODE_PK LIKE ''''R1'''' OR T2A.CDF_CODE_PK LIKE ''''R4'''')
        UNION
        SELECT GSP2.GSP_CODE_SQ_PK AS GSP_CODE, GSP2.GSP_NOM AS GSP_NOM, ''''N'''' AS PRODUIT_ONEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSP2
        WHERE GSP2.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP2.GSP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP, PRE_PRESENTATION PRE, PRESTR_STATUT_REMBOURST PRESTR, CDF_CODIF T2A
          WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
          AND GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK
          AND PRE.PRE_CODE_PK = PRESTR.PRESTR_PRE_CODE_FK_PK
          AND T2A.CDF_CODE_PK = PRESTR.PRESTR_CDF_STR_CODE_FK_PK
          AND T2A.CDF_NUMERO_PK = ''''14''''
          AND (T2A.CDF_CODE_PK LIKE ''''R1'''' OR T2A.CDF_CODE_PK LIKE ''''R4''''))'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API PRIX
-- EXEMPLE: LISTID := '3737,22613,4289,7286,156,15985,22093' ET TYPID := 1

-- DROP FUNCTION GET_THE_PRIX(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PRIX (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT PRE.PRE_CODE_PK AS PRE_CODE_PK,
		  SP.SP_CIPUCD AS SP_CIPUCD,
		  SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK,
		  PRIPRE.PRIPRE_PRIX_EURO AS PRIX_PRESENTATION,
		  CASE WHEN PRE.PRE_NATUCD_CONTENU > 0 THEN ROUND(CAST(PRIPRE.PRIPRE_PRIX_EURO / PRE.PRE_NATUCD_CONTENU AS NUMERIC), 2) ELSE 0 END AS PRIX_UCD,
		  TAUX_REMB.CDF_NOM AS TAUX_REMBOURSEMENT
		FROM SP_SPECIALITE SP
		LEFT JOIN PRIUCD_PRIX_UCD PRIUCD ON (PRIUCD.PRIUCD_UCD_CODE_PK = SP.SP_CIPUCD)
		LEFT JOIN PRE_PRESENTATION PRE ON (SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK)
		JOIN PRETSS_PRESENTATION_TAUX PRETSS ON (PRETSS.PRETSS_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
		  AND PRETSS.PRETSS_DATE_APPLIQUEE = (
		  SELECT MAX(PRETSS2.PRETSS_DATE_APPLIQUEE)
		  FROM PRE_PRESENTATION PRE2
		  JOIN PRETSS_PRESENTATION_TAUX PRETSS2 ON PRETSS2.PRETSS_PRE_CODE_FK_PK = PRE2.PRE_CODE_PK
		  LEFT JOIN CDF_CODIF TAUX_REMB2 ON (TAUX_REMB2.CDF_CODE_PK = PRETSS2.PRETSS_CDF_TSS_CODE_FK_PK
		    AND TAUX_REMB2.CDF_NUMERO_PK = ''''17'''')
		  WHERE PRE2.PRE_CODE_PK = PRE.PRE_CODE_PK))
		LEFT JOIN CDF_CODIF TAUX_REMB ON (TAUX_REMB.CDF_CODE_PK = PRETSS.PRETSS_CDF_TSS_CODE_FK_PK
		  AND TAUX_REMB.CDF_NUMERO_PK = ''''17'''')
		LEFT JOIN PRIPRE_PRIX_PRESENTATION PRIPRE ON (PRE.PRE_CODE_PK = PRIPRE.PRIPRE_PRE_CODE_FK_PK AND PRE.PRE_ETAT_COMMER = ''''D'''')
		ORDER BY 3'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT PRE.PRE_CODE_PK AS PRE_CODE_PK,
		  SP.SP_CIPUCD AS SP_CIPUCD,
		  SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK,
		  PRIPRE.PRIPRE_PRIX_EURO AS PRIX_PRESENTATION,
		  CASE WHEN PRE.PRE_NATUCD_CONTENU > 0 THEN ROUND(CAST(PRIPRE.PRIPRE_PRIX_EURO / PRE.PRE_NATUCD_CONTENU AS NUMERIC), 2) ELSE 0 END AS PRIX_UCD,
		  TAUX_REMB.CDF_NOM AS TAUX_REMBOURSEMENT
		FROM SP_SPECIALITE SP
		LEFT JOIN PRIUCD_PRIX_UCD PRIUCD ON (PRIUCD.PRIUCD_UCD_CODE_PK = SP.SP_CIPUCD)
		LEFT JOIN PRE_PRESENTATION PRE ON (SP.SP_CODE_SQ_PK = PRE.PRE_SP_CODE_FK)
		JOIN PRETSS_PRESENTATION_TAUX PRETSS ON (PRETSS.PRETSS_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
		  AND PRETSS.PRETSS_DATE_APPLIQUEE = (
		  SELECT MAX(PRETSS2.PRETSS_DATE_APPLIQUEE)
		  FROM PRE_PRESENTATION PRE2
		  JOIN PRETSS_PRESENTATION_TAUX PRETSS2 ON PRETSS2.PRETSS_PRE_CODE_FK_PK = PRE2.PRE_CODE_PK
		  LEFT JOIN CDF_CODIF TAUX_REMB2 ON (TAUX_REMB2.CDF_CODE_PK = PRETSS2.PRETSS_CDF_TSS_CODE_FK_PK
		    AND TAUX_REMB2.CDF_NUMERO_PK = ''''17'''')
		  WHERE PRE2.PRE_CODE_PK = PRE.PRE_CODE_PK))
		LEFT JOIN CDF_CODIF TAUX_REMB ON (TAUX_REMB.CDF_CODE_PK = PRETSS.PRETSS_CDF_TSS_CODE_FK_PK
		  AND TAUX_REMB.CDF_NUMERO_PK = ''''17'''')
		LEFT JOIN PRIPRE_PRIX_PRESENTATION PRIPRE ON (PRE.PRE_CODE_PK = PRIPRE.PRIPRE_PRE_CODE_FK_PK AND PRE.PRE_ETAT_COMMER = ''''D'''')
WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
ORDER BY 3'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API STATUT ATU
-- EXEMPLE: LISTID := '2922,5457,7087,154' ET TYPID := 1

-- DROP FUNCTION GET_THE_ATU(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_ATU (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS STATUT_ATU
        FROM SP_SPECIALITE SP
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK = ''''6'''')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS STATUT_ATU
        FROM SP_SPECIALITE SP
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK != ''''6'''')
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS STATUT_ATU
        FROM SP_SPECIALITE SP
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK = ''''6'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS STATUT_ATU
        FROM SP_SPECIALITE SP
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK != ''''6'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API STATUT ATU GSP
-- EXEMPLE: LISTID := '2922,5457,7087,154' ET TYPID := 1

-- DROP FUNCTION GET_THE_ATU_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_ATU_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS STATUT_ATU
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK = ''''6'''')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS STATUT_ATU
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK != ''''6'''')
        ORDER BY GSP_CODE'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS STATUT_ATU
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK = ''''6'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS STATUT_ATU
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SP.SP_CDF_SLAB_CODE_FK
          AND CDF.CDF_NUMERO_PK = ''''15''''
          AND CDF.CDF_CODE_PK != ''''6'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API VIGILANCE CONDUCTEUR
-- EXEMPLE: LISTID := '7690,4289,31544,7335,5925,7286' ET TYPID := 1

-- DROP FUNCTION GET_THE_VIGI_CONDUCT(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_VIGI_CONDUCT (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF_NOM AS ALERTE
        FROM FCOSP_CONDUCTEUR_SPEC
        JOIN SP_SPECIALITE SP ON (SP.SP_CODE_SQ_PK = FCOSP_SP_CODE_FK_PK)
        JOIN FCOREC_FCO_REC ON (FCOREC_FCO_CODE_FK_PK = FCOSP_FCO_CODE_FK_PK)
        JOIN CDF_CODIF ON (CDF_CODE_PK = FCOREC_CDF_REC_CODE_FK_PK
          AND CDF_NUMERO_PK = ''''CC''''
          AND CDF_CODE_PK IN (''''X28'''',''''X29'''',''''X30'''',''''X31'''',''''X32''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF_NOM AS ALERTE
        FROM FCOSP_CONDUCTEUR_SPEC
        JOIN SP_SPECIALITE SP ON (SP.SP_CODE_SQ_PK = FCOSP_SP_CODE_FK_PK)
        JOIN FCOREC_FCO_REC ON (FCOREC_FCO_CODE_FK_PK = FCOSP_FCO_CODE_FK_PK)
        JOIN CDF_CODIF ON (CDF_CODE_PK = FCOREC_CDF_REC_CODE_FK_PK
          AND CDF_NUMERO_PK = ''''CC''''
          AND CDF_CODE_PK IN (''''X28'''',''''X29'''',''''X30'''',''''X31'''',''''X32''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API VIGILANCE CONDUCTEUR GSP
-- EXEMPLE: LISTID := '7690,4289,31544,7335,5925,7286' ET TYPID := 1

-- DROP FUNCTION GET_THE_VIGI_CONDUCT_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_VIGI_CONDUCT_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CDF_NOM AS ALERTE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCOSP_CONDUCTEUR_SPEC ON (FCOSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCOREC_FCO_REC ON (FCOREC_FCO_CODE_FK_PK = FCOSP_FCO_CODE_FK_PK)
        JOIN CDF_CODIF ON (CDF_CODE_PK = FCOREC_CDF_REC_CODE_FK_PK
          AND CDF_NUMERO_PK = ''''CC''''
          AND CDF_CODE_PK IN (''''X28'''',''''X29'''',''''X30'''',''''X31'''',''''X32''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CDF_NOM AS ALERTE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCOSP_CONDUCTEUR_SPEC ON (FCOSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCOREC_FCO_REC ON (FCOREC_FCO_CODE_FK_PK = FCOSP_FCO_CODE_FK_PK)
        JOIN CDF_CODIF ON (CDF_CODE_PK = FCOREC_CDF_REC_CODE_FK_PK
          AND CDF_NUMERO_PK = ''''CC''''
          AND CDF_CODE_PK IN (''''X28'''',''''X29'''',''''X30'''',''''X31'''',''''X32''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API ATC ET DDD
-- EXEMPLE: LISTID := '4289,28001,5925,26236,3671,8932,8141,22169,12368,14838' ET TYPID := 1

-- DROP FUNCTION GET_THE_ATC_DDD_V2(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_ATC_DDD_V2 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CATC.CATC_CODE_PK AS CATC_CODE, CATC.CATC_CATC_CODE_FK AS CATC_CATC_CODE, CDFVO.CDF_NOM AS VOIE, SPDDD.SPDDD_ATCDDD_DOSAGE_PK AS DOSAGE, CDFUD.CDF_NOM AS UNITE_DOSE
        FROM SP_SPECIALITE SP
        JOIN CATC_CLASSEATC CATC ON CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
        JOIN SPVO_SPECIALITE_VOIE SPVO ON (SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN CDF_CODIF CDFVO ON (CDFVO.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDFVO.CDF_NUMERO_PK = ''''18'''')
        LEFT JOIN SPDDD_DOSE_USUELLE_JOUR SPDDD ON (SPDDD.SPDDD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPDDD.SPDDD_ATCDDD_CDF_VO_CODE_FK_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK)
        LEFT JOIN CDF_CODIF CDFUD ON (CDFUD.CDF_CODE_PK = SPDDD.SPDDD_ATCDDD_CDF_UD_CODE_FK_PK
          AND CDFUD.CDF_NUMERO_PK = ''''19'''')
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CATC.CATC_CODE_PK AS CATC_CODE, CATC.CATC_CATC_CODE_FK AS CATC_CATC_CODE, CDFVO.CDF_NOM AS VOIE, SPDDD.SPDDD_ATCDDD_DOSAGE_PK AS DOSAGE, CDFUD.CDF_NOM AS UNITE_DOSE
        FROM SP_SPECIALITE SP
        JOIN CATC_CLASSEATC CATC ON CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
        JOIN SPVO_SPECIALITE_VOIE SPVO ON (SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN CDF_CODIF CDFVO ON (CDFVO.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDFVO.CDF_NUMERO_PK = ''''18'''')
        LEFT JOIN SPDDD_DOSE_USUELLE_JOUR SPDDD ON (SPDDD.SPDDD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPDDD.SPDDD_ATCDDD_CDF_VO_CODE_FK_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK)
        LEFT JOIN CDF_CODIF CDFUD ON (CDFUD.CDF_CODE_PK = SPDDD.SPDDD_ATCDDD_CDF_UD_CODE_FK_PK
          AND CDFUD.CDF_NUMERO_PK = ''''19'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API ATC ET DDD GSP
-- EXEMPLE: LISTID := '4289,28001,5925,26236,3671,8932,8141,22169,12368,14838' ET TYPID := 1

-- DROP FUNCTION GET_THE_ATC_DDD_GSP_V2(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_ATC_DDD_GSP_V2 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CATC.CATC_CODE_PK AS CATC_CODE, CATC.CATC_CATC_CODE_FK AS CATC_CATC_CODE, CDFVO.CDF_NOM AS VOIE, SPDDD.SPDDD_ATCDDD_DOSAGE_PK AS DOSAGE, CDFUD.CDF_NOM AS UNITE_DOSE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CATC_CLASSEATC CATC ON CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
        JOIN SPVO_SPECIALITE_VOIE SPVO ON (SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN CDF_CODIF CDFVO ON (CDFVO.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDFVO.CDF_NUMERO_PK = ''''18'''')
        LEFT JOIN SPDDD_DOSE_USUELLE_JOUR SPDDD ON (SPDDD.SPDDD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPDDD.SPDDD_ATCDDD_CDF_VO_CODE_FK_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK)
        LEFT JOIN CDF_CODIF CDFUD ON (CDFUD.CDF_CODE_PK = SPDDD.SPDDD_ATCDDD_CDF_UD_CODE_FK_PK
          AND CDFUD.CDF_NUMERO_PK = ''''19'''')
        ORDER BY GSP.GSP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CATC.CATC_CODE_PK AS CATC_CODE, CATC.CATC_CATC_CODE_FK AS CATC_CATC_CODE, CDFVO.CDF_NOM AS VOIE, SPDDD.SPDDD_ATCDDD_DOSAGE_PK AS DOSAGE, CDFUD.CDF_NOM AS UNITE_DOSE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CATC_CLASSEATC CATC ON CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
        JOIN SPVO_SPECIALITE_VOIE SPVO ON (SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN CDF_CODIF CDFVO ON (CDFVO.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDFVO.CDF_NUMERO_PK = ''''18'''')
        LEFT JOIN SPDDD_DOSE_USUELLE_JOUR SPDDD ON (SPDDD.SPDDD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPDDD.SPDDD_ATCDDD_CDF_VO_CODE_FK_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK)
        LEFT JOIN CDF_CODIF CDFUD ON (CDFUD.CDF_CODE_PK = SPDDD.SPDDD_ATCDDD_CDF_UD_CODE_FK_PK
          AND CDFUD.CDF_NUMERO_PK = ''''19'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY GSP.GSP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API SOLUTES
-- EXEMPLE: LISTID := '43,51,3054' ET TYPID := 1

-- DROP FUNCTION GET_THE_SOLUTE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SOLUTE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CATC.CATC_CODE_PK, ''''O'''' AS SOLUTE
        FROM SP_SPECIALITE SP
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CATC.CATC_CODE_PK, ''''N'''' AS SOLUTE
        FROM SP_SPECIALITE SP
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK NOT IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CATC.CATC_CODE_PK, ''''O'''' AS SOLUTE
        FROM SP_SPECIALITE SP
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CATC.CATC_CODE_PK, ''''N'''' AS SOLUTE
        FROM SP_SPECIALITE SP
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK NOT IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API SOLUTES GSP
-- EXEMPLE: LISTID := '43,51,3054' ET TYPID := 1

-- DROP FUNCTION GET_THE_SOLUTE_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SOLUTE_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CATC.CATC_CODE_PK, ''''O'''' AS SOLUTE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))
        UNION
        SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CATC.CATC_CODE_PK, ''''N'''' AS SOLUTE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK NOT IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CATC.CATC_CODE_PK, ''''O'''' AS SOLUTE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CATC.CATC_CODE_PK, ''''N'''' AS SOLUTE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN CATC_CLASSEATC CATC ON (CATC.CATC_CODE_PK = SP.SP_CATC_CODE_FK
          AND CATC.CATC_CODE_PK NOT IN (''''B05BA'''',''''B05BB'''',''''B05BC'''',''''B05CB'''',''''B05CX'''',''''B05XA'''',''''B05XB'''',''''B05XC'''',''''B05XX'''',''''B05ZA'''',''''B05ZB'''',''''B05DA'''',''''B05DB'''', ''''B05CB'''' , ''''B05CX'''', ''''B05BB'''', ''''B05XA''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '26236,12368,7130,27770,14838,8932,8141' ET TYPID := 1   OU   := '2100,3456' ET TYPID := 2

-- DROP FUNCTION GET_THE_VIRTUEL(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_VIRTUEL (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 3 THEN 
    OPEN CURRET FOR EXECUTE ''
        SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, PRE.PRE_DATECOMMER AS DATECOMMER
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        WHERE SP_TYPE_SPE = ''''R''''
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND PRE.PRE_DATECOMMER = (
          SELECT MAX(PRE_DATECOMMER)
          FROM GSP_GENERIQUE_SPECIALITE, SP_SPECIALITE, PRE_PRESENTATION
          WHERE GSP_CODE_SQ_PK = GSP.GSP_CODE_SQ_PK
          AND SP_GSP_CODE_FK = GSP_CODE_SQ_PK
          AND PRE_SP_CODE_FK = SP_CODE_SQ_PK
          AND SP_TYPE_SPE = ''''R''''
          AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        )
        UNION
        SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, PRE.PRE_DATECOMMER
        FROM SP_SPECIALITE SP
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE, SP_SPECIALITE
          WHERE GSP_CODE_SQ_PK = SP_GSP_CODE_FK
          AND SP_TYPE_SPE = ''''R''''
          AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        )
        AND PRE.PRE_DATECOMMER = (
          SELECT MAX(PRE_DATECOMMER)
          FROM GSP_GENERIQUE_SPECIALITE, SP_SPECIALITE, PRE_PRESENTATION
          WHERE GSP_CODE_SQ_PK = GSP.GSP_CODE_SQ_PK
          AND SP_GSP_CODE_FK = GSP_CODE_SQ_PK
          AND PRE_SP_CODE_FK = SP_CODE_SQ_PK
          AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        )
        ORDER BY 1
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API FORME PHARMACEUTIQUE SP
-- EXEMPLE: LISTID := '26236,12368,7130,8238,34245,13563,8141,17204,6849,2715' ET TYPID := 1

-- DROP FUNCTION GET_THE_FORME_SPE_V2(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_FORME_SPE_V2 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, 
          CDF_FORME.CDF_CODE_PK AS CODE_FORME, CDF_FORME.CDF_NOM AS FORME,
          CDF_CFORME.CDF_CODE_PK AS CODE_COMPLEMENT, CDF_CFORME.CDF_NOM AS COMPLEMENT_FORME,
          CDF_VOIE.CDF_CODE_PK AS CODE_VOIE, CDF_VOIE.CDF_NOM AS VOIE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''62''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''30''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''4''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''28''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''29''''
            ELSE ''''''''
          END AS CODE_VOIE_PRINCIPALE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''INJECTABLE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''ORALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''CUTANEE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''NASALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''OPHTALMIQUE''''
            ELSE ''''''''
          END AS NOM_VOIE_PRINCIPALE
        FROM SP_SPECIALITE SP
        LEFT JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CDF_CODIF CDF_FORME ON (CDF_FORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_FO_CODE_FK_PK
          AND CDF_FORME.CDF_NUMERO_PK = ''''06'''')
        LEFT JOIN CDF_CODIF CDF_CFORME ON (CDF_CFORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF_CFORME.CDF_NUMERO_PK = ''''02'''')
        LEFT JOIN SPVO_SPECIALITE_VOIE SPVO ON SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CDF_CODIF CDF_VOIE ON (CDF_VOIE.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDF_VOIE.CDF_NUMERO_PK = (''''18''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, 
          CDF_FORME.CDF_CODE_PK AS CODE_FORME, CDF_FORME.CDF_NOM AS FORME,
          CDF_CFORME.CDF_CODE_PK AS CODE_COMPLEMENT, CDF_CFORME.CDF_NOM AS COMPLEMENT_FORME,
          CDF_VOIE.CDF_CODE_PK AS CODE_VOIE, CDF_VOIE.CDF_NOM AS VOIE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''62''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''30''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''4''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''28''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''29''''
            ELSE ''''''''
          END AS CODE_VOIE_PRINCIPALE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''INJECTABLE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''ORALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''CUTANEE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''NASALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''OPHTALMIQUE''''
            ELSE ''''''''
          END AS NOM_VOIE_PRINCIPALE
        FROM SP_SPECIALITE SP
        LEFT JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CDF_CODIF CDF_FORME ON (CDF_FORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_FO_CODE_FK_PK
          AND CDF_FORME.CDF_NUMERO_PK = ''''06'''')
        LEFT JOIN CDF_CODIF CDF_CFORME ON (CDF_CFORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF_CFORME.CDF_NUMERO_PK = ''''02'''')
        LEFT JOIN SPVO_SPECIALITE_VOIE SPVO ON SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CDF_CODIF CDF_VOIE ON (CDF_VOIE.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDF_VOIE.CDF_NUMERO_PK = (''''18''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API FORME PHARMACEUTIQUE GSP
-- EXEMPLE: LISTID := '57,2415,3657' ET TYPID := 1

-- DROP FUNCTION GET_THE_FORME_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_FORME_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, 
          CDF_FORME.CDF_CODE_PK AS CODE_FORME, CDF_FORME.CDF_NOM AS FORME,
          CDF_CFORME.CDF_CODE_PK AS CODE_COMPLEMENT, CDF_CFORME.CDF_NOM AS COMPLEMENT_FORME,
          CDF_VOIE.CDF_CODE_PK AS CODE_VOIE, CDF_VOIE.CDF_NOM AS VOIE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''62''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''30''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''4''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''28''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''29''''
            ELSE ''''''''
          END AS CODE_VOIE_PRINCIPALE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''INJECTABLE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''ORALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''CUTANEE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''NASALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''OPHTALMIQUE''''
            ELSE ''''''''
          END AS NOM_VOIE_PRINCIPALE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN CDF_CODIF CDF_FORME ON (CDF_FORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_FO_CODE_FK_PK
          AND CDF_FORME.CDF_NUMERO_PK = ''''06'''')
        JOIN CDF_CODIF CDF_CFORME ON (CDF_CFORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF_CFORME.CDF_NUMERO_PK = ''''02'''')
        JOIN SPVO_SPECIALITE_VOIE SPVO ON SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN CDF_CODIF CDF_VOIE ON (CDF_VOIE.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDF_VOIE.CDF_NUMERO_PK = (''''18''''))'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, 
          CDF_FORME.CDF_CODE_PK AS CODE_FORME, CDF_FORME.CDF_NOM AS FORME,
          CDF_CFORME.CDF_CODE_PK AS CODE_COMPLEMENT, CDF_CFORME.CDF_NOM AS COMPLEMENT_FORME,
          CDF_VOIE.CDF_CODE_PK AS CODE_VOIE, CDF_VOIE.CDF_NOM AS VOIE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''62''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''30''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''4''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''28''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''29''''
            ELSE ''''''''
          END AS CODE_VOIE_PRINCIPALE,
          CASE
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''47'''',''''50'''',''''89'''',''''8'''',''''9'''',''''90'''',''''81'''',''''11'''',''''7'''',''''97'''',''''57'''',''''72'''',''''53'''',''''14'''',''''48'''',''''80'''',''''98'''',''''82'''',''''15'''',''''17'''',''''32'''',''''64'''',''''91'''',''''20'''',''''92'''',''''23'''',''''93'''',''''94'''',''''24'''',''''25'''',''''26'''',''''67'''',''''27'''',''''70'''',''''86'''',''''54'''',''''19'''',''''52'''',''''66'''',''''60'''',''''45'''',''''37'''',''''68'''') THEN ''''INJECTABLE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''3'''',''''5'''',''''31'''',''''95'''',''''96'''',''''38'''') THEN ''''ORALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''63'''',''''39'''') THEN ''''CUTANEE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''1'''',''''6'''') THEN ''''NASALE''''
            WHEN CDF_VOIE.CDF_CODE_PK IN (''''45'''',''''69'''') THEN ''''OPHTALMIQUE''''
            ELSE ''''''''
          END AS NOM_VOIE_PRINCIPALE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN CDF_CODIF CDF_FORME ON (CDF_FORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_FO_CODE_FK_PK
          AND CDF_FORME.CDF_NUMERO_PK = ''''06'''')
        JOIN CDF_CODIF CDF_CFORME ON (CDF_CFORME.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF_CFORME.CDF_NUMERO_PK = ''''02'''')
        JOIN SPVO_SPECIALITE_VOIE SPVO ON SPVO.SPVO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN CDF_CODIF CDF_VOIE ON (CDF_VOIE.CDF_CODE_PK = SPVO.SPVO_CDF_VO_CODE_FK_PK
          AND CDF_VOIE.CDF_NUMERO_PK = (''''18''''))
        WHERE SP.SP_GSP_CODE_FK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API COMPOSITION DETAILLEE SPECIALITE
-- EXEMPLE: LISTID := '26236,7130,8238,34245,13563,6849,2715'

-- DROP FUNCTION GET_THE_COMPO_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_COMPO_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM,
        GSAC.GSAC_CODE_SQ_PK AS SAC_CODE, GSAC.GSAC_NOM AS SAC_NOM, COSAC.COSAC_DOSAGE AS DOSAGE, COSAC.COSAC_UNITEDOSAGE AS UNITE_DOSAGE
        FROM SP_SPECIALITE SP
        LEFT JOIN COSAC_COMPO_SUBACT COSAC ON (COSAC.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        LEFT JOIN SAC_SUBACTIVE SAC ON (SAC.SAC_CODE_SQ_PK = COSAC.COSAC_SAC_CODE_FK_PK)
        LEFT JOIN GSAC_PERE_SUBACT GSAC ON GSAC.GSAC_CODE_SQ_PK = SAC.SAC_GSAC_CODE_FK
        LEFT JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = COSAC.COSAC_SAC_CODE_FK_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAC'''')
        LEFT JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM,
        GSAC.GSAC_CODE_SQ_PK AS SAC_CODE, GSAC.GSAC_NOM AS SAC_NOM, COSAC.COSAC_DOSAGE AS DOSAGE, COSAC.COSAC_UNITEDOSAGE AS UNITE_DOSAGE
        FROM SP_SPECIALITE SP
        LEFT JOIN COSAC_COMPO_SUBACT COSAC ON (COSAC.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        LEFT JOIN SAC_SUBACTIVE SAC ON (SAC.SAC_CODE_SQ_PK = COSAC.COSAC_SAC_CODE_FK_PK)
        LEFT JOIN GSAC_PERE_SUBACT GSAC ON GSAC.GSAC_CODE_SQ_PK = SAC.SAC_GSAC_CODE_FK
        LEFT JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = COSAC.COSAC_SAC_CODE_FK_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAC'''')
        LEFT JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API COMPOSITION DETAILLEE MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '650,1234,460'

-- DROP FUNCTION GET_THE_COMPO_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_COMPO_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM,
        SAC.SAC_CODE_SQ_PK AS SAC_CODE, SAC.SAC_NOM AS SAC_NOM, PREDISP.PREDISP_UNITEDISP AS DOSAGE, DOSE.CDF_NOM AS UNITE_DOSAGE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
        JOIN SAC_SUBACTIVE SAC ON SAC.SAC_CODE_SQ_PK = PREDISP.PREDISP_SAC_CODE_FK
        JOIN CDF_CODIF DOSE ON (DOSE.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
          AND DOSE.CDF_NUMERO_PK = ''''19'''')
        JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = SAC.SAC_CODE_SQ_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAC'''')
        JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM,
        SAC.SAC_CODE_SQ_PK AS SAC_CODE, SAC.SAC_NOM AS SAC_NOM, PREDISP.PREDISP_UNITEDISP AS DOSAGE, DOSE.CDF_NOM AS UNITE_DOSAGE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
        JOIN SAC_SUBACTIVE SAC ON SAC.SAC_CODE_SQ_PK = PREDISP.PREDISP_SAC_CODE_FK
        JOIN CDF_CODIF DOSE ON (DOSE.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
          AND DOSE.CDF_NUMERO_PK = ''''19'''')
        JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = SAC.SAC_CODE_SQ_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAC'''')
        JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API COMPOSITION SYNTHETIQUE SPECIALITE
-- EXEMPLE: LISTID := '26236,7130,8238,34245,13563,6849,2715'

-- DROP FUNCTION GET_THE_COMPO_SYNTH_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_COMPO_SYNTH_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, DC.ID AS ID_PRODUIT_DC, DC.LABEL AS NOM_PRODUIT_DC,
        SAC.SAC_CODE_SQ_PK AS SAC_CODE, COALESCE(SAC.SAC_NOM, ''''Non Applicable : > 3 substances actives'''') AS SAC_NOM, PREDISP.PREDISP_UNITEDISP AS DOSAGE, DOSE.CDF_NOM AS UNITE_DOSAGE
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON (PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK AND PRE.PRE_ETAT_COMMER = ''''D'''')
        LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
        LEFT JOIN SAC_SUBACTIVE SAC ON SAC.SAC_CODE_SQ_PK = PREDISP.PREDISP_SAC_CODE_FK
        LEFT JOIN CDF_CODIF DOSE ON (DOSE.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
          AND DOSE.CDF_NUMERO_PK = ''''19'''')
        JOIN GSP_GENERIQUE GSP ON GSP.GSP_GSP_CODE_FK = SP.SP_GSP_CODE_FK
        JOIN PRODUIT_DC DC ON DC.ID = GSP.GSP_PRODUIT_DC_CODE_FK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, DC.ID AS ID_PRODUIT_DC, DC.LABEL AS NOM_PRODUIT_DC,
        SAC.SAC_CODE_SQ_PK AS SAC_CODE, COALESCE(SAC.SAC_NOM, ''''Non Applicable : > 3 substances actives'''') AS SAC_NOM, PREDISP.PREDISP_UNITEDISP AS DOSAGE, DOSE.CDF_NOM AS UNITE_DOSAGE
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON (PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK AND PRE.PRE_ETAT_COMMER = ''''D'''')
        LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
        LEFT JOIN SAC_SUBACTIVE SAC ON SAC.SAC_CODE_SQ_PK = PREDISP.PREDISP_SAC_CODE_FK
        LEFT JOIN CDF_CODIF DOSE ON (DOSE.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
          AND DOSE.CDF_NUMERO_PK = ''''19'''')
        JOIN GSP_GENERIQUE GSP ON GSP.GSP_GSP_CODE_FK = SP.SP_GSP_CODE_FK
        JOIN PRODUIT_DC DC ON DC.ID = GSP.GSP_PRODUIT_DC_CODE_FK
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API COMPOSITION SYNTHETIQUE MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '650,1234,460,2100,3456'

-- DROP FUNCTION GET_THE_COMPO_SYNTH_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_COMPO_SYNTH_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP_SPE.GSP_CODE_SQ_PK AS CODE_GSP, GSP_SPE.GSP_NOM AS NOM_GENERIQUE, DC.ID AS ID_PRODUIT_DC, DC.LABEL AS NOM_PRODUIT_DC,
        SAC.SAC_CODE_SQ_PK AS SAC_CODE, SAC.SAC_NOM AS SAC_NOM, PREDISP.PREDISP_UNITEDISP AS DOSAGE, DOSE.CDF_NOM AS UNITE_DOSAGE
        FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
        JOIN SP_SPECIALITE SP ON SP.SP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
        LEFT JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
        LEFT JOIN SAC_SUBACTIVE SAC ON SAC.SAC_CODE_SQ_PK = PREDISP.PREDISP_SAC_CODE_FK
        LEFT JOIN CDF_CODIF DOSE ON (DOSE.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
          AND DOSE.CDF_NUMERO_PK = ''''19'''')
        LEFT JOIN GSP_GENERIQUE GSP ON GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
        LEFT JOIN PRODUIT_DC DC ON DC.ID = GSP.GSP_PRODUIT_DC_CODE_FK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP_SPE.GSP_CODE_SQ_PK AS CODE_GSP, GSP_SPE.GSP_NOM AS NOM_GENERIQUE, DC.ID AS ID_PRODUIT_DC, DC.LABEL AS NOM_PRODUIT_DC,
        SAC.SAC_CODE_SQ_PK AS SAC_CODE, SAC.SAC_NOM AS SAC_NOM, PREDISP.PREDISP_UNITEDISP AS DOSAGE, DOSE.CDF_NOM AS UNITE_DOSAGE
        FROM GSP_GENERIQUE_SPECIALITE GSP_SPE
        JOIN SP_SPECIALITE SP ON SP.SP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
        LEFT JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
        LEFT JOIN SAC_SUBACTIVE SAC ON SAC.SAC_CODE_SQ_PK = PREDISP.PREDISP_SAC_CODE_FK
        LEFT JOIN CDF_CODIF DOSE ON (DOSE.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
          AND DOSE.CDF_NUMERO_PK = ''''19'''')
        LEFT JOIN GSP_GENERIQUE GSP ON GSP.GSP_GSP_CODE_FK = GSP_SPE.GSP_CODE_SQ_PK
        LEFT JOIN PRODUIT_DC DC ON DC.ID = GSP.GSP_PRODUIT_DC_CODE_FK
        WHERE GSP_SPE.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API EXCIPIENTS A EFFET NOTOIRE SPECIALITE
-- EXEMPLE: LISTID := '4519,26236,24376,14883,11109,1708,6279,12684'

-- DROP FUNCTION GET_THE_EFFET_NOTOIRE_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_EFFET_NOTOIRE_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SAU.SAU_EFFETNOTOIRE AS EFFET_NOTOIRE, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM
        FROM SP_SPECIALITE SP
        JOIN COSAU_COMPO_SUBAUX COSAU ON COSAU.COSAU_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN SAU_SUBAUXILIAIRE SAU ON (SAU.SAU_CODE_SQ_PK = COSAU.COSAU_SAU_CODE_FK_PK
          AND SAU.SAU_EFFETNOTOIRE = ''''O'''')
        JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = SAU.SAU_CODE_SQ_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAU'''')
        JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SAU.SAU_EFFETNOTOIRE AS EFFET_NOTOIRE, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM
        FROM SP_SPECIALITE SP
        JOIN COSAU_COMPO_SUBAUX COSAU ON COSAU.COSAU_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN SAU_SUBAUXILIAIRE SAU ON (SAU.SAU_CODE_SQ_PK = COSAU.COSAU_SAU_CODE_FK_PK
          AND SAU.SAU_EFFETNOTOIRE = ''''O'''')
        JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = SAU.SAU_CODE_SQ_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAU'''')
        JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API EXCIPIENTS A EFFET NOTOIRE MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '650,1234,460'

-- DROP FUNCTION GET_THE_EFFET_NOTOIRE_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_EFFET_NOTOIRE_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SAU.SAU_EFFETNOTOIRE AS EFFET_NOTOIRE, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN COSAU_COMPO_SUBAUX COSAU ON COSAU.COSAU_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN SAU_SUBAUXILIAIRE SAU ON (SAU.SAU_CODE_SQ_PK = COSAU.COSAU_SAU_CODE_FK_PK
          AND SAU.SAU_EFFETNOTOIRE = ''''O'''')
        JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = SAU.SAU_CODE_SQ_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAU'''')
        JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, SAU.SAU_EFFETNOTOIRE AS EFFET_NOTOIRE, SUB.ID AS SUBSTANCE_ID, SUB.NOM AS SUBSTANCE_NOM
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN COSAU_COMPO_SUBAUX COSAU ON COSAU.COSAU_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN SAU_SUBAUXILIAIRE SAU ON (SAU.SAU_CODE_SQ_PK = COSAU.COSAU_SAU_CODE_FK_PK
          AND SAU.SAU_EFFETNOTOIRE = ''''O'''')
        JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = SAU.SAU_CODE_SQ_PK
          AND UPPER(SACSAU.SACSAU) = ''''SAU'''')
        JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API FICHE D INFORMATION THERAPEUTIQUE
-- EXEMPLE: LISTID := '154,2,4,8,9,10'

-- DROP FUNCTION GET_THE_FIC_INFO_THERA(VARCHAR);
CREATE OR REPLACE FUNCTION GET_THE_FIC_INFO_THERA (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FIT.FIT_CODE_SQ_PK
      FROM SP_SPECIALITE SP
      JOIN IT1SP_TERME1SPECIALITE IT1 ON IT1.IT1SP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
      JOIN IT2SP_TERME2SPECIALITE IT2 ON IT2.IT2SP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
      JOIN FIT_FICHEINTERAC FIT ON (FIT.FIT_CODE_SQ_PK = IT1.IT1SP_FIT_CODE_FK_PK
        OR FIT.FIT_CODE_SQ_PK = IT2.IT2SP_FIT_CODE_FK_PK)
      WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
      ORDER BY SP.SP_CODE_SQ_PK'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API FICHE D INFORMATION THERAPEUTIQUE GSP
-- EXEMPLE: LISTID := '154,2,4,8,9,10'

-- DROP FUNCTION GET_THE_FIC_INFO_THERA_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_FIC_INFO_THERA_GSP (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FIT.FIT_CODE_SQ_PK
      FROM GSP_GENERIQUE_SPECIALITE GSP
      JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
        AND GSP.GSP_NB_SUB < 4)
      JOIN IT1SP_TERME1SPECIALITE IT1 ON IT1.IT1SP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
      JOIN IT2SP_TERME2SPECIALITE IT2 ON IT2.IT2SP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
      JOIN FIT_FICHEINTERAC FIT ON (FIT.FIT_CODE_SQ_PK = IT1.IT1SP_FIT_CODE_FK_PK
        OR FIT.FIT_CODE_SQ_PK = IT2.IT2SP_FIT_CODE_FK_PK)
      WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
      ORDER BY GSP.GSP_CODE_SQ_PK'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CI OU PE AVEC AGE
-- EXEMPLE: LISTID := '4519,26236,3671,8932,22169,12368,27770' ET TYPID := 0

-- DROP FUNCTION GET_THE_TER_CIPEMG_AGE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_AGE (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  NBJOUR ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          WHEN MM.CDFMM_MIN < 365 THEN TO_CHAR(MM.CDFMM_MIN,''''999'''') || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MIN / 365,''''999'''') || '''' an(s)''''
        END AS AGE_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        CASE
          WHEN MM.CDFMM_MAX < 365 THEN TO_CHAR(MM.CDFMM_MAX,''''999'''') || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MAX / 365,''''999'''') || '''' ans(s)'''' 
        END AS AGE_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN
            (SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''JOURS''''
            AND CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK NOT IN (''''6563'''',''''6564'''',''''6565''''))
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          WHEN MM.CDFMM_MIN < 365 THEN TO_CHAR(MM.CDFMM_MIN,''''999'''') || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MIN / 365,''''999'''') || '''' an(s)''''
        END AS AGE_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        CASE
          WHEN MM.CDFMM_MAX < 365 THEN TO_CHAR(MM.CDFMM_MAX,''''999'''') || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MAX / 365,''''999'''') || '''' an(s)''''
        END AS AGE_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN
            (SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''JOURS''''
            AND CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''||NBJOUR||'' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK NOT IN (''''6563'''',''''6564'''',''''6565''''))
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE AVEC AGE GSP
-- EXEMPLE: LISTID := '4519,26236,3671,8932,22169,12368,27770' ET TYPID := 0

-- DROP FUNCTION GET_THE_TER_CIPEMG_AGE_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_AGE_GSP (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  NBJOUR ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          WHEN MM.CDFMM_MIN < 365 THEN TO_CHAR(MM.CDFMM_MIN) || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MIN / 365) || '''' an(s)''''
        END AS AGE_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        CASE
          WHEN MM.CDFMM_MAX < 365 THEN TO_CHAR(MM.CDFMM_MAX) || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MAX / 365) || '''' an(s)'''' 
        END AS AGE_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK IN
            (SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF CDFMM
            WHERE UPPER(CDFMM.CDFMM_MIN_UNITE) = ''''JOURS''''
            AND CDFMM.CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
          AND FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK NOT IN (''''6563'''',''''6564'''',''''6565''''))
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          WHEN MM.CDFMM_MIN < 365 THEN TO_CHAR(MM.CDFMM_MIN) || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MIN / 365) || '''' an(s)''''
        END AS AGE_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        CASE
          WHEN MM.CDFMM_MAX < 365 THEN TO_CHAR(MM.CDFMM_MAX) || '''' Jours''''
          ELSE TO_CHAR(MM.CDFMM_MAX / 365) || '''' an(s)'''' 
        END AS AGE_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK IN
            (SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF CDFMM
            WHERE UPPER(CDFMM.CDFMM_MIN_UNITE) = ''''JOURS''''
            AND CDFMM.CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''||NBJOUR||'' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK)
          AND FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK NOT IN (''''6563'''',''''6564'''',''''6565''''))
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CI OU PE AVEC POIDS
-- EXEMPLE: LISTID := '26236,12368,7130,27770' ET TYPID := 1

-- DROP FUNCTION GET_THE_TER_CIPEMG_PDS(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_PDS (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  POIDS ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN,''''999'''') 
        END AS PDS_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX,''''999'''') || '''' KG'''' AS PDS_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN 
            (SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''KG''''
            AND CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN,''''999'''') 
        END AS PDS_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX,''''999'''') || '''' KG'''' AS PDS_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''KG''''
            AND CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''||POIDS||'' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE AVEC POIDS GSP
-- EXEMPLE: LISTID := '26236,12368,7130,27770' ET TYPID := 1

-- DROP FUNCTION GET_THE_TER_CIPEMG_PDS_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_PDS_GSP (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  POIDS ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN) 
        END AS PDS_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX) || '''' KG'''' AS PDS_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN 
            (SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''KG''''
            AND CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN) 
        END AS PDS_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX) || '''' KG'''' AS PDS_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN 
            (SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''KG''''
            AND CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''||POIDS||'' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CI OU PE AVEC INSUFFISANCE RENALE
-- EXEMPLE: LISTID := '26236,3671,8932,22169,12368' ET TYPID := 1

-- DROP FUNCTION GET_THE_TER_CIPEMG_CLR(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_CLR (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  CLAIRANCE ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN,''''999'''') 
        END AS CLR_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX,''''999'''') || '''' ML/MIN/1.73 M2'''' AS CLR_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''ML/MIN/1.73 M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN,''''999'''') 
        END AS CLR_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX,''''999'''') || '''' ML/MIN/1.73 M2'''' AS CLR_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''ML/MIN/1.73 M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''||CLAIRANCE||'' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
         WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE AVEC INSUFFISANCE RENALE GSP
-- EXEMPLE: LISTID := '26236,3671,8932,22169,12368' ET TYPID := 1

-- DROP FUNCTION GET_THE_TER_CIPEMG_CLR_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_CLR_GSP (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  CLAIRANCE ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN) 
        END AS CLR_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX) || '''' ML/MIN/1.73 M2'''' AS CLR_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''ML/MIN/1.73 M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN) 
        END AS CLR_MIN,
        MM.CDFMM_MIN AS V_MIN,
        MM.CDFMM_MIN_UNITE AS U_MIN,
        TO_CHAR(MM.CDFMM_MAX) || '''' ML/MIN/1.73 M2'''' AS CLR_MAX,
        MM.CDFMM_MAX AS V_MAX,
        MM.CDFMM_MAX_UNITE AS U_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''ML/MIN/1.73 M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''||CLAIRANCE||'' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
         WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CI OU PE AVEC LA SURFACE CORPORELLE
-- EXEMPLE: LISTID := '20432,22169' ET TYPID := 0

-- DROP FUNCTION GET_THE_TER_CIPEMG_SURF(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_SURF (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  SURFACE ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN,''''999'''') 
        END AS SURF_MIN,
        TO_CHAR(MM.CDFMM_MAX,''''999'''') || ''''M2'''' AS SURF_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN,''''999'''') 
        END AS SURF_MIN,
        TO_CHAR(MM.CDFMM_MAX,''''999'''') || ''''M2'''' AS SURF_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''||SURFACE||'' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
         WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE AVEC LA SURFACE CORPORELLE GSP
-- EXEMPLE: LISTID := '26236,3671,8932,22169,12368' ET TYPID := 1

-- DROP FUNCTION GET_THE_TER_CIPEMG_SUR_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_SUR_GSP (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  CLAIRANCE ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN) 
        END AS SURF_MIN,
        TO_CHAR(MM.CDFMM_MAX) || ''''M2'''' AS SURF_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE,
        CASE
          WHEN MM.CDFMM_MIN = 0 THEN ''''< ''''
          ELSE TO_CHAR(MM.CDFMM_MIN) 
        END AS SURF_MIN,
        TO_CHAR(MM.CDFMM_MAX) || ''''M2'''' AS SURF_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON (FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG ON (FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN (
            SELECT DISTINCT CDFMM_CDF_CODE_FK_PK
            FROM CDF_MIN_MAX_CODIF
            WHERE UPPER(CDFMM_MIN_UNITE) = ''''M2''''
            AND CDFMM_CDF_NUM_FK = ''''CS''''
            AND ''''||SURFACE||'''' BETWEEN CDFMM_MIN AND CDFMM_MAX)
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPM_FICHECIPEMG.FCPM_CODE_SQ_PK)
        JOIN CDF_MIN_MAX_CODIF MM ON (MM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK AND MM.CDFMM_CDF_NUM_FK = ''''CS'''')
         WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE PROCREATION HOMME ET FEMME SPE
-- EXEMPLE: LISTID := '22207,7306' ET TYPID := 2

-- DROP FUNCTION GET_THE_PROC_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PROC_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18447'''',''''20449''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18448'''',''''20449''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
         WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE PROCREATION HOMME ET FEMME GSP
-- EXEMPLE: LISTID := '1747,1758' ET TYPID := 2

-- DROP FUNCTION GET_THE_PROC_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PROC_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18447'''',''''20449''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18448'''',''''20449''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
         WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE PROCREATION HOMME ET FEMME SPE V2 EN FONCTION DE L AGE
-- EXEMPLE: LISTID := '22207,7306' ET TYPID := 2

-- DROP FUNCTION GET_THE_PROC_SPEV2(VARCHAR,NUMERIC;NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PROC_SPEV2 (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1; AGEJOUR ALIAS FOR $2; TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18447'''',''''20449''''))
        LEFT JOIN CDF_MIN_MAX_CODIF CDFMM ON (CDFMM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN(''''6564'''',''''6563''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
          AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
          AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
          AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND ''||AGEJOUR||'' BETWEEN CDFMM.CDFMM_MIN AND CDFMM.CDFMM_MAX'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18448'''',''''20449''''))
        LEFT JOIN CDF_MIN_MAX_CODIF CDFMM ON (CDFMM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN(''''6565'''',''''6563''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
          AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
          AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
          AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND ''||AGEJOUR||'' BETWEEN CDFMM.CDFMM_MIN AND CDFMM.CDFMM_MAX'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE PROCREATION HOMME ET FEMME GSP V2 EN FONCTION DE L AGE
-- EXEMPLE: LISTID := '1747,1758' ET TYPID := 2

-- DROP FUNCTION GET_THE_PROC_GSPV2(VARCHAR,NUMERIC,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PROC_GSPV2 (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1; AGEJOUR ALIAS FOR $2; TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18447'''',''''20449''''))
        LEFT JOIN CDF_MIN_MAX_CODIF CDFMM ON (CDFMM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN(''''6564'''',''''6563''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
          AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
          AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
          AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||AGEJOUR||'' BETWEEN CDFMM.CDFMM_MIN AND CDFMM.CDFMM_MAX'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK  IN (''''18448'''',''''20449''''))
        LEFT JOIN CDF_MIN_MAX_CODIF CDFMM ON (CDFMM.CDFMM_CDF_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK
          AND FCPMTER_FCPM_TERRAIN.FCPMTER_CDF_TER_CODE_FK_PK IN(''''6565'''',''''6563''''))
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
          AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
          AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
          AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||AGEJOUR||'' BETWEEN CDFMM.CDFMM_MIN AND CDFMM.CDFMM_MAX'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE SEXE HOMME ET FEMME SPE
-- EXEMPLE: LISTID := '22207,7306' ET TYPID := 2

-- DROP FUNCTION GET_THE_SEXE_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SEXE_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK = 18153)
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR SP.SP_CIPUCD IN (''||LISTID||''))'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK = 20024)
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE SEXE HOMME ET FEMME GSP
-- EXEMPLE: LISTID := '1747,1758' ET TYPID := 2

-- DROP FUNCTION GET_THE_SEXE_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SEXE_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK = 18153)
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK AS CI_PE, FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_TEXTE AS INFOS
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE ON FCPMSP_CIPEMG_SPE.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPMTER_FCPM_TERRAIN ON (FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK = FCPMSP_CIPEMG_SPE.FCPMSP_FCPM_CODE_FK_PK
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''', ''''P'''')
        AND FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK = 20024)
        LEFT JOIN FCPMTX_FICHECIPEMG_TEXTE ON (FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_FCPM_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_FCPM_CODE_FK_PK
        AND FCPMTX_FICHECIPEMG_TEXTE.FCPMTX_CIM_TER_CODE_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_CIM_TER_CODE_FK_PK
        AND FCPMTX_NATURECIPEMG_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NATURE_CIPEMG_PK
        AND FCPMTX_NUMSEQ_TER_FK_PK = FCPMTER_FCPM_TERRAIN.FCPMTER_NUMSEQ_PK)
         WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CI OU PE AVEC LA GROSSESSE
-- EXEMPLE: LISTID := '4519,26236,24376,14883,11109' ET TYPID := 11

-- DROP FUNCTION GET_THE_TER_CIPEMG_GR(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_GR (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  NBSEMAINES ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS NIV, CDFMM.CDFMM_MIN AS DEBUT_PERIODE, CDFMM.CDFMM_MIN_UNITE AS UNITE_PERIODE_MIN, CDFMM_MAX AS FIN_PERIODE, CDFMM.CDFMM_MAX_UNITE AS UNITE_PERIODE_MAX
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P''''))
        JOIN CDF_MIN_MAX_CODIF CDFMM ON (CDFMM.CDFMM_CDF_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
            AND CDFMM.CDFMM_CDF_CODE_FK_PK IN (''''PA'''',''''1340'''',''''1346'''',''''1353'''',''''1611'''',''''2714'''',''''4671'''',''''4719'''',''''5694''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 11 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R28'''',''''R4'''',''''R43'''',''''R44'''',''''R5''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R2'''',''''R29'''',''''R3'''',''''R30'''',''''R32'''',''''R35'''',''''R38'''',''''R46'''',''''R47'''',''''R48'''',''''R49'''',''''R50'''',''''R8''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R1'''',''''R15'''',''''R25''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R14''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 12 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R28'''',''''R4'''',''''R43'''',''''R44'''',''''R5''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R2'''',''''R29'''',''''R3'''',''''R30'''',''''R32'''',''''R35'''',''''R38'''',''''R46'''',''''R47'''',''''R48'''',''''R49'''',''''R50'''',''''R8''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R1'''',''''R15'''',''''R25''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R14''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE AVEC LA GROSSESSE GSP
-- EXEMPLE: LISTID := '4519,26236,24376,14883,11109' ET TYPID := 11

-- DROP FUNCTION GET_THE_TER_CIPEMG_GR_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_GR_GSP (VARCHAR,NUMERIC,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  NBSEMAINES ALIAS FOR $2;  TYPID ALIAS FOR $3;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS NIV, CDFMM.CDFMM_MIN AS DEBUT_PERIODE, CDFMM.CDFMM_MIN_UNITE AS UNITE_PERIODE_MIN, CDFMM_MAX AS FIN_PERIODE, CDFMM.CDFMM_MAX_UNITE AS UNITE_PERIODE_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P''''))
        JOIN CDF_MIN_MAX_CODIF CDFMM ON (CDFMM.CDFMM_CDF_CODE_FK_PK = FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK
            AND CDFMM.CDFMM_CDF_CODE_FK_PK IN (''''PA'''',''''1340'''',''''1346'''',''''1353'''',''''1611'''',''''2714'''',''''4671'''',''''4719'''',''''5694''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 11 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R28'''',''''R4'''',''''R43'''',''''R44'''',''''R5''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R2'''',''''R29'''',''''R3'''',''''R30'''',''''R32'''',''''R35'''',''''R38'''',''''R46'''',''''R47'''',''''R48'''',''''R49'''',''''R50'''',''''R8''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R1'''',''''R15'''',''''R25''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R14''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 12 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R28'''',''''R4'''',''''R43'''',''''R44'''',''''R5''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R2'''',''''R29'''',''''R3'''',''''R30'''',''''R32'''',''''R35'''',''''R38'''',''''R46'''',''''R47'''',''''R48'''',''''R49'''',''''R50'''',''''R8''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R1'''',''''R15'''',''''R25''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA
        UNION
        SELECT FGARIG.FGARIG_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE,
        SAG.CDFGP_MIN_SA AS SA_MIN, SAG.CDFGP_MAX_SA AS SA_MAX, SAG.CDFGP_MIN_SG AS SG_MIN, SAG.CDFGP_MAX_SG AS SG_MAX
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIG_RISQUE_GROSSESSE FGARIG ON FGARIG.FGARIG_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NIV ON (NIV.CDF_NUMERO_PK = ''''GP'''' AND NIV.CDF_CODE_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDFGP_CODIF SAG ON (SAG.CDFGP_CDF_CODE_FK_PK = FGARIG.FGARIG_CDF_TC_CODE_FK)
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIG.FGARIG_CDF_RI_CODE_FK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND NAT.CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R14''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND ''||NBSEMAINES||'' BETWEEN SAG.CDFGP_MIN_SA AND SAG.CDFGP_MAX_SA'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CI OU PE AVEC ALLAITEMENT
-- EXEMPLE: LISTID := '14368,11109,1708,6279' ET TYPID := 11

-- DROP FUNCTION GET_THE_TER_CIPEMG_AL(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_AL (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 00 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS NIV
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPM_FICHECIPEMG FCPM ON FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK = ''''PC'''')'';
  END IF;
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS NIV
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK = ''''PC'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 10 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R20'''',''''R4'''',''''R5'''',''''R6'''',''''R9''''))
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R2'''',''''R7'''',''''R8''''))
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R1'''',''''R10'''',''''R15'''',''''R25''''))
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R13''''))
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 11 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R20'''',''''R4'''',''''R5'''',''''R6'''',''''R9''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R2'''',''''R7'''',''''R8''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R1'''',''''R10'''',''''R15'''',''''R25''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM SP_SPECIALITE SP
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R13''''))
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CI OU PE AVEC ALLAITEMENT GSP
-- EXEMPLE: LISTID := '14368,11109,1708,6279' ET TYPID := 11

-- DROP FUNCTION GET_THE_TER_CIPEMG_AL_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_TER_CIPEMG_AL_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 00 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS NIV
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FCPM_FICHECIPEMG FCPM ON FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK = ''''PC'''')'';
  END IF;
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FCPM.FCPM_CODE_SQ_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS NIV
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
          AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P'''')
          AND FCPMTER.FCPMTER_CDF_TER_CODE_FK_PK = ''''PC'''')
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 10 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R20'''',''''R4'''',''''R5'''',''''R6'''',''''R9''''))
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R2'''',''''R7'''',''''R8''''))
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R1'''',''''R10'''',''''R15'''',''''R25''''))
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R13''''))
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 11 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''C'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R20'''',''''R4'''',''''R5'''',''''R6'''',''''R9''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''P'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R2'''',''''R7'''',''''R8''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''N'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R1'''',''''R10'''',''''R15'''',''''R25''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT FGARIL.FGARIL_FGA_CODE_FK_PK AS FICHE_CODE, GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, ''''I'''' AS NATURE, NAT.CDF_NOM AS LIBELLE_NATURE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FGASP_GRALSPE FGASP ON FGASP.FGASP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FGARIL_RISQUE_ALLAITEMENT FGARIL ON FGARIL.FGARIL_FGA_CODE_FK_PK = FGASP.FGASP_FGA_CODE_FK_PK
        JOIN CDF_CODIF NAT ON (NAT.CDF_CODE_PK = FGARIL.FGARIL_CDF_RI_CODE_FK_PK
          AND NAT.CDF_NUMERO_PK = ''''GR''''
          AND CDF_CODE_PK IN (''''R11'''',''''R12'''',''''R13''''))
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API HYPERSENSIBILITE DESCRIPTION SPECIALITE
-- EXEMPLE: LISTID := '4519,3671,8932,22169,427'

-- DROP FUNCTION GET_THE_SPE_TO_HYPER(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SPE_TO_HYPER (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
          SACSAU.SACSAU AS SACSAU, SUB.ID AS ID_SUBSTANCE, SUB.NOM AS NOM_SUBSTANCE, 
          FAM.ID AS ID_FAMILLE, FAM.NOM AS NOM_FAMILLE,
          CR.ID AS ID_CROISEE, CR.NOM1 || '''' - '''' || CR.NOM2 AS CROISEE
        FROM SP_SPECIALITE SP
        JOIN COSAC_COMPO_SUBACT COSAC ON COSAC.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        -- JOINTURE POUR LES SUBSTANCES
        LEFT JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = COSAC.COSAC_SAC_CODE_FK_PK AND UPPER(SACSAU.SACSAU) = ''''SAC'''')
        LEFT JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        -- JOINTURE POUR LES FAMILLES
        LEFT JOIN FAMILLE_SAC FAMSAC ON FAMSAC.SAC_CODE = COSAC.COSAC_SAC_CODE_FK_PK
        LEFT JOIN FAMILLE FAM ON FAM.ID = FAMSAC.FAMILLE_ID
        -- JOINTURE POUR LES CROISEES
        LEFT JOIN CROISEE_SAC CRSAC ON CRSAC.SAC_CODE = COSAC.COSAC_SAC_CODE_FK_PK
        LEFT JOIN CROISEE CR ON (UPPER(SACSAU1) = ''''SAC'''' AND ID1 = CRSAC.SAC_CODE OR UPPER(SACSAU2) = ''''SAC'''' AND ID2 = CRSAC.SAC_CODE)
        -- CHOIX DE LA SPE
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT DISTINCT SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
          SACSAU.SACSAU AS SACSAU, SUB.ID AS ID_SUBSTANCE, SUB.NOM AS NOM_SUBSTANCE, 
          FAM.ID AS ID_FAMILLE, FAM.NOM AS NOM_FAMILLE,
          CR.ID AS ID_CROISEE, CR.NOM1 || '''' - '''' || CR.NOM2 AS CROISEE
        FROM SP_SPECIALITE SP
        JOIN COSAU_COMPO_SUBAUX COSAU ON COSAU.COSAU_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        -- JOINTURE POUR LES SUBSTANCES
        LEFT JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = COSAU.COSAU_SAU_CODE_FK_PK AND UPPER(SACSAU.SACSAU) = ''''SAU'''')
        LEFT JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        -- JOINTURE POUR LES FAMILLES
        LEFT JOIN FAMILLE_SAU FAMSAU ON FAMSAU.SAU_CODE = COSAU.COSAU_SAU_CODE_FK_PK
        LEFT JOIN FAMILLE FAM ON FAM.ID = FAMSAU.FAMILLE_ID
        -- JOINTURE POUR LES CROISEES
        LEFT JOIN CROISEE_SAU CRSAU ON CRSAU.SAU_CODE = COSAU.COSAU_SAU_CODE_FK_PK
        LEFT JOIN CROISEE CR ON (UPPER(SACSAU1) = ''''SAU'''' AND ID1 = CRSAU.SAU_CODE OR UPPER(SACSAU2) = ''''SAU'''' AND ID2 = CRSAU.SAU_CODE)
        -- CHOIX DE LA SPE
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API HYPERSENSIBILITE DESCRIPTION SACSAU MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '115,967'

-- DROP FUNCTION GET_THE_GSP_TO_HYPER(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_GSP_TO_HYPER (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GSP,
          SACSAU.SACSAU AS SACSAU, SUB.ID AS ID_SUBSTANCE, SUB.NOM AS NOM_SUBSTANCE, 
          FAM.ID AS ID_FAMILLE, FAM.NOM AS NOM_FAMILLE,
          CR.ID AS ID_CROISEE, CR.NOM1 || '''' - '''' || CR.NOM2 AS CROISEE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN COSAC_COMPO_SUBACT COSAC ON COSAC.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        -- JOINTURE POUR LES SUBSTANCES
        LEFT JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = COSAC.COSAC_SAC_CODE_FK_PK AND UPPER(SACSAU.SACSAU) = ''''SAC'''')
        LEFT JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        -- JOINTURE POUR LES FAMILLES
        LEFT JOIN FAMILLE_SAC FAMSAC ON FAMSAC.SAC_CODE = COSAC.COSAC_SAC_CODE_FK_PK
        LEFT JOIN FAMILLE FAM ON FAM.ID = FAMSAC.FAMILLE_ID
        -- JOINTURE POUR LES CROISEES
        LEFT JOIN CROISEE_SAC CRSAC ON CRSAC.SAC_CODE = COSAC.COSAC_SAC_CODE_FK_PK
        LEFT JOIN CROISEE CR ON (UPPER(SACSAU1) = ''''SAC'''' AND ID1 = CRSAC.SAC_CODE OR UPPER(SACSAU2) = ''''SAC'''' AND ID2 = CRSAC.SAC_CODE)
        -- CHOIX DU GSP
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GSP,
          SACSAU.SACSAU AS SACSAU, SUB.ID AS ID_SUBSTANCE, SUB.NOM AS NOM_SUBSTANCE, 
          FAM.ID AS ID_FAMILLE, FAM.NOM AS NOM_FAMILLE,
          CR.ID AS ID_CROISEE, CR.NOM1 || '''' - '''' || CR.NOM2 AS CROISEE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN COSAU_COMPO_SUBAUX COSAU ON COSAU.COSAU_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        -- JOINTURE POUR LES SUBSTANCES
        LEFT JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = COSAU.COSAU_SAU_CODE_FK_PK AND UPPER(SACSAU.SACSAU) = ''''SAU'''')
        LEFT JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        -- JOINTURE POUR LES FAMILLES
        LEFT JOIN FAMILLE_SAU FAMSAU ON FAMSAU.SAU_CODE = COSAU.COSAU_SAU_CODE_FK_PK
        LEFT JOIN FAMILLE FAM ON FAM.ID = FAMSAU.FAMILLE_ID
        -- JOINTURE POUR LES CROISEES
        LEFT JOIN CROISEE_SAU CRSAU ON CRSAU.SAU_CODE = COSAU.COSAU_SAU_CODE_FK_PK
        LEFT JOIN CROISEE CR ON (UPPER(SACSAU1) = ''''SAU'''' AND ID1 = CRSAU.SAU_CODE OR UPPER(SACSAU2) = ''''SAU'''' AND ID2 = CRSAU.SAU_CODE)
        -- CHOIX DU GSP
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY SACSAU'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API HYPERSENSIBILITE DESCRIPTION SAC MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '115,967'

-- DROP FUNCTION GET_THE_GSP_TO_HYPER_SAC(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_GSP_TO_HYPER_SAC (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GSP,
          SACSAU.SACSAU AS SACSAU, SUB.ID AS ID_SUBSTANCE, SUB.NOM AS NOM_SUBSTANCE, 
          FAM.ID AS ID_FAMILLE, FAM.NOM AS NOM_FAMILLE,
          CR.ID AS ID_CROISEE, CR.NOM1 || '''' - '''' || CR.NOM2 AS CROISEE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN COSAC_COMPO_SUBACT COSAC ON COSAC.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        -- JOINTURE POUR LES SUBSTANCES
        LEFT JOIN SUBSTANCE_SACSAU SACSAU ON (SACSAU.SACSAU_ID = COSAC.COSAC_SAC_CODE_FK_PK AND UPPER(SACSAU.SACSAU) = ''''SAC'''')
        LEFT JOIN SUBSTANCE SUB ON SUB.ID = SACSAU.SUBSTANCE_ID
        -- JOINTURE POUR LES FAMILLES
        LEFT JOIN FAMILLE_SAC FAMSAC ON FAMSAC.SAC_CODE = COSAC.COSAC_SAC_CODE_FK_PK
        LEFT JOIN FAMILLE FAM ON FAM.ID = FAMSAC.FAMILLE_ID
        -- JOINTURE POUR LES CROISEES
        LEFT JOIN CROISEE_SAC CRSAC ON CRSAC.SAC_CODE = COSAC.COSAC_SAC_CODE_FK_PK
        LEFT JOIN CROISEE CR ON (UPPER(SACSAU1) = ''''SAC'''' AND ID1 = CRSAC.SAC_CODE OR UPPER(SACSAU2) = ''''SAC'''' AND ID2 = CRSAC.SAC_CODE)
        -- CHOIX DU GSP
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        ORDER BY SACSAU'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API HYPERSENSIBILITE ANALYSE SPECIALITE
-- EXEMPLE: LISTID := '33,37,89,4' ET TYPID := 1 OU LISTID := '2238,297' ET TYPID := 2

-- DROP FUNCTION GET_THE_HYPER_TO_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_HYPER_TO_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SUB.ID AS IDSUBFAM, SUB.NOM AS NOM_SUBFAM, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_CODE_SQ_PK
        FROM SUBSTANCE SUB
        JOIN SUBSTANCE_SACSAU SACSAU ON SACSAU.SUBSTANCE_ID = SUB.ID
        JOIN COSAC_COMPO_SUBACT COSAC ON COSAC.COSAC_SAC_CODE_FK_PK = SACSAU.SACSAU_ID
        JOIN SP_SPECIALITE SP ON SP.SP_CODE_SQ_PK = COSAC.COSAC_SP_CODE_FK_PK
        WHERE SUB.ID IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT FAM.ID AS ID_SUBFAM, FAM.NOM AS NOM_SUBFAM, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_CODE_SQ_PK
        FROM FAMILLE FAM
        JOIN FAMILLE_SAC FAMSAC ON FAMSAC.FAMILLE_ID = FAM.ID
        JOIN COSAC_COMPO_SUBACT COSAC ON COSAC.COSAC_SAC_CODE_FK_PK = FAMSAC.SAC_CODE
        JOIN SP_SPECIALITE SP ON SP.SP_CODE_SQ_PK = COSAC.COSAC_SP_CODE_FK_PK
        WHERE FAM.ID IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API HYPERSENSIBILITE ANALYSE MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '37,89' ET TYPID := 1 OU LISTID := '21,54' ET TYPID := 2

-- DROP FUNCTION GET_THE_HYPER_TO_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_HYPER_TO_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SUB.ID AS IDSUBFAM, SUB.NOM AS NOM_SUBFAM, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS NOM_GSP
        FROM SUBSTANCE SUB
        JOIN SUBSTANCE_SACSAU SACSAU ON SACSAU.SUBSTANCE_ID = SUB.ID
        JOIN COSAC_COMPO_SUBACT COSAC ON COSAC.COSAC_SAC_CODE_FK_PK = SACSAU.SACSAU_ID
        JOIN SP_SPECIALITE SP ON SP.SP_CODE_SQ_PK = COSAC.COSAC_SP_CODE_FK_PK
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE SUB.ID IN (''||LISTID||'')'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FAM.ID AS ID_SUBFAM, FAM.NOM AS NOM_SUBFAM, GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS NOM_GSP
        FROM FAMILLE FAM
        JOIN FAMILLE_SAC FAMSAC ON FAMSAC.FAMILLE_ID = FAM.ID
        JOIN COSAC_COMPO_SUBACT COSAC ON COSAC.COSAC_SAC_CODE_FK_PK = FAMSAC.SAC_CODE
        JOIN SP_SPECIALITE SP ON SP.SP_CODE_SQ_PK = COSAC.COSAC_SP_CODE_FK_PK
        JOIN GSP_GENERIQUE_SPECIALITE GSP ON GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        WHERE FAM.ID IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API INDICATIONS SPECIALITE
-- EXEMPLE: LISTID := '6378,18219,22289,11898,4679' ET TYPID := 1

-- DROP FUNCTION GET_THE_INDIC_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INDIC_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10.CIM_CODE AS CIM10_CODE, CIM10.CIM_LIBELLE AS CIM10_LIBELLE
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON CIM10.ID = FIN.FIN_CIM_NAIN_CODE_FK_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10.CIM_CODE AS CIM10_CODE, CIM10.CIM_LIBELLE AS CIM10_LIBELLE
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON CIM10.ID = FIN.FIN_CIM_NAIN_CODE_FK_PK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API INDICATIONS MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '115,967,650,1234,460' ET TYPID := 1

-- DROP FUNCTION GET_THE_INDIC_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INDIC_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CIM10.CIM_CODE AS CIM10_CODE, CIM10.CIM_LIBELLE AS CIM10_LIBELLE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON CIM10.ID = FIN.FIN_CIM_NAIN_CODE_FK_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, CIM10.CIM_CODE AS CIM10_CODE, CIM10.CIM_LIBELLE AS CIM10_LIBELLE
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON CIM10.ID = FIN.FIN_CIM_NAIN_CODE_FK_PK
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CONTRE INDICATIONS - PRECAUTIONS D EMPLOI SPECIALITE
-- EXEMPLE: LISTID := '6378,18219,22289,11898,4679' ET TYPID := 1

-- DROP FUNCTION GET_THE_CIPE_SPE_CIM10(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_CIPE_SPE_CIM10 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS CIPE, CHAP.CIM_CODE AS CODE_CIM10, CIM10.CIM_LIBELLE AS LIBELLE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
            AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P''''))
        JOIN CIM10V2_HAS_CODIF CIM10CDF ON (CIM10CDF.ID = FCPMTER.FCPMTER_CIM_TER_CODE_FK_PK)
        JOIN CIM10V2 CIM10 ON (CIM10.ID = CIM10CDF.ID
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        JOIN CIM10V2 CHAP ON (CHAP.CIM_CODE LIKE substr(CIM10.CIM_CODE, 1,3) || ''''%''''
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        ORDER BY SP.SP_CIPUCD, CHAP.CIM_CODE'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS CIPE, CHAP.CIM_CODE AS CODE_CIM10, CIM10.CIM_LIBELLE AS LIBELLE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
            AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P''''))
        JOIN CIM10V2_HAS_CODIF CIM10CDF ON (CIM10CDF.ID = FCPMTER.FCPMTER_CIM_TER_CODE_FK_PK)
        JOIN CIM10V2 CIM10 ON (CIM10.ID = CIM10CDF.ID
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        JOIN CIM10V2 CHAP ON (CHAP.CIM_CODE LIKE substr(CIM10.CIM_CODE, 1,3) || ''''%''''
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP.SP_CIPUCD, CHAP.CIM_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API CONTRE INDICATIONS - PRECAUTIONS D EMPLOI MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '115,967,650,460,1234' ET TYPID := 1

-- DROP FUNCTION GET_THE_CIPE_GSP_CIM10(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_CIPE_GSP_CIM10 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS CIPE, CHAP.CIM_CODE AS CODE_CIM10, CIM10.CIM_LIBELLE AS LIBELLE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
            AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P''''))
        JOIN CIM10V2_HAS_CODIF CIM10CDF ON CIM10CDF.ID = FCPMTER.FCPMTER_CIM_TER_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON (CIM10.ID = CIM10CDF.ID
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        JOIN CIM10V2 CHAP ON (CHAP.CIM_CODE LIKE substr(CIM10.CIM_CODE, 1,3) || ''''%''''
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        ORDER BY SP.SP_GSP_CODE_FK, CHAP.CIM_CODE'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, FCPMTER.FCPMTER_NATURE_CIPEMG_PK AS CIPE, CHAP.CIM_CODE AS CODE_CIM10, CIM10.CIM_LIBELLE AS LIBELLE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON (FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK)
        JOIN FCPM_FICHECIPEMG FCPM ON (FCPM.FCPM_CODE_SQ_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK)
        JOIN FCPMTER_FCPM_TERRAIN FCPMTER ON (FCPMTER.FCPMTER_FCPM_CODE_FK_PK = FCPM.FCPM_CODE_SQ_PK
            AND FCPMTER.FCPMTER_NATURE_CIPEMG_PK IN (''''C'''',''''P''''))
        JOIN CIM10V2_HAS_CODIF CIM10CDF ON CIM10CDF.ID = FCPMTER.FCPMTER_CIM_TER_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON (CIM10.ID = CIM10CDF.ID
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        JOIN CIM10V2 CHAP ON (CHAP.CIM_CODE LIKE substr(CIM10.CIM_CODE, 1,3) || ''''%''''
          AND CIM10.CIM_CODE NOT LIKE ''''NC%'''')
        WHERE SP.SP_GSP_CODE_FK IN (''||LISTID||'')
        ORDER BY SP.SP_GSP_CODE_FK, CHAP.CIM_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API INDICATIONS AMM / PTT / TRU
-- EXEMPLE: LISTID := '9978,4048,28396' ET TYPID := 1

-- DROP FUNCTION GET_THE_INDIC_AMM_PTT_TRU(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INDIC_AMM_PTT_TRU (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10V2.CIM_LIBELLE AS INDICATION, ''''AMM'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''D'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10V2.CIM_LIBELLE AS INDICATION, ''''PTT'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''M'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10V2.CIM_LIBELLE AS INDICATION, ''''RTU'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''O'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10V2.CIM_LIBELLE AS INDICATION, ''''AMM'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''D'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10V2.CIM_LIBELLE AS INDICATION, ''''PTT'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''M'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, CIM10V2.CIM_LIBELLE AS INDICATION, ''''RTU'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM SP_SPECIALITE SP
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''O'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API INDICATIONS AMM / PTT / TRU GSP
-- EXEMPLE: LISTID := '9978,4048,28396' ET TYPID := 1

-- DROP FUNCTION GET_THE_IND_AMM_PTT_TRU_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_IND_AMM_PTT_TRU_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, CIM10V2.CIM_LIBELLE AS INDICATION, ''''AMM'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''D'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, CIM10V2.CIM_LIBELLE AS INDICATION, ''''PTT'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''M'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, CIM10V2.CIM_LIBELLE AS INDICATION, ''''RTU'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''O'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, CIM10V2.CIM_LIBELLE AS INDICATION, ''''AMM'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''D'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        WHERE SP.SP_GSP_CODE_FK IN (''||LISTID||'')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, CIM10V2.CIM_LIBELLE AS INDICATION, ''''PTT'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''M'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        WHERE SP.SP_GSP_CODE_FK IN (''||LISTID||'')
        UNION
        SELECT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GENERIQUE, CIM10V2.CIM_LIBELLE AS INDICATION, ''''RTU'''' AS NIVEAU, CIM10V2.CIM_CODE AS CODE_CIM10
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4)
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
          AND FIN.FIN_CDF_NVIN_CODE_FK_PK = ''''O'''')
        JOIN CIM10V2_HAS_CODIF CIM10 ON (CIM10.CIM_CODE_CDF = FIN.FIN_CDF_NAIN_CODE_FK_PK
          AND CIM10.CIM_NUMERO_CDF = ''''NN'''')
        JOIN CIM10V2 CIM10V2 ON CIM10V2.ID = CIM10.CIM_ID
        WHERE SP.SP_GSP_CODE_FK IN (''||LISTID||'')'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API INTERACTION SPECIALITE
-- EXEMPLE: LISTID := '6378,18219,22289' ET TYPID := 1

-- DROP FUNCTION GET_THE_INTER_SPE_SAC(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INTER_SPE_SAC (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FIT.FIT_CODE_SQ_PK AS FIT_CODE_SQ_PK, CIM.CIM_LIBELLE AS TERRAIN, FITTER.FITTER_FIT_CODE_FK_PK AS CODE_TER, 
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SP2.SP_CIPUCD ELSE SP1.SP_CIPUCD END AS SP1_CIPUCD,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SP2.SP_CODE_SQ_PK ELSE SP1.SP_CODE_SQ_PK END AS SP1_CODE_SQ_PK,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SP2.SP_NOM ELSE SP1.SP_NOM END AS SP1_NOM,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SAC2.SAC_CODE_SQ_PK ELSE SAC1.SAC_CODE_SQ_PK END AS SAC1_CODE_SQ_PK,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SAC2.SAC_NOM ELSE SAC1.SAC_NOM END AS SAC1_NOM,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SP1.SP_CIPUCD ELSE SP2.SP_CIPUCD END AS SP2_CIPUCD,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SP1.SP_CODE_SQ_PK ELSE SP2.SP_CODE_SQ_PK END AS SP2_CODE_SQ_PK,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SP1.SP_NOM ELSE SP2.SP_NOM END AS SP2_NOM,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SAC1.SAC_CODE_SQ_PK ELSE SAC2.SAC_CODE_SQ_PK END AS SAC2_CODE_SQ_PK,
      CASE WHEN SP1.SP_CODE_SQ_PK > SP2.SP_CODE_SQ_PK THEN SAC1.SAC_NOM ELSE SAC2.SAC_NOM END AS SAC2_NOM,
      FITNA.FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU_INTERACTION, CDFNA.CDF_NOM AS NOM_NIVEAU
      FROM FIT_FICHEINTERAC FIT
      JOIN IT1SP_TERME1SPECIALITE IT1SP ON IT1SP.IT1SP_FIT_CODE_FK_PK = FIT.FIT_CODE_SQ_PK
      JOIN SP_SPECIALITE SP1 ON SP1.SP_CODE_SQ_PK = IT1SP.IT1SP_SP_CODE_FK_PK
      JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
      JOIN IT2SP_TERME2SPECIALITE IT2SP ON (IT2SP.IT2SP_FIT_CODE_FK_PK = FIT.FIT_CODE_SQ_PK
        AND IT1SP.IT1SP_FIT_CODE_FK_PK = IT2SP.IT2SP_FIT_CODE_FK_PK)
      JOIN SP_SPECIALITE SP2 ON SP2.SP_CODE_SQ_PK = IT2SP.IT2SP_SP_CODE_FK_PK
      JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
      JOIN FITNA_INTERACTION_NATURE FITNA ON (FITNA.FITNA_FIT_CODE_FK_PK = FIT.FIT_CODE_SQ_PK)
      JOIN CDF_CODIF CDFNA ON (CDFNA.CDF_CODE_PK = FITNA.FITNA_CDF_NAIT_CODE_FK_PK
        AND CDFNA.CDF_NUMERO_PK = ''''IN'''')
	  LEFT JOIN FITTER_TERRAINFAVORISANT FITTER ON (FITTER.FITTER_FIT_CODE_FK_PK = FIT.FIT_CODE_SQ_PK)
      LEFT JOIN CIM10V2 CIM ON (CIM.ID = FITTER.FITTER_CIM_TER_CODE_FK_PK )
      WHERE SP1.SP_CODE_SQ_PK IN (''||LISTID||'')
      AND SP2.SP_CODE_SQ_PK IN (''||LISTID||'')
      AND SP1.SP_CODE_SQ_PK != SP2.SP_CODE_SQ_PK'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API INTERACTION MEDICAMENT VIRTUEL
-- EXEMPLE: LISTID := '1198,2602,6187' ET TYPID := 1

-- DROP FUNCTION GET_THE_INTER_GSP_SAC(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INTER_GSP_SAC (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FIT.FIT_CODE_SQ_PK AS FIT_CODE_SQ_PK, GSP1.GSP_CODE_SQ_PK AS GSP1_CODE, GSP1.GSP_NOM AS GSP1_NOM, SAC1.SAC_CODE_SQ_PK AS SAC1_CODE_SQ_PK, SAC1.SAC_NOM AS SAC1_NOM,
      GSP2.GSP_CODE_SQ_PK AS GSP2_CODE, GSP2.GSP_NOM AS GSP2_NOM, SAC2.SAC_CODE_SQ_PK AS SAC2_CODE_SQ_PK, SAC2.SAC_NOM AS SAC2_NOM, FITNA.FITNA_CDF_NAIT_CODE_FK_PK AS NIVEAU_INTERACTION, CDFNA.CDF_NOM AS NOM_NIVEAU
      FROM FIT_FICHEINTERAC FIT
      JOIN IT1SP_TERME1SPECIALITE IT1SP ON IT1SP.IT1SP_FIT_CODE_FK_PK = FIT.FIT_CODE_SQ_PK
      JOIN SP_SPECIALITE SP1 ON SP1.SP_CODE_SQ_PK = IT1SP.IT1SP_SP_CODE_FK_PK
      JOIN GSP_GENERIQUE_SPECIALITE GSP1 ON (GSP1.GSP_CODE_SQ_PK = SP1.SP_GSP_CODE_FK
        AND GSP1.GSP_NB_SUB < 4)
      JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
      JOIN IT2SP_TERME2SPECIALITE IT2SP ON (IT2SP.IT2SP_FIT_CODE_FK_PK = FIT.FIT_CODE_SQ_PK
        AND IT1SP.IT1SP_FIT_CODE_FK_PK = IT2SP.IT2SP_FIT_CODE_FK_PK)
      JOIN SP_SPECIALITE SP2 ON SP2.SP_CODE_SQ_PK = IT2SP.IT2SP_SP_CODE_FK_PK
      JOIN GSP_GENERIQUE_SPECIALITE GSP2 ON (GSP2.GSP_CODE_SQ_PK = SP2.SP_GSP_CODE_FK
        AND GSP2.GSP_NB_SUB < 4)
      JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
      JOIN FITNA_INTERACTION_NATURE FITNA ON (FITNA.FITNA_FIT_CODE_FK_PK = FIT.FIT_CODE_SQ_PK)
      JOIN CDF_CODIF CDFNA ON (CDFNA.CDF_CODE_PK = FITNA.FITNA_CDF_NAIT_CODE_FK_PK
        AND CDFNA.CDF_NUMERO_PK = ''''IN'''')
      WHERE GSP1.GSP_CODE_SQ_PK IN (''||LISTID||'')
      AND GSP2.GSP_CODE_SQ_PK IN (''||LISTID||'')
      AND GSP1.GSP_CODE_SQ_PK != GSP2.GSP_CODE_SQ_PK'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API INCOMPATIBILITE
-- EXEMPLE: LISTID := '5762,11898,4679,7431'

-- DROP FUNCTION GET_THE_INCOMPAT_SPE_SAC(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INCOMPAT_SPE_SAC (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FIC.FIC_CODE_SQ_PK AS FIC_CODE_SQ_PK, SP1.SP_CIPUCD AS SP1_CIPUCD, SP1.SP_CODE_SQ_PK AS SP1_CODE_SQ_PK, SP1.SP_NOM AS SP1_NOM, SAC1.SAC_CODE_SQ_PK AS SAC1_CODE_SQ_PK, SAC1.SAC_NOM AS SAC1_NOM,
      SP2.SP_CIPUCD AS SP2_CIPUCD, SP2.SP_CODE_SQ_PK AS SP2_CODE_SQ_PK, SP2.SP_NOM AS SP2_NOM, SAC2.SAC_CODE_SQ_PK AS SAC2_CODE_SQ_PK, SAC2.SAC_NOM AS SAC2_NOM, FIC.FIC_TYPE AS COMPATIBILITE, CDF1.CDF_NOM AS COMMENTAIRE1, CDF2.CDF_NOM AS COMMENTAIRE2
      FROM FIC_INCOMPATIBILITE FIC
      JOIN IC1SP_TERME1SPECIALITE IC1SP ON IC1SP.IC1SP_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
      JOIN SP_SPECIALITE SP1 ON SP1.SP_CODE_SQ_PK = IC1SP.IC1SP_SP_CODE_FK_PK
      JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
      JOIN IC1VE_INCOMPATIBILITE_VECTEUR1 IC1VE ON IC1VE.IC1VE_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
      JOIN CDF_CODIF CDF1 ON (CDF1.CDF_CODE_PK = IC1VE.IC1VE_CDF_VEIC_CODE_FK_PK
        AND CDF1.CDF_NUMERO_PK = ''''MV'''')
      JOIN IC2SP_TERME2SPECIALITE IC2SP ON (IC2SP.IC2SP_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
        AND IC1SP.IC1SP_FIC_CODE_FK_PK = IC2SP.IC2SP_FIC_CODE_FK_PK)
      JOIN SP_SPECIALITE SP2 ON SP2.SP_CODE_SQ_PK = IC2SP.IC2SP_SP_CODE_FK_PK
      JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
      LEFT JOIN IC2VE_INCOMPATIBILITE_VECTEUR2 IC2VE ON IC2VE.IC2VE_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
      LEFT JOIN CDF_CODIF CDF2 ON (CDF2.CDF_CODE_PK = IC2VE.IC2VE_CDF_VEIC_CODE_FK_PK
        AND CDF2.CDF_NUMERO_PK = ''''MV'''')
      WHERE SP1.SP_CODE_SQ_PK IN (''||LISTID||'')
      AND SP2.SP_CODE_SQ_PK IN (''||LISTID||'')'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API INCOMPATIBILITE GSP
-- EXEMPLE: LISTID := '1167,2111'

-- DROP FUNCTION GET_THE_INCOMPAT_GSP_SAC(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INCOMPAT_GSP_SAC (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT FIC.FIC_CODE_SQ_PK AS FIC_CODE_SQ_PK, GSP1.GSP_CODE_SQ_PK AS GSP1_CODE, GSP1.GSP_NOM AS GSP1_NOM, SAC1.SAC_CODE_SQ_PK AS SAC1_CODE_SQ_PK, SAC1.SAC_NOM AS SAC1_NOM,
      GSP2.GSP_CODE_SQ_PK AS GSP2_CODE, GSP2.GSP_NOM AS GSP2_NOM, SAC2.SAC_CODE_SQ_PK AS SAC2_CODE_SQ_PK, SAC2.SAC_NOM AS SAC2_NOM, FIC.FIC_TYPE AS COMPATIBILITE, CDF1.CDF_NOM AS COMMENTAIRE1, CDF2.CDF_NOM AS COMMENTAIRE2
      FROM FIC_INCOMPATIBILITE FIC
      JOIN IC1SP_TERME1SPECIALITE IC1SP ON IC1SP.IC1SP_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
      JOIN SP_SPECIALITE SP1 ON SP1.SP_CODE_SQ_PK = IC1SP.IC1SP_SP_CODE_FK_PK
      JOIN GSP_GENERIQUE_SPECIALITE GSP1 ON (GSP1.GSP_CODE_SQ_PK = SP1.SP_GSP_CODE_FK
        AND GSP1.GSP_NB_SUB < 4)
      JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP1.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
      JOIN IC1VE_INCOMPATIBILITE_VECTEUR1 IC1VE ON IC1VE.IC1VE_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
      JOIN CDF_CODIF CDF1 ON (CDF1.CDF_CODE_PK = IC1VE.IC1VE_CDF_VEIC_CODE_FK_PK
        AND CDF1.CDF_NUMERO_PK = ''''MV'''')
      JOIN IC2SP_TERME2SPECIALITE IC2SP ON (IC2SP.IC2SP_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
        AND IC1SP.IC1SP_FIC_CODE_FK_PK = IC2SP.IC2SP_FIC_CODE_FK_PK)
      JOIN SP_SPECIALITE SP2 ON SP2.SP_CODE_SQ_PK = IC2SP.IC2SP_SP_CODE_FK_PK
      JOIN GSP_GENERIQUE_SPECIALITE GSP2 ON (GSP2.GSP_CODE_SQ_PK = SP2.SP_GSP_CODE_FK
        AND GSP2.GSP_NB_SUB < 4)
      JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
      JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
      JOIN IC2VE_INCOMPATIBILITE_VECTEUR2 IC2VE ON IC2VE.IC2VE_FIC_CODE_FK_PK = FIC.FIC_CODE_SQ_PK
      JOIN CDF_CODIF CDF2 ON (CDF2.CDF_CODE_PK = IC2VE.IC2VE_CDF_VEIC_CODE_FK_PK
        AND CDF2.CDF_NUMERO_PK = ''''MV'''')
      WHERE GSP1.GSP_CODE_SQ_PK IN (''||LISTID||'')
      AND GSP2.GSP_CODE_SQ_PK IN (''||LISTID||'')'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API PSO
-- EXEMPLE ID : '4519,3671,8932,22169,427,5762,11898' POUR ADULTE ET '8662,6519,6199,11965,4245,11217' POUR ENFANT

-- DROP FUNCTION GET_THE_PSO_MM_BY_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PSO_MM_BY_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, ''''AGE'''' AS CRITERE, NAT.PSO_NAT_POSO_NAME AS POSO_NAME,
  CASE
    WHEN PSO.PSO_NAT_POSO_ID = 0 THEN ''''MIN''''
    ELSE ''''MAX''''
  END AS MIN_MAX,
  CASE
    WHEN UPPER(NAT.PSO_NAT_POSO_NAME_SH) LIKE ''''%ENFANT%'''' THEN ''''ENF''''
    ELSE ''''AD''''
  END AS NATURE, 
PSO.PSO_POS_V_MIN AS BORNE_MIN, COALESCE(V_MIN.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MIN,
PSO.PSO_POS_V_MAX AS BORNE_MAX, COALESCE(V_MAX.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MAX,
PSO.PSO_POS_V_PDS AS PAR_MASSE, COALESCE(U_PDS.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_PDS,
PSO.PSO_VAL_UNIT_ADM AS PAR_ADM, COALESCE(U_ADM.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_ADM,
PSO.PSO_POS_V_AREA AS PAR_M2, COALESCE(U_AREA.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_AREA,
NAT.PSO_NAT_POSO_COM AS INFO,
CASE
  WHEN NAT.PSO_NAT_AGE_B_MIN = 0 THEN ''''AGE < ''''
  ELSE ''''AGE '''' || NAT.PSO_NAT_AGE_B_MIN || '''' Jour(s)''''
END AS B_MIN,
CASE
  WHEN NAT.PSO_NAT_AGE_B_MAX = 0 THEN ''''AGE < ''''
  ELSE ''''AGE '''' || NAT.PSO_NAT_AGE_B_MAX || '''' Jour(s)''''
END AS B_MAX
FROM SP_SPECIALITE SP
JOIN PSO_SP_POSO PSO ON PSO.PSO_SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
-- BORNE MIN
LEFT JOIN PSO_UNIT V_MIN ON (V_MIN.PSO_UNIT_PK = PSO_UNIT_MIN)
-- BORNE MAX
LEFT JOIN PSO_UNIT V_MAX ON (V_MAX.PSO_UNIT_PK = PSO_UNIT_MAX)
-- IND POIDS
LEFT JOIN PSO_UNIT U_PDS ON (U_PDS.PSO_UNIT_PK = PSO_UNIT_PDS)
-- IND ADMINISTRATION
LEFT JOIN PSO_UNIT U_ADM ON (U_ADM.PSO_UNIT_PK = PSO_UNIT_ADM)
-- IND SURFACE C.
LEFT JOIN PSO_UNIT U_AREA ON (U_AREA.PSO_UNIT_PK = PSO_UNIT_AREA),
PSO_TYPE_POSO NAT
-- WHERE NAT.PSO_NAT_POSO_ID > 0
-- AND 21900 BETWEEN NAT.PSO_NAT_AGE_B_MIN AND NAT.PSO_NAT_AGE_B_MAX
-- AND PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
WHERE PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
AND NAT.PSO_NAT_AGE_B_MIN IS NOT NULL
AND NAT.PSO_NAT_AGE_B_MAX IS NOT NULL
AND (NAT.PSO_NAT_AGE_B_MIN != 0 OR NAT.PSO_NAT_AGE_B_MAX != 0)
AND PSO.PSO_SP_CODE_SQ_PK IN (''||LISTID||'')
UNION
SELECT DISTINCT SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, ''''POIDS'''' AS CRITERE, NAT.PSO_NAT_POSO_NAME AS POSO_NAME,
  CASE
    WHEN PSO.PSO_NAT_POSO_ID = 0 THEN ''''MIN''''
    ELSE ''''MAX''''
  END AS MIN_MAX,
  CASE
    WHEN UPPER(NAT.PSO_NAT_POSO_NAME_SH) LIKE ''''%ENFANT%'''' THEN ''''ENF''''
    ELSE ''''AD''''
  END AS NATURE, 
PSO.PSO_POS_V_MIN AS BORNE_MIN, COALESCE(V_MIN.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MIN,
PSO.PSO_POS_V_MAX AS BORNE_MAX, COALESCE(V_MAX.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MAX,
PSO.PSO_POS_V_PDS AS PAR_MASSE, COALESCE(U_PDS.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_PDS,
PSO.PSO_VAL_UNIT_ADM AS PAR_ADM, COALESCE(U_ADM.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_ADM,
PSO.PSO_POS_V_AREA AS PAR_M2, COALESCE(U_AREA.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_AREA,
NAT.PSO_NAT_POSO_COM AS INFO,
CASE
  WHEN NAT.PSO_NAT_PDS_B_MIN = 0 THEN ''''POIDS < ''''
  ELSE NAT.PSO_NAT_PDS_B_MIN || '''' KG''''
END AS B_MIN,
CASE
  WHEN NAT.PSO_NAT_PDS_B_MAX = 0 THEN ''''POIDS < ''''
  ELSE NAT.PSO_NAT_PDS_B_MAX || '''' KG''''
END AS B_MAX
FROM SP_SPECIALITE SP
JOIN PSO_SP_POSO PSO ON PSO.PSO_SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
-- BORNE MIN
LEFT JOIN PSO_UNIT V_MIN ON (V_MIN.PSO_UNIT_PK = PSO_UNIT_MIN)
-- BORNE MAX
LEFT JOIN PSO_UNIT V_MAX ON (V_MAX.PSO_UNIT_PK = PSO_UNIT_MAX)
-- IND POIDS
LEFT JOIN PSO_UNIT U_PDS ON (U_PDS.PSO_UNIT_PK = PSO_UNIT_PDS)
-- IND ADMINISTRATION
LEFT JOIN PSO_UNIT U_ADM ON (U_ADM.PSO_UNIT_PK = PSO_UNIT_ADM)
-- IND SURFACE C.
LEFT JOIN PSO_UNIT U_AREA ON (U_AREA.PSO_UNIT_PK = PSO_UNIT_AREA),
PSO_TYPE_POSO NAT
-- WHERE NAT.PSO_NAT_POSO_ID > 0
-- AND 32 BETWEEN NAT.PSO_NAT_PDS_B_MIN AND NAT.PSO_NAT_PDS_B_MAX
-- AND PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
WHERE PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
AND NAT.PSO_NAT_PDS_B_MIN IS NOT NULL
AND NAT.PSO_NAT_PDS_B_MAX IS NOT NULL
AND (NAT.PSO_NAT_PDS_B_MIN != 0 OR NAT.PSO_NAT_PDS_B_MAX != 0)
AND PSO.PSO_SP_CODE_SQ_PK IN (''||LISTID||'')
UNION
SELECT DISTINCT SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, ''''SURFACE'''' AS CRITERE, NAT.PSO_NAT_POSO_NAME AS POSO_NAME,
  CASE
    WHEN PSO.PSO_NAT_POSO_ID = 0 THEN ''''MIN''''
    ELSE ''''MAX''''
  END AS MIN_MAX, 
  CASE
    WHEN UPPER(NAT.PSO_NAT_POSO_NAME_SH) LIKE ''''%ENFANT%'''' THEN ''''ENF''''
    ELSE ''''AD''''
  END AS NATURE, 
PSO.PSO_POS_V_MIN AS BORNE_MIN, COALESCE(V_MIN.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MIN,
PSO.PSO_POS_V_MAX AS BORNE_MAX, COALESCE(V_MAX.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MAX,
PSO.PSO_POS_V_PDS AS PAR_MASSE, COALESCE(U_PDS.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_PDS,
PSO.PSO_VAL_UNIT_ADM AS PAR_ADM, COALESCE(U_ADM.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_ADM,
PSO.PSO_POS_V_AREA AS PAR_M2, COALESCE(U_AREA.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_AREA,
NAT.PSO_NAT_POSO_COM AS INFO,
CASE
  WHEN NAT.PSO_NAT_AREA_B_MIN = 0 THEN ''''SURFACE < ''''
  ELSE NAT.PSO_NAT_AREA_B_MIN || '''' M2''''
END AS B_MIN,
CASE
  WHEN NAT.PSO_NAT_AREA_B_MAX = 0 THEN ''''SURFACE < ''''
  ELSE NAT.PSO_NAT_AREA_B_MAX || '''' M2''''
END AS B_MAX
FROM SP_SPECIALITE SP
JOIN PSO_SP_POSO PSO ON PSO.PSO_SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
-- BORNE MIN
LEFT JOIN PSO_UNIT V_MIN ON (V_MIN.PSO_UNIT_PK = PSO_UNIT_MIN)
-- BORNE MAX
LEFT JOIN PSO_UNIT V_MAX ON (V_MAX.PSO_UNIT_PK = PSO_UNIT_MAX)
-- IND POIDS
LEFT JOIN PSO_UNIT U_PDS ON (U_PDS.PSO_UNIT_PK = PSO_UNIT_PDS)
-- IND ADMINISTRATION
LEFT JOIN PSO_UNIT U_ADM ON (U_ADM.PSO_UNIT_PK = PSO_UNIT_ADM)
-- IND SURFACE C.
LEFT JOIN PSO_UNIT U_AREA ON (U_AREA.PSO_UNIT_PK = PSO_UNIT_AREA),
PSO_TYPE_POSO NAT
-- WHERE NAT.PSO_NAT_POSO_ID > 0
-- AND (0.9 BETWEEN NAT.PSO_NAT_AREA_B_MIN AND NAT.PSO_NAT_AREA_B_MAX OR (NAT.PSO_NAT_AREA_B_MIN = 1 AND NAT.PSO_NAT_AREA_B_MAX = 1))
-- AND PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
WHERE PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
AND NAT.PSO_NAT_AREA_B_MIN IS NOT NULL
AND NAT.PSO_NAT_AREA_B_MAX IS NOT NULL
AND (NAT.PSO_NAT_AREA_B_MIN != 0 OR NAT.PSO_NAT_AREA_B_MAX != 0)
AND PSO.PSO_SP_CODE_SQ_PK IN (''||LISTID||'')
ORDER BY MIN_MAX, SP_CODE'';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GSP, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, ''''AGE'''' AS CRITERE, NAT.PSO_NAT_POSO_NAME AS POSO_NAME,
  CASE
    WHEN PSO.PSO_NAT_POSO_ID = 0 THEN ''''MIN''''
    ELSE ''''MAX''''
  END AS MIN_MAX,
  CASE
    WHEN UPPER(NAT.PSO_NAT_POSO_NAME_SH) LIKE ''''%ENFANT%'''' THEN ''''ENF''''
    ELSE ''''AD''''
  END AS NATURE, 
PSO.PSO_POS_V_MIN AS BORNE_MIN, COALESCE(V_MIN.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MIN,
PSO.PSO_POS_V_MAX AS BORNE_MAX, COALESCE(V_MAX.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MAX,
PSO.PSO_POS_V_PDS AS PAR_MASSE, COALESCE(U_PDS.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_PDS,
PSO.PSO_VAL_UNIT_ADM AS PAR_ADM, COALESCE(U_ADM.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_ADM,
PSO.PSO_POS_V_AREA AS PAR_M2, COALESCE(U_AREA.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_AREA,
NAT.PSO_NAT_POSO_COM AS INFO,
CASE
  WHEN NAT.PSO_NAT_AGE_B_MIN = 0 THEN ''''AGE < ''''
  ELSE ''''AGE '''' || NAT.PSO_NAT_AGE_B_MIN || '''' Jour(s)''''
END AS B_MIN,
CASE
  WHEN NAT.PSO_NAT_AGE_B_MAX = 0 THEN ''''AGE < ''''
  ELSE ''''AGE '''' || NAT.PSO_NAT_AGE_B_MAX || '''' Jour(s)''''
END AS B_MAX
FROM GSP_GENERIQUE_SPECIALITE GSP
JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
  AND GSP.GSP_NB_SUB < 4)
JOIN PSO_SP_POSO PSO ON PSO.PSO_SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
-- BORNE MIN
LEFT JOIN PSO_UNIT V_MIN ON (V_MIN.PSO_UNIT_PK = PSO_UNIT_MIN)
-- BORNE MAX
LEFT JOIN PSO_UNIT V_MAX ON (V_MAX.PSO_UNIT_PK = PSO_UNIT_MAX)
-- IND POIDS
LEFT JOIN PSO_UNIT U_PDS ON (U_PDS.PSO_UNIT_PK = PSO_UNIT_PDS)
-- IND ADMINISTRATION
LEFT JOIN PSO_UNIT U_ADM ON (U_ADM.PSO_UNIT_PK = PSO_UNIT_ADM)
-- IND SURFACE C.
LEFT JOIN PSO_UNIT U_AREA ON (U_AREA.PSO_UNIT_PK = PSO_UNIT_AREA),
PSO_TYPE_POSO NAT
-- WHERE NAT.PSO_NAT_POSO_ID > 0
-- AND 21900 BETWEEN NAT.PSO_NAT_AGE_B_MIN AND NAT.PSO_NAT_AGE_B_MAX
-- AND PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
WHERE PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
AND NAT.PSO_NAT_AGE_B_MIN IS NOT NULL
AND NAT.PSO_NAT_AGE_B_MAX IS NOT NULL
AND (NAT.PSO_NAT_AGE_B_MIN != 0 OR NAT.PSO_NAT_AGE_B_MAX != 0)
AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
UNION
SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GSP, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, ''''POIDS'''' AS CRITERE, NAT.PSO_NAT_POSO_NAME AS POSO_NAME,
  CASE
    WHEN PSO.PSO_NAT_POSO_ID = 0 THEN ''''MIN''''
    ELSE ''''MAX''''
  END AS MIN_MAX,
  CASE
    WHEN UPPER(NAT.PSO_NAT_POSO_NAME_SH) LIKE ''''%ENFANT%'''' THEN ''''ENF''''
    ELSE ''''AD''''
  END AS NATURE, 
PSO.PSO_POS_V_MIN AS BORNE_MIN, COALESCE(V_MIN.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MIN,
PSO.PSO_POS_V_MAX AS BORNE_MAX, COALESCE(V_MAX.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MAX,
PSO.PSO_POS_V_PDS AS PAR_MASSE, COALESCE(U_PDS.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_PDS,
PSO.PSO_VAL_UNIT_ADM AS PAR_ADM, COALESCE(U_ADM.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_ADM,
PSO.PSO_POS_V_AREA AS PAR_M2, COALESCE(U_AREA.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_AREA,
NAT.PSO_NAT_POSO_COM AS INFO,
CASE
  WHEN NAT.PSO_NAT_PDS_B_MIN = 0 THEN ''''POIDS < ''''
  ELSE NAT.PSO_NAT_PDS_B_MIN || '''' KG''''
END AS B_MIN,
CASE
  WHEN NAT.PSO_NAT_PDS_B_MAX = 0 THEN ''''POIDS < ''''
  ELSE NAT.PSO_NAT_PDS_B_MAX || '''' KG''''
END AS B_MAX
FROM GSP_GENERIQUE_SPECIALITE GSP
JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
  AND GSP.GSP_NB_SUB < 4)
JOIN PSO_SP_POSO PSO ON PSO.PSO_SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
-- BORNE MIN
LEFT JOIN PSO_UNIT V_MIN ON (V_MIN.PSO_UNIT_PK = PSO_UNIT_MIN)
-- BORNE MAX
LEFT JOIN PSO_UNIT V_MAX ON (V_MAX.PSO_UNIT_PK = PSO_UNIT_MAX)
-- IND POIDS
LEFT JOIN PSO_UNIT U_PDS ON (U_PDS.PSO_UNIT_PK = PSO_UNIT_PDS)
-- IND ADMINISTRATION
LEFT JOIN PSO_UNIT U_ADM ON (U_ADM.PSO_UNIT_PK = PSO_UNIT_ADM)
-- IND SURFACE C.
LEFT JOIN PSO_UNIT U_AREA ON (U_AREA.PSO_UNIT_PK = PSO_UNIT_AREA),
PSO_TYPE_POSO NAT
-- WHERE NAT.PSO_NAT_POSO_ID > 0
-- AND 32 BETWEEN NAT.PSO_NAT_PDS_B_MIN AND NAT.PSO_NAT_PDS_B_MAX
-- AND PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
WHERE PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
AND NAT.PSO_NAT_PDS_B_MIN IS NOT NULL
AND NAT.PSO_NAT_PDS_B_MAX IS NOT NULL
AND (NAT.PSO_NAT_PDS_B_MIN != 0 OR NAT.PSO_NAT_PDS_B_MAX != 0)
AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
UNION
SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS CODE_GSP, GSP.GSP_NOM AS NOM_GSP, SP.SP_CODE_SQ_PK AS SP_CODE, SP.SP_NOM AS SP_NOM, ''''SURFACE'''' AS CRITERE, NAT.PSO_NAT_POSO_NAME AS POSO_NAME,
  CASE
    WHEN PSO.PSO_NAT_POSO_ID = 0 THEN ''''MIN''''
    ELSE ''''MAX''''
  END AS MIN_MAX, 
  CASE
    WHEN UPPER(NAT.PSO_NAT_POSO_NAME_SH) LIKE ''''%ENFANT%'''' THEN ''''ENF''''
    ELSE ''''AD''''
  END AS NATURE, 
PSO.PSO_POS_V_MIN AS BORNE_MIN, COALESCE(V_MIN.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MIN,
PSO.PSO_POS_V_MAX AS BORNE_MAX, COALESCE(V_MAX.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_MAX,
PSO.PSO_POS_V_PDS AS PAR_MASSE, COALESCE(U_PDS.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_PDS,
PSO.PSO_VAL_UNIT_ADM AS PAR_ADM, COALESCE(U_ADM.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_ADM,
PSO.PSO_POS_V_AREA AS PAR_M2, COALESCE(U_AREA.PSO_UNIT_NAME_SH, ''''NA'''') AS UNIT_AREA,
NAT.PSO_NAT_POSO_COM AS INFO,
CASE
  WHEN NAT.PSO_NAT_AREA_B_MIN = 0 THEN ''''SURFACE < ''''
  ELSE NAT.PSO_NAT_AREA_B_MIN || '''' M2''''
END AS B_MIN,
CASE
  WHEN NAT.PSO_NAT_AREA_B_MAX = 0 THEN ''''SURFACE < ''''
  ELSE NAT.PSO_NAT_AREA_B_MAX || '''' M2''''
END AS B_MAX
FROM GSP_GENERIQUE_SPECIALITE GSP
JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
  AND GSP.GSP_NB_SUB < 4)
JOIN PSO_SP_POSO PSO ON PSO.PSO_SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
-- BORNE MIN
LEFT JOIN PSO_UNIT V_MIN ON (V_MIN.PSO_UNIT_PK = PSO_UNIT_MIN)
-- BORNE MAX
LEFT JOIN PSO_UNIT V_MAX ON (V_MAX.PSO_UNIT_PK = PSO_UNIT_MAX)
-- IND POIDS
LEFT JOIN PSO_UNIT U_PDS ON (U_PDS.PSO_UNIT_PK = PSO_UNIT_PDS)
-- IND ADMINISTRATION
LEFT JOIN PSO_UNIT U_ADM ON (U_ADM.PSO_UNIT_PK = PSO_UNIT_ADM)
-- IND SURFACE C.
LEFT JOIN PSO_UNIT U_AREA ON (U_AREA.PSO_UNIT_PK = PSO_UNIT_AREA),
PSO_TYPE_POSO NAT
-- WHERE NAT.PSO_NAT_POSO_ID > 0
-- AND (0.9 BETWEEN NAT.PSO_NAT_AREA_B_MIN AND NAT.PSO_NAT_AREA_B_MAX OR (NAT.PSO_NAT_AREA_B_MIN = 1 AND NAT.PSO_NAT_AREA_B_MAX = 1))
-- AND PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
WHERE PSO.PSO_NAT_POSO_ID = NAT.PSO_NAT_POSO_ID
AND NAT.PSO_NAT_AREA_B_MIN IS NOT NULL
AND NAT.PSO_NAT_AREA_B_MAX IS NOT NULL
AND (NAT.PSO_NAT_AREA_B_MIN != 0 OR NAT.PSO_NAT_AREA_B_MAX != 0)
AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
ORDER BY MIN_MAX, SP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE plpgsql;


 -- 2017-06-27 : AJOUT API ANTIBIOTIQUE VOIE LOCALE
 -- EXEMPLE: LISTID := '7690,541' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANTIBIO_LOC_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 00 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANTIBIOTIQUE_LOC
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS STUP
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        )
        ORDER BY ANTIBIOTIQUE_LOC DESC, SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANTIBIOTIQUE_LOC
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS STUP
        FROM SP_SPECIALITE SPN
        WHERE (SPN.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SPN.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        )
        ORDER BY ANTIBIOTIQUE_LOC DESC, SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API ANTIBIOTIQUES SPE SYSTEMIQUE
  -- EXEMPLE: LISTID := '3,9075123,40187' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANTIBIO_SYST_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 00 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANTIBIOTIQUE_SYST
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS STUP
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        )
        ORDER BY ANTIBIOTIQUE_SYST DESC, SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANTIBIOTIQUE_SYST
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS STUP
        FROM SP_SPECIALITE SPN
        WHERE (SPN.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SPN.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        )
        ORDER BY ANTIBIOTIQUE_SYST DESC, SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API ANTIBIOTIQUES GSP USAGE LOCAL
  -- EXEMPLE: LISTID := '7335,2851,2855,2843,260' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANTIBIO_LOC_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 00 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANTIBIOTIQUE_LOC
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        )
        ORDER BY ANTIBIOTIQUE_LOC DESC, GSP_CODE'';
  END IF;
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANTIBIOTIQUE_LOC
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZE'''')
        )
        ORDER BY ANTIBIOTIQUE_LOC DESC, GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API ANTIBIOTIQUES GSP USAGE SYSTEMIQUE
  -- EXEMPLE: LISTID := '35,73,8202' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANTIBIO_SYST_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 00 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANTIBIOTIQUE_SYST
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        )
        ORDER BY ANTIBIOTIQUE_SYST DESC, GSP_CODE'';
  END IF;
  IF TYPID = 01 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANTIBIOTIQUE_SYST
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS STUP
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM THESORIMED.ATC_CPH where CPH_CODE_FK_PK = ''''ZZH'''')
        )
        ORDER BY ANTIBIOTIQUE_SYST DESC, GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API HYPNOTIQUES SPE
-- EXEMPLE: LISTID := 9428231,1008 ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_HYPNO_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS HYPNOTIQUE
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS HYPNOTIQUE
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        )
        ORDER BY HYPNOTIQUE desc, SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS HYPNOTIQUE
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS HYPNOTIQUE
        FROM SP_SPECIALITE SPN
        WHERE (SPN.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SPN.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        )
        ORDER BY HYPNOTIQUE desc, SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API HYPNOTIQUES GSP
-- EXEMPLE: LISTID := 1167,989 ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_HYPNO_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS HYPNOTIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS HYPNOTIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        )
        ORDER BY HYPNOTIQUE desc, GSP_CODE'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS HYPNOTIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS HYPNOTIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZC'''')
        )
        ORDER BY HYPNOTIQUE desc, GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


  -- API ANXIOLITIQUES SPE
  -- EXEMPLE: LISTID := '15,9123342,40183' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANXIO_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANXIOLITIQUE
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS ANXIOLITIQUE
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        )
        ORDER BY ANXIOLITIQUE desc, SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANXIOLITIQUE
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS ANXIOLITIQUE
        FROM SP_SPECIALITE SPN
        WHERE (SPN.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SPN.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        )
        ORDER BY ANXIOLITIQUE desc, SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API ANXIOLITIQUES GSP
  -- EXEMPLE: LISTID := '15,1192,373' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANXIO_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANXIOLITIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS ANXIOLITIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        )
        ORDER BY ANXIOLITIQUE desc, GSP_CODE'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANXIOLITIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS ANXIOLITIQUE
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZD'''')
        )
        ORDER BY ANXIOLITIQUE desc, GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API ANTICANCEREUX SPE
-- EXEMPLE: LISTID := 9124904,9153403,40176 ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANTICANC_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANTICANCEREUX
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS ANTICANCEREUX
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        )
        ORDER BY ANTICANCEREUX DESC, SP_CODE_SQ_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS ANTICANCEREUX
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS ANTICANCEREUX
        FROM SP_SPECIALITE SPN
        WHERE (SPN.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SPN.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        )
        ORDER BY ANTICANCEREUX DESC, SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API ANTICANCEREUX GSP
  -- EXEMPLE: LISTID := '182,1062,8201' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_ANTICANC_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANTICANCEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS ANTICANCEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        AND   SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        )
        ORDER BY ANTICANCEREUX DESC, GSP_CODE'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS ANTICANCEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        UNION
        SELECT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS ANTICANCEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZI'''')
        )
        ORDER BY ANTICANCEREUX DESC, GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API INDEXATION VACCINS SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_INDEX_VACC(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INDEX_VACC (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT
          SP.SP_CIPUCD        AS CIPUCD,
          SP.SP_CODE_SQ_PK    AS SP_CODE_SQ_PK,
          SP.SP_NOM           AS SP_NOM,
          CPH.CPH_CODE_PK     AS CPH_CODE,
          CPH.CPH_NOM         AS CPH_NOM,
          ETHIO.CDF_CODE_PK   AS CODE_ETHIO_HAB_SENS,
          ETHIO.CDF_NOM       AS ETHIOLOGIE_HABITU_SENSI,
          CIM10.CIM_CODE      AS CODE_CIM10,
          CIM10.CIM_LIBELLE   AS LIBELLE_CIM10
        FROM SP_SPECIALITE SP
        JOIN SPCPH_SPECIALITE_CLASSEPH SPCPH ON (SPCPH.SPCPH_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPH_CPH_CODE_FK_PK IN (''''A3R'''',''''A3S'''',''''A3T'''',''''A3U'''',''''A3V'''',''''A3W''''))
        JOIN CPH_CLASSEPHARMTHER CPH ON CPH.CPH_CODE_PK = SPCPH.SPCPH_CPH_CODE_FK_PK
        JOIN FETSP_ETIOSPE FETSP ON FETSP.FETSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FETHS_ETIOLOGIE_HABITU_SENSIB FETHS ON FETHS.FETHS_FET_CODE_FK_PK = FETSP.FETSP_FET_CODE_FK_PK
        JOIN CDF_CODIF ETHIO ON (ETHIO.CDF_CODE_PK = FETHS.FETHS_CDF_ETIN_CODE_FK_PK
          AND ETHIO.CDF_NUMERO_PK = ''''NA'''')
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON CIM10.ID = FIN.FIN_CIM_NAIN_CODE_FK_PK'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT
          SP.SP_CIPUCD        AS CIPUCD,
          SP.SP_CODE_SQ_PK    AS SP_CODE_SQ_PK,
          SP.SP_NOM           AS SP_NOM,
          CPH.CPH_CODE_PK     AS CPH_CODE,
          CPH.CPH_NOM         AS CPH_NOM,
          ETHIO.CDF_CODE_PK   AS CODE_ETHIO_HAB_SENS,
          ETHIO.CDF_NOM       AS ETHIOLOGIE_HABITU_SENSI,
          CIM10.CIM_CODE      AS CODE_CIM10,
          CIM10.CIM_LIBELLE   AS LIBELLE_CIM10
        FROM SP_SPECIALITE SP
        JOIN SPCPH_SPECIALITE_CLASSEPH SPCPH ON (SPCPH.SPCPH_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPH_CPH_CODE_FK_PK IN (''''A3R'''',''''A3S'''',''''A3T'''',''''A3U'''',''''A3V'''',''''A3W''''))
        JOIN CPH_CLASSEPHARMTHER CPH ON CPH.CPH_CODE_PK = SPCPH.SPCPH_CPH_CODE_FK_PK
        JOIN FETSP_ETIOSPE FETSP ON FETSP.FETSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FETHS_ETIOLOGIE_HABITU_SENSIB FETHS ON FETHS.FETHS_FET_CODE_FK_PK = FETSP.FETSP_FET_CODE_FK_PK
        JOIN CDF_CODIF ETHIO ON (ETHIO.CDF_CODE_PK = FETHS.FETHS_CDF_ETIN_CODE_FK_PK
          AND ETHIO.CDF_NUMERO_PK = ''''NA'''')
        JOIN FINSP_INDSPE FINSP ON FINSP.FINSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FIN_FICHEINDIC FIN ON FIN.FIN_CODE_SQ_PK = FINSP.FINSP_FIN_CODE_FK_PK
        JOIN CIM10V2 CIM10 ON CIM10.ID = FIN.FIN_CIM_NAIN_CODE_FK_PK
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API UNITE DE PRISE UCD
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_UNIT_PRISE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_UNIT_PRISE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT 
		  PRE.PRE_CODE_PK AS CODE_PRESENTATION,
		  PRECONT.PRECONT_NBCONTENANT AS NB_CONTENANT, CDF_06.CDF_NOM AS TYPE_CONTENANT, CDF_06.CDF_CODE_PK AS CODE_CONTENANT, PRECONT.PRECONT_NBCONTENANCE AS NB_CONTENANCE, CDF_20.CDF_NOM AS UNITE_CONTENANCE, CDF_20.CDF_CODE_PK AS CODE_CONTENANCE,
		  NAT_UCD.CDF_NOM AS NATURE_UCD, PRE.PRE_NBUNITE AS NB_UNITE, CDF_06.CDF_NOM AS NOM_CONTENANT, PRE.PRE_ADMIN AS TEXTE,
		  PREDISP.PREDISP_GSAC_CODE_FK AS CODE_SAC, GSAC.GSAC_NOM AS NOM_SAC, PREDISP.PREDISP_UNITEDISP AS QTE_DISPENSATION, CDF_19.CDF_NOM AS UNITE_DISPENSATION, CDF_19.CDF_CODE_PK AS CODE_DISPENSATION,
		  PREUAEMB_NBUNITE AS NB_UA, CDF_UA.CDF_NOM AS NOM_UA, CDF_UA.CDF_CODE_PK AS CODE_UA
		FROM SP_SPECIALITE SP
		JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
		JOIN CDF_CODIF NAT_UCD ON (NAT_UCD.CDF_CODE_PK = PRE.PRE_NATUCD_CDF_CODE_FK
		  AND NAT_UCD.CDF_NUMERO_PK = PRE.PRE_NATUCD_CDF_NUM_FK)
		JOIN PRECONT_PRE_CONTENANT PRECONT ON PRECONT.PRECONT_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
		LEFT JOIN CDF_CODIF CDF_06 ON (CDF_06.CDF_CODE_PK = PRECONT.PRECONT_CDF_COCDT_CODE_FK
		  AND CDF_06.CDF_NUMERO_PK = ''''04'''')
		LEFT JOIN CDF_CODIF CDF_20 ON (CDF_20.CDF_CODE_PK = PRECONT.PRECONT_CDF_COCE_CODE_FK
		  AND CDF_20.CDF_NUMERO_PK = ''''21'''')
		LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
		LEFT JOIN GSAC_PERE_SUBACT GSAC ON GSAC.GSAC_CODE_SQ_PK = PREDISP.PREDISP_GSAC_CODE_FK
		LEFT JOIN CDF_CODIF CDF_19 ON (CDF_19.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
		  AND CDF_19.CDF_NUMERO_PK = ''''19'''')
		LEFT JOIN PREUAEMB_PRE_UAEMBALLAGE UA ON (UA.PREUAEMB_PRE_CODE_FK_PK = PRE.PRE_CODE_PK)
		LEFT JOIN CDF_CODIF CDF_UA ON (CDF_UA.CDF_CODE_PK = PREUAEMB_CDF_UAEMB_CODE_FK_PK
		  AND CDF_UA.CDF_NUMERO_PK = ''''20'''')
WHERE SP.SP_NOM NOT LIKE ''''%NC'''''';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT 
		  PRE.PRE_CODE_PK AS CODE_PRESENTATION,
		  PRECONT.PRECONT_NBCONTENANT AS NB_CONTENANT, CDF_06.CDF_NOM AS TYPE_CONTENANT, CDF_06.CDF_CODE_PK AS CODE_CONTENANT, PRECONT.PRECONT_NBCONTENANCE AS NB_CONTENANCE, CDF_20.CDF_NOM AS UNITE_CONTENANCE, CDF_20.CDF_CODE_PK AS CODE_CONTENANCE,
		  NAT_UCD.CDF_NOM AS NATURE_UCD, PRE.PRE_NBUNITE AS NB_UNITE, CDF_06.CDF_NOM AS NOM_CONTENANT, PRE.PRE_ADMIN AS TEXTE,
		  PREDISP.PREDISP_GSAC_CODE_FK AS CODE_SAC, GSAC.GSAC_NOM AS NOM_SAC, PREDISP.PREDISP_UNITEDISP AS QTE_DISPENSATION, CDF_19.CDF_NOM AS UNITE_DISPENSATION, CDF_19.CDF_CODE_PK AS CODE_DISPENSATION,
		  PREUAEMB_NBUNITE AS NB_UA, CDF_UA.CDF_NOM AS NOM_UA, CDF_UA.CDF_CODE_PK AS CODE_UA
		FROM SP_SPECIALITE SP
		JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
		JOIN CDF_CODIF NAT_UCD ON (NAT_UCD.CDF_CODE_PK = PRE.PRE_NATUCD_CDF_CODE_FK
		  AND NAT_UCD.CDF_NUMERO_PK = PRE.PRE_NATUCD_CDF_NUM_FK)
		JOIN PRECONT_PRE_CONTENANT PRECONT ON PRECONT.PRECONT_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
		LEFT JOIN CDF_CODIF CDF_06 ON (CDF_06.CDF_CODE_PK = PRECONT.PRECONT_CDF_COCDT_CODE_FK
		  AND CDF_06.CDF_NUMERO_PK = ''''04'''')
		LEFT JOIN CDF_CODIF CDF_20 ON (CDF_20.CDF_CODE_PK = PRECONT.PRECONT_CDF_COCE_CODE_FK
		  AND CDF_20.CDF_NUMERO_PK = ''''21'''')
		LEFT JOIN PREDISP_PRE_DISPENSATION PREDISP ON PREDISP.PREDISP_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
		LEFT JOIN GSAC_PERE_SUBACT GSAC ON GSAC.GSAC_CODE_SQ_PK = PREDISP.PREDISP_GSAC_CODE_FK
		LEFT JOIN CDF_CODIF CDF_19 ON (CDF_19.CDF_CODE_PK = PREDISP.PREDISP_CDF_UD_CODE_FK
		  AND CDF_19.CDF_NUMERO_PK = ''''19'''')
		LEFT JOIN PREUAEMB_PRE_UAEMBALLAGE UA ON (UA.PREUAEMB_PRE_CODE_FK_PK = PRE.PRE_CODE_PK)
		LEFT JOIN CDF_CODIF CDF_UA ON (CDF_UA.CDF_CODE_PK = PREUAEMB_CDF_UAEMB_CODE_FK_PK
		  AND CDF_UA.CDF_NUMERO_PK = ''''20'''')
WHERE SP.SP_NOM NOT LIKE ''''%NC''''
AND PRE.PRE_CODE_PK IN (''||LISTID||'')
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API MEDICAMENT D'EXCEPTION SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_MEDIC_EXCEPT_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_MEDIC_EXCEPT_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS MEDICAMENT_EXCEPTION
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
        JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
        UNION
        SELECT DISTINCT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS MEDICAMENT_EXCEPTION
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
          JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
        )
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS MEDICAMENT_EXCEPTION
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
        JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        UNION
        SELECT DISTINCT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS MEDICAMENT_EXCEPTION
        FROM SP_SPECIALITE SPN
        WHERE (SPN.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
          JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
        )
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API MEDICAMENT D'EXCEPTION GSP
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_MEDIC_EXCEPT_GSP(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_MEDIC_EXCEPT_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS MEDICAMENT_EXCEPTION
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
        JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_NB_SUB < 4
        UNION
        SELECT DISTINCT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS ANTICANCEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
          JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        )
        ORDER BY GSP_CODE'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS MEDICAMENT_EXCEPTION
        FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
        JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
        WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
        AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_NB_SUB < 4
        UNION
        SELECT DISTINCT GSPN.GSP_CODE_SQ_PK AS GSP_CODE, GSPN.GSP_NOM AS GSP_NOM, ''''N'''' AS ANTICANCEREUX
        FROM GSP_GENERIQUE_SPECIALITE GSPN
        WHERE GSPN.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSPN.GSP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT GSP.GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP, SP_SPECIALITE SP
          JOIN PRE_PRESENTATION PRE ON ( PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK )
          JOIN PRESTR_STATUT_REMBOURST STR ON ( STR.PRESTR_PRE_CODE_FK_PK = PRE.PRE_CODE_PK AND PRESTR_CDF_STR_CODE_FK_PK = ''''R1'''')
          WHERE GSP.GSP_CODE_SQ_PK = SP.SP_GSP_CODE_FK
          AND GSP.GSP_NB_SUB < 4
        )
        ORDER BY GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API COMPLEMENT DE FORME SECABLE SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_CFO_SECABLE_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_CFO_SECABLE_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS LIBELLE,
          CASE 
            WHEN CDF.CDF_CODE_PK IS NULL THEN ''''N''''
            ELSE ''''O''''
          END AS SECABILITE
        FROM SP_SPECIALITE SP
        LEFT JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON (SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK IN (14,15,78))
        LEFT JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''02'''')
        ORDER BY SP.SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS LIBELLE,
          CASE 
            WHEN CDF.CDF_CODE_PK IS NULL THEN ''''N''''
            ELSE ''''O''''
          END AS SECABILITE
        FROM SP_SPECIALITE SP
        LEFT JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON (SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK IN (14,15,78))
        LEFT JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''02'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP.SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API ADMINISTRATION FORME ORALE SOLIDE SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_ADMIN_FO_SOLIDE_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_ADMIN_FO_SOLIDE_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS ADMINISTRATION
        FROM SP_SPECIALITE SP
        JOIN FRECSP_RECONST_SPEC FRECSP ON FRECSP.FRECSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FRECCOA_FREC_COMADM FRECCOA ON (FRECCOA.FRECCOA_FREC_CODE_FK_PK = FRECSP.FRECSP_FREC_CODE_FK_PK
          AND FRECCOA.FRECCOA_CDF_COMADM_FK_PK IN (''''O18'''',''''O21'''',''''O38'''',''''O40'''',''''O43'''',''''O45'''',''''O67''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FRECCOA.FRECCOA_CDF_COMADM_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''RC'''')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS ADMINISTRATION
        FROM SP_SPECIALITE SP
        JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON (SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK IN (20,23))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''02'''')
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS ADMINISTRATION
        FROM SP_SPECIALITE SP
        JOIN FRECSP_RECONST_SPEC FRECSP ON FRECSP.FRECSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FRECCOA_FREC_COMADM FRECCOA ON (FRECCOA.FRECCOA_FREC_CODE_FK_PK = FRECSP.FRECSP_FREC_CODE_FK_PK
          AND FRECCOA.FRECCOA_CDF_COMADM_FK_PK IN (''''O18'''',''''O21'''',''''O38'''',''''O40'''',''''O43'''',''''O45'''',''''O67''''))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FRECCOA.FRECCOA_CDF_COMADM_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''RC'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS ADMINISTRATION
        FROM SP_SPECIALITE SP
        JOIN SPFOCFO_SPE_FORME_COMPFORME SPFOCFO ON (SPFOCFO.SPFOCFO_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK IN (20,23))
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPFOCFO.SPFOCFO_CDF_CFO_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''02'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API LISTE PRESCRIPTION SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_LI_PRESC_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_LI_PRESC_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS PRESCRIPTION
        FROM SP_SPECIALITE SP
        JOIN CDF_CODIF CDF ON CDF.CDF_CODE_PK = SP.SP_CDF_LI_CODE_FK
        WHERE CDF_NUMERO_PK = ''''08''''
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS PRESCRIPTION
        FROM SP_SPECIALITE SP
        JOIN CDF_CODIF CDF ON CDF.CDF_CODE_PK = SP.SP_CDF_LI_CODE_FK
        WHERE CDF_NUMERO_PK = ''''08''''
        AND (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API CONDITION D ADMINISTRATION SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_COND_ADMIN_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_COND_ADMIN_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
        CASE 
            WHEN CDF.CDF_NOM IS NULL THEN ''''''''
            ELSE CDF.CDF_NOM
          END AS ADMINISTRATION
        FROM SP_SPECIALITE SP
        LEFT JOIN FRECSP_RECONST_SPEC FRECSP ON FRECSP.FRECSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN FRECCOA_FREC_COMADM FRECCOA ON (FRECCOA.FRECCOA_FREC_CODE_FK_PK = FRECSP.FRECSP_FREC_CODE_FK_PK
          AND FRECCOA.FRECCOA_CDF_COMADM_FK_PK IN (''''M210'''',''''M211'''',''''M214'''',''''M216'''',''''M223'''',''''M224'''',''''M225'''',''''M226'''',''''M227'''',''''M228'''',''''M244'''',''''M245'''',''''M248'''',''''M253'''',''''M258'''',''''M264'''',''''M265'''',''''M266'''',''''M267'''',''''M269'''',''''M274'''',''''M275'''',''''M276'''',''''M286'''',''''M290'''',''''M291'''',''''M292'''',''''M294'''',''''M295'''',''''M298'''',''''M300'''',''''M301'''',''''M302'''',''''M303'''',''''M304'''',''''M305'''',''''M306'''',''''M307'''',''''M308'''',''''M309'''',''''M310'''',''''M312'''',''''M313'''',''''M314'''',''''M315'''',''''M317'''',''''M318'''',''''M319'''',''''M320'''',''''O'''',''''O19'''',''''O2'''',''''O20'''',''''O22'''',''''O23'''',''''O26'''',''''O29'''',''''O31'''',''''O32'''',''''O33'''',''''O36'''',''''O41'''',''''O42'''',''''O46'''',''''O47'''',''''O50'''',''''O51'''',''''O53'''',''''O54'''',''''O56'''',''''O57'''',''''O69'''',''''O7'''',''''O70'''',''''O71'''',''''O72'''',''''O73'''',''''O75'''',''''O76'''',''''O77'''',''''O78'''',''''O79'''',''''O8'''',''''O80'''',''''O81'''',''''O83'''',''''O84'''',''''O85''''))
        LEFT JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FRECCOA.FRECCOA_CDF_COMADM_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''RC'''')
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
        CASE 
            WHEN CDF.CDF_NOM IS NULL THEN ''''''''
            ELSE CDF.CDF_NOM
          END AS ADMINISTRATION
        FROM SP_SPECIALITE SP
        LEFT JOIN FRECSP_RECONST_SPEC FRECSP ON FRECSP.FRECSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN FRECCOA_FREC_COMADM FRECCOA ON (FRECCOA.FRECCOA_FREC_CODE_FK_PK = FRECSP.FRECSP_FREC_CODE_FK_PK
          AND FRECCOA.FRECCOA_CDF_COMADM_FK_PK IN (''''M210'''',''''M211'''',''''M214'''',''''M216'''',''''M223'''',''''M224'''',''''M225'''',''''M226'''',''''M227'''',''''M228'''',''''M244'''',''''M245'''',''''M248'''',''''M253'''',''''M258'''',''''M264'''',''''M265'''',''''M266'''',''''M267'''',''''M269'''',''''M274'''',''''M275'''',''''M276'''',''''M286'''',''''M290'''',''''M291'''',''''M292'''',''''M294'''',''''M295'''',''''M298'''',''''M300'''',''''M301'''',''''M302'''',''''M303'''',''''M304'''',''''M305'''',''''M306'''',''''M307'''',''''M308'''',''''M309'''',''''M310'''',''''M312'''',''''M313'''',''''M314'''',''''M315'''',''''M317'''',''''M318'''',''''M319'''',''''M320'''',''''O'''',''''O19'''',''''O2'''',''''O20'''',''''O22'''',''''O23'''',''''O26'''',''''O29'''',''''O31'''',''''O32'''',''''O33'''',''''O36'''',''''O41'''',''''O42'''',''''O46'''',''''O47'''',''''O50'''',''''O51'''',''''O53'''',''''O54'''',''''O56'''',''''O57'''',''''O69'''',''''O7'''',''''O70'''',''''O71'''',''''O72'''',''''O73'''',''''O75'''',''''O76'''',''''O77'''',''''O78'''',''''O79'''',''''O8'''',''''O80'''',''''O81'''',''''O83'''',''''O84'''',''''O85''''))
        LEFT JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FRECCOA.FRECCOA_CDF_COMADM_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''RC'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API LABORATOIRE EXPLOITANT SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_LABO_EXPLOIT_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_LABO_EXPLOIT_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS LABO_EXPLOITANT
        FROM SP_SPECIALITE SP
        LEFT JOIN SPLABEX_SPE_LABO_EXPLOITANT SPLABEX ON SPLABEX.SPLABEX_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPLABEX.SPLABEX_CDF_LAB_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''07'''')
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS LABO_EXPLOITANT
        FROM SP_SPECIALITE SP
        LEFT JOIN SPLABEX_SPE_LABO_EXPLOITANT SPLABEX ON SPLABEX.SPLABEX_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = SPLABEX.SPLABEX_CDF_LAB_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''07'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API PRODUIT DERIVE DU SANG SPE
  -- EXEMPLE: LISTID := '5202,5204' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_PR_DERIV_SANG_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS PRODUIT_DERIV_SANG
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS PRODUIT_DERIV_SANG
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP_CODE_SQ_PK
          FROM SP_SPECIALITE
          WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
        )
        ORDER BY PRODUIT_DERIV_SANG DESC, SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS PRODUIT_DERIV_SANG
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
        UNION
        SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''N'''' AS PRODUIT_DERIV_SANG
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP_CODE_SQ_PK
          FROM SP_SPECIALITE
          WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
          AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
        )
        ORDER BY PRODUIT_DERIV_SANG DESC, SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API PRODUIT DERIV DU SANG GSP
  -- EXEMPLE: LISTID := '12,1788' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_PR_DERIV_SANG_GSP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS PRODUIT_DERIV_SANG
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
        )
        UNION
        SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS PRODUIT_DERIV_SANG
        FROM GSP_GENERIQUE_SPECIALITE GSP
        WHERE GSP.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP
          JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
            AND GSP.GSP_NB_SUB < 4
            AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
          )
        )
        ORDER BY PRODUIT_DERIV_SANG DESC, GSP_CODE
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''O'''' AS PRODUIT_DERIV_SANG
        FROM GSP_GENERIQUE_SPECIALITE GSP
        JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
          AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
          AND GSP.GSP_NB_SUB < 4
          AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
        )
        UNION
        SELECT DISTINCT GSP.GSP_CODE_SQ_PK AS GSP_CODE, GSP.GSP_NOM AS GSP_NOM, ''''N'''' AS PRODUIT_DERIV_SANG
        FROM GSP_GENERIQUE_SPECIALITE GSP
        WHERE GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
        AND GSP.GSP_CODE_SQ_PK NOT IN (
          SELECT GSP_CODE_SQ_PK
          FROM GSP_GENERIQUE_SPECIALITE GSP
          JOIN SP_SPECIALITE SP ON (SP.SP_GSP_CODE_FK = GSP.GSP_CODE_SQ_PK
            AND GSP.GSP_CODE_SQ_PK IN (''||LISTID||'')
            AND GSP.GSP_NB_SUB < 4
            AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZF'''')
          )
        )
        ORDER BY PRODUIT_DERIV_SANG DESC, GSP_CODE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API MEDICAMENT ORPHELIN SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_MEDIC_ORPH_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_MEDIC_ORPH_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
          CASE 
              WHEN PRESTC.PRESTC_CDF_STCOMP_CODE_FK_PK = ''''C8'''' THEN ''''O''''
              ELSE ''''N''''
            END AS MEDICAMENT_ORPHELIN
        FROM SP_SPECIALITE SP
        LEFT JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        LEFT JOIN PRESTC_STATUTCOMP_PRESENT PRESTC ON (PRESTC.PRESTC_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
          AND PRESTC.PRESTC_CDF_STCOMP_CODE_FK_PK = ''''C8'''')
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
          CASE 
              WHEN PRESTC.PRESTC_CDF_STCOMP_CODE_FK_PK = ''''C8'''' THEN ''''O''''
              ELSE ''''N''''
            END AS MEDICAMENT_ORPHELIN
        FROM SP_SPECIALITE SP
        LEFT JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        LEFT JOIN PRESTC_STATUTCOMP_PRESENT PRESTC ON (PRESTC.PRESTC_PRE_CODE_FK_PK = PRE.PRE_CODE_PK
          AND PRESTC.PRESTC_CDF_STCOMP_CODE_FK_PK = ''''C8'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API PGR ET SURVEILLANCE RENFORCEE SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_PGR_SURV_RENF_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_PGR_SURV_RENF_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
          CASE 
              WHEN CHTIT_CDF_TIT_CODE_FK_PK = ''''T16'''' THEN ''''O''''
              ELSE ''''N''''
            END AS PGR,
          CASE 
              WHEN SPCPD.SPCPD_CDF_STP_CODE_FK_PK = ''''S10'''' THEN ''''O''''
              ELSE ''''N''''
            END AS SURV_RENFORCEE
        FROM SP_SPECIALITE SP
        LEFT JOIN SPCH_SPECIALITE_CHOIX SPCH ON SPCH.SPCH_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CHTIT_CH_TITRE2 CHTIT ON (CHTIT.CHTIT_CH_CODE_FK_PK = SPCH.SPCH_CH_CODE_FK_PK
          AND CHTIT_CDF_TIT_CODE_FK_PK = ''''T16'''')
        LEFT JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = ''''S10'''')
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM,
          CASE 
              WHEN CHTIT_CDF_TIT_CODE_FK_PK = ''''T16'''' THEN ''''O''''
              ELSE ''''N''''
            END AS PGR,
          CASE 
              WHEN SPCPD.SPCPD_CDF_STP_CODE_FK_PK = ''''S10'''' THEN ''''O''''
              ELSE ''''N''''
            END AS SURV_RENFORCEE
        FROM SP_SPECIALITE SP
        LEFT JOIN SPCH_SPECIALITE_CHOIX SPCH ON SPCH.SPCH_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        LEFT JOIN CHTIT_CH_TITRE2 CHTIT ON (CHTIT.CHTIT_CH_CODE_FK_PK = SPCH.SPCH_CH_CODE_FK_PK
          AND CHTIT_CDF_TIT_CODE_FK_PK = ''''T16'''')
        LEFT JOIN SPCPD_SPE_CDT_PRESCR SPCPD ON (SPCPD.SPCPD_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          AND SPCPD.SPCPD_CDF_STP_CODE_FK_PK = ''''S10'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API COMMENTAIRES CIPEMG SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_COMM_CIPEMG_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_COMM_CIPEMG_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS COMMENTAIRES
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON AUTCOM.AUTCOM_FCPM_CODE_FK_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK
          AND CDF_NUMERO_PK = ''''CC'''')
        ORDER BY SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT DISTINCT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, CDF.CDF_NOM AS COMMENTAIRES
        FROM SP_SPECIALITE SP
        JOIN FCPMSP_CIPEMG_SPE FCPMSP ON FCPMSP.FCPMSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN AUTCOM_AUTRE_COMMENTAIRE AUTCOM ON AUTCOM.AUTCOM_FCPM_CODE_FK_PK = FCPMSP.FCPMSP_FCPM_CODE_FK_PK
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = AUTCOM.AUTCOM_CDF_COM_CODE_FK_PK
          AND CDF_NUMERO_PK = ''''CC'''')
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        ORDER BY SP_CODE_SQ_PK'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API REDONDANCE SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_REDOND_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_REDOND_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK AS SP_CODE_ANALYSE, SP.SP_NOM AS SP_NOM_ANALYSE, ''''O'''' AS REDONDANCE_MEME_CLASSE_ATC, SP2.SP_CODE_SQ_PK AS SP2_CODE_REDOND, SP2.SP_NOM AS SP2_NOM_REDOND
        FROM SP_SPECIALITE SP, SP_SPECIALITE SP2
       WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''',''''))) AND (SP2.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP2.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND LENGTH(SP.SP_CATC_CODE_FK) = 5
        AND LENGTH(SP2.SP_CATC_CODE_FK) = 5
        AND SP.SP_CATC_CODE_FK = SP2.SP_CATC_CODE_FK
        AND SP.SP_CODE_SQ_PK != SP2.SP_CODE_SQ_PK
        UNION
        SELECT SP.SP_CODE_SQ_PK AS SP_CODE_ANALYSE, SP.SP_NOM AS SP_NOM_ANALYSE, ''''N'''' AS REDONDANCE_MEME_CLASSE_ATC, (null) AS SP2_CODE_REDOND, (null) AS SP2_NOM_REDOND
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP, SP_SPECIALITE SP2
          WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''',''''))) AND (SP2.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP2.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
          AND LENGTH(SP.SP_CATC_CODE_FK) = 5
          AND LENGTH(SP2.SP_CATC_CODE_FK) = 5
          AND SP.SP_CATC_CODE_FK = SP2.SP_CATC_CODE_FK
          AND SP.SP_CODE_SQ_PK != SP2.SP_CODE_SQ_PK
        )
        ORDER BY SP_CODE_ANALYSE
        '';
  END IF;
  IF TYPID = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK AS SP_CODE_ANALYSE, SP.SP_NOM AS SP_NOM_ANALYSE, ''''O'''' AS REDONDANCE_MEME_CLASSE_SAC, SP2.SP_CODE_SQ_PK AS SP2_CODE_REDOND, SP2.SP_NOM AS SP2_NOM_REDOND, GSAC1.GSAC_NOM AS NOM_SAC_COMMUNE
        FROM SP_SPECIALITE SP
        JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
        JOIN GSAC_PERE_SUBACT GSAC1 ON GSAC1.GSAC_CODE_SQ_PK = SAC1.SAC_GSAC_CODE_FK,
        SP_SPECIALITE SP2
        JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
        JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
        JOIN GSAC_PERE_SUBACT GSAC2 ON GSAC2.GSAC_CODE_SQ_PK = SAC2.SAC_GSAC_CODE_FK
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''',''''))) AND (SP2.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP2.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND LENGTH(SP.SP_CATC_CODE_FK) = 7
        AND LENGTH(SP2.SP_CATC_CODE_FK) = 7
        AND GSAC1.GSAC_CODE_SQ_PK = GSAC2.GSAC_CODE_SQ_PK
        AND SP.SP_CATC_CODE_FK = SP2.SP_CATC_CODE_FK
        AND SP.SP_CODE_SQ_PK != SP2.SP_CODE_SQ_PK
        UNION
        SELECT SP.SP_CODE_SQ_PK AS SP_CODE_ANALYSE, SP.SP_NOM AS SP_NOM_ANALYSE, ''''N'''' AS REDONDANCE_MEME_CLASSE_SAC, (null) AS SP2_CODE_REDOND, (null) AS SP2_NOM_REDOND, (null) AS NOM_SAC_COMMUNE
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP.SP_CODE_SQ_PK 
          FROM SP_SPECIALITE SP
          JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
          JOIN GSAC_PERE_SUBACT GSAC1 ON GSAC1.GSAC_CODE_SQ_PK = SAC1.SAC_GSAC_CODE_FK,
          SP_SPECIALITE SP2
          JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
          JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
          JOIN GSAC_PERE_SUBACT GSAC2 ON GSAC2.GSAC_CODE_SQ_PK = SAC2.SAC_GSAC_CODE_FK
          WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''',''''))) AND (SP2.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP2.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
          AND LENGTH(SP.SP_CATC_CODE_FK) = 7
          AND LENGTH(SP2.SP_CATC_CODE_FK) = 7
          AND GSAC1.GSAC_CODE_SQ_PK = GSAC2.GSAC_CODE_SQ_PK
          AND SP.SP_CATC_CODE_FK = SP2.SP_CATC_CODE_FK
          AND SP.SP_CODE_SQ_PK != SP2.SP_CODE_SQ_PK
        )
        ORDER BY SP_CODE_ANALYSE
        '';
  END IF;
  IF TYPID = 3 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK AS SP_CODE_ANALYSE, SP.SP_NOM AS SP_NOM_ANALYSE, ''''O'''' AS REDONDANCE_MEME_SAC, SP2.SP_CODE_SQ_PK AS SP2_CODE_REDOND, SP2.SP_NOM AS SP2_NOM_REDOND, GSAC1.GSAC_NOM AS NOM_SAC_COMMUNE
        FROM SP_SPECIALITE SP
        JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
        JOIN GSAC_PERE_SUBACT GSAC1 ON GSAC1.GSAC_CODE_SQ_PK = SAC1.SAC_GSAC_CODE_FK,
        SP_SPECIALITE SP2
        JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
        JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
        JOIN GSAC_PERE_SUBACT GSAC2 ON GSAC2.GSAC_CODE_SQ_PK = SAC2.SAC_GSAC_CODE_FK
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''',''''))) AND (SP2.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP2.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND GSAC1.GSAC_CODE_SQ_PK = GSAC2.GSAC_CODE_SQ_PK
        AND SP.SP_CODE_SQ_PK != SP2.SP_CODE_SQ_PK
        UNION
        SELECT SP.SP_CODE_SQ_PK AS SP_CODE_ANALYSE, SP.SP_NOM AS SP_NOM_ANALYSE, ''''N'''' AS REDONDANCE_MEME_SAC, (null) AS SP2_CODE_REDOND, (null) AS SP2_NOM_REDOND, (null) AS NOM_SAC_COMMUNE
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CODE_SQ_PK NOT IN (
          SELECT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
          JOIN COSAC_COMPO_SUBACT COSAC1 ON COSAC1.COSAC_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
          JOIN SAC_SUBACTIVE SAC1 ON SAC1.SAC_CODE_SQ_PK = COSAC1.COSAC_SAC_CODE_FK_PK
          JOIN GSAC_PERE_SUBACT GSAC1 ON GSAC1.GSAC_CODE_SQ_PK = SAC1.SAC_GSAC_CODE_FK,
          SP_SPECIALITE SP2
          JOIN COSAC_COMPO_SUBACT COSAC2 ON COSAC2.COSAC_SP_CODE_FK_PK = SP2.SP_CODE_SQ_PK
          JOIN SAC_SUBACTIVE SAC2 ON SAC2.SAC_CODE_SQ_PK = COSAC2.COSAC_SAC_CODE_FK_PK
          JOIN GSAC_PERE_SUBACT GSAC2 ON GSAC2.GSAC_CODE_SQ_PK = SAC2.SAC_GSAC_CODE_FK
          WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''',''''))) AND (SP2.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP2.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
          AND GSAC1.GSAC_CODE_SQ_PK = GSAC2.GSAC_CODE_SQ_PK
          AND SP.SP_CODE_SQ_PK != SP2.SP_CODE_SQ_PK
        )
        ORDER BY SP_CODE_ANALYSE'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API GET_THE_SPE_INDIC_BY_CIM10

-- DROP FUNCTION GET_THE_SPE_INDIC_BY_CIM10(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_SPE_INDIC_BY_CIM10 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  CODE_CIM ALIAS FOR $1;  TYP ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYP = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT CIM_CODE, CIM_LIBELLE, SP_CODE_SQ_PK AS ID_SPE, SP_NOM AS LIB_SPE
FROM CIM10V2 CIM
JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CIM_NAIN_CODE_FK_PK = CIM.ID)
JOIN FINSP_INDSPE FINSP ON (FINSP.FINSP_FIN_CODE_FK_PK = FIN.FIN_CODE_SQ_PK)
		JOIN SP_SPECIALITE SP ON (SP.SP_CODE_SQ_PK = FINSP.FINSP_SP_CODE_FK_PK AND SP.SP_CDF_SLAB_CODE_FK <> 7)
		JOIN SP_INFORMATIONS INF ON (INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK AND INF.ETAT_COMMERCIALISATION NOT IN (''''S'''', ''''NC'''') AND INF.ETAT_COMMERCIALISATION IS NOT NULL)
WHERE CIM.CIM_CODE LIKE (
CASE
  WHEN POSITION(''||CODE_CIM||'', ''''.'''') = 0 THEN ''||CODE_CIM||'' || ''''%''''
  ELSE SUBSTRING(''||CODE_CIM||'', 0, POSITION(''||CODE_CIM||'', ''''.'''') - 1)||''''%''''
END
)
GROUP BY CIM_CODE, CIM_LIBELLE, SP_CODE_SQ_PK, SP_NOM
ORDER BY CIM_CODE,SP_NOM'';
  END IF;
  IF TYP = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT CIM_CODE, CIM_LIBELLE, SP_CODE_SQ_PK AS ID_SPE, SP_NOM AS LIB_SPE
FROM CIM10V2 CIM
JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CIM_NAIN_CODE_FK_PK = CIM.ID)
JOIN FINSP_INDSPE FINSP ON (FINSP.FINSP_FIN_CODE_FK_PK = FIN.FIN_CODE_SQ_PK)
		JOIN SP_SPECIALITE SP ON (SP.SP_CODE_SQ_PK = FINSP.FINSP_SP_CODE_FK_PK AND SP.SP_CDF_SLAB_CODE_FK <> 7)
		JOIN SP_INFORMATIONS INF ON (INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK AND INF.ETAT_COMMERCIALISATION NOT IN (''''S'''', ''''NC'''') AND INF.ETAT_COMMERCIALISATION IS NOT NULL)
WHERE CIM.CIM_CODE = ''||CODE_CIM||''
GROUP BY CIM_CODE, CIM_LIBELLE, SP_CODE_SQ_PK, SP_NOM
ORDER BY CIM_CODE,SP_NOM'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API GET_THE_GSP_INDIC_BY_CIM10

-- DROP FUNCTION GET_THE_GSP_INDIC_BY_CIM10(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_GSP_INDIC_BY_CIM10 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  CODE_CIM ALIAS FOR $1;  TYP ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYP = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT CIM_CODE, CIM_LIBELLE, GSP_CODE_SQ_PK AS ID_GPE, GSP_NOM AS LIB_GSP
FROM CIM10V2 CIM
JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CIM_NAIN_CODE_FK_PK = CIM.ID)
JOIN FINSP_INDSPE FINSP ON (FINSP.FINSP_FIN_CODE_FK_PK = FIN.FIN_CODE_SQ_PK)
		JOIN SP_SPECIALITE SP ON (SP.SP_CODE_SQ_PK = FINSP.FINSP_SP_CODE_FK_PK AND SP.SP_CDF_SLAB_CODE_FK <> 7)
		JOIN SP_INFORMATIONS INF ON (INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK AND INF.ETAT_COMMERCIALISATION NOT IN (''''S'''', ''''NC'''') AND INF.ETAT_COMMERCIALISATION IS NOT NULL)
JOIN GSP_GENERIQUE_SPECIALITE GSP ON (GSP.GSP_CODE_SQ_PK = SP_GSP_CODE_FK)
WHERE CIM.CIM_CODE LIKE (
CASE
  WHEN POSITION(''||CODE_CIM||'', ''''.'''') = 0 THEN ''||CODE_CIM||'' || ''''%''''
  ELSE SUBSTRING(''||CODE_CIM||'', 0, POSITION(''||CODE_CIM||'', ''''.'''') - 1)||''''%''''
END
)
GROUP BY CIM_CODE, CIM_LIBELLE, GSP_CODE_SQ_PK, GSP_NOM
ORDER BY CIM_CODE,GSP_NOM'';
  END IF;
  IF TYP = 2 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT CIM_CODE, CIM_LIBELLE, GSP_CODE_SQ_PK AS ID_GPE, GSP_NOM AS LIB_GSP
FROM CIM10V2 CIM
JOIN FIN_FICHEINDIC FIN ON (FIN.FIN_CIM_NAIN_CODE_FK_PK = CIM.ID)
JOIN FINSP_INDSPE FINSP ON (FINSP.FINSP_FIN_CODE_FK_PK = FIN.FIN_CODE_SQ_PK)
		JOIN SP_SPECIALITE SP ON (SP.SP_CODE_SQ_PK = FINSP.FINSP_SP_CODE_FK_PK AND SP.SP_CDF_SLAB_CODE_FK <> 7)
		JOIN SP_INFORMATIONS INF ON (INF.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK AND INF.ETAT_COMMERCIALISATION NOT IN (''''S'''', ''''NC'''') AND INF.ETAT_COMMERCIALISATION IS NOT NULL)
JOIN GSP_GENERIQUE_SPECIALITE GSP ON (GSP.GSP_CODE_SQ_PK = SP_GSP_CODE_FK)
WHERE CIM.CIM_CODE = ''||CODE_CIM||''
GROUP BY CIM_CODE, CIM_LIBELLE, GSP_CODE_SQ_PK, GSP_NOM
ORDER BY CIM_CODE,GSP_NOM'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API INFO SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_INFO_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_INFO_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, SP.SP_NOMLONG, SP.SP_CIPUCD, SP.SP_CIPUCD_LONG, PRE.PRE_CIP_REF, PRE.PRE_CODE_PK
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, SP.SP_NOMLONG, SP.SP_CIPUCD, SP.SP_CIPUCD_LONG, PRE.PRE_CIP_REF, PRE.PRE_CODE_PK
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API GET_THE_ETAT_COMMER_SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_ETAT_COMMER_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_ETAT_COMMER_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, SP.SP_NOMLONG, SP.SP_CIPUCD, SP.SP_CIPUCD_LONG, INFO.ETAT_COMMERCIALISATION
        FROM SP_SPECIALITE SP
        JOIN SP_INFORMATIONS INFO ON INFO.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, SP.SP_NOMLONG, SP.SP_CIPUCD, SP.SP_CIPUCD_LONG, INFO.ETAT_COMMERCIALISATION
        FROM SP_SPECIALITE SP
        JOIN SP_INFORMATIONS INFO ON INFO.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API GET_THE_EFFET_INDE_SPE
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_EFFET_INDE_SPE(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_EFFET_INDE_SPE (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, CDF.CDF_NOM AS EFFET_INDE
        FROM SP_SPECIALITE SP
        JOIN FEISP_EFFINDSPE FEISP ON FEISP.FEISP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FEI_FICHEEFFIND FEI ON (FEI.FEI_CODE_SQ_PK = FEISP.FEISP_FEI_CODE_FK_PK
          AND FEI.FEI_DOSETH = ''''O'''')
        JOIN FEINACT_NATURETHER_EICLIN FEINACT ON FEINACT.FEINACT_FEI_CODE_FK_PK = FEI.FEI_CODE_SQ_PK
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FEINACT.FEINACT_CDF_NAEI_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''EN'''')
        UNION
        SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, CDF.CDF_NOM
        FROM SP_SPECIALITE SP
        JOIN FEISP_EFFINDSPE FEISP ON FEISP.FEISP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FEI_FICHEEFFIND FEI ON (FEI.FEI_CODE_SQ_PK = FEISP.FEISP_FEI_CODE_FK_PK
          AND FEI.FEI_DOSETH = ''''O'''')
        JOIN FEINAPT_NATURTHER_EIPARACLIN FEINAPT ON FEINAPT.FEINAPT_FEI_CODE_FK_PK = FEI.FEI_CODE_SQ_PK
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FEINAPT.FEINAPT_CDF_NAEI_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''EN'''')
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, CDF.CDF_NOM AS EFFET_INDE
        FROM SP_SPECIALITE SP
        JOIN FEISP_EFFINDSPE FEISP ON FEISP.FEISP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FEI_FICHEEFFIND FEI ON (FEI.FEI_CODE_SQ_PK = FEISP.FEISP_FEI_CODE_FK_PK
          AND FEI.FEI_DOSETH = ''''O'''')
        JOIN FEINACT_NATURETHER_EICLIN FEINACT ON FEINACT.FEINACT_FEI_CODE_FK_PK = FEI.FEI_CODE_SQ_PK
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FEINACT.FEINACT_CDF_NAEI_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''EN'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        UNION
        SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM, CDF.CDF_NOM
        FROM SP_SPECIALITE SP
        JOIN FEISP_EFFINDSPE FEISP ON FEISP.FEISP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN FEI_FICHEEFFIND FEI ON (FEI.FEI_CODE_SQ_PK = FEISP.FEISP_FEI_CODE_FK_PK
          AND FEI.FEI_DOSETH = ''''O'''')
        JOIN FEINAPT_NATURTHER_EIPARACLIN FEINAPT ON FEINAPT.FEINAPT_FEI_CODE_FK_PK = FEI.FEI_CODE_SQ_PK
        JOIN CDF_CODIF CDF ON (CDF.CDF_CODE_PK = FEINAPT.FEINAPT_CDF_NAEI_CODE_FK_PK
          AND CDF.CDF_NUMERO_PK = ''''EN'''')
        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API GET_THE_POSO_V2
-- EXEMPLE: LISTID := '7690,7335,5925,4143' ET TYPID := 1

-- DROP FUNCTION GET_THE_POSO_V2(VARCHAR,NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_POSO_V2 (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''
        SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM,
          IPO.IPO_DOSEMIN, IPO.IPO_DOSEMAX, CDF_UDP.CDF_NOM AS UN_PRISE,
          IPO.IPO_FREQMIN, CDF_PFMIN.CDF_NOM AS FREQ_MIN,
          IPO.IPO_FREQMAX, CDF_PFMAX.CDF_NOM AS FREQ_MAX,
          IPO.IPO_DUREEMIN, CDF_PUMIN.CDF_NOM AS DUREE_MIN,
          IPO.IPO_DUREEMAX, CDF_PUMAX.CDF_NOM AS DUREE_MAX,
          CDF_PT.CDF_NOM AS AGE,
          CDF_NN.CIM_LIBELLE AS SYMPTOMES,
          CDF_18.CDF_NOM AS VOIE,
          FPOSP.FPOSP_FPO_CODE_FK_PK AS FIC
        FROM SP_SPECIALITE SP
        JOIN FPOSP_POSO_SPE FPOSP ON FPOSP.FPOSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN IPO_INFOPOSO IPO ON (IPO.IPO_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
          AND IPO_CDF_NAPO_CODE_FK IN (''''01'''',''''04''''))
        LEFT JOIN THESORIMED.CDF_CODIF CDF_UDP ON (CDF_UDP.CDF_CODE_PK = IPO.IPO_CDF_UNPO_CODE_FK
          AND CDF_UDP.CDF_NUMERO_PK = ''''PP'''')
        LEFT JOIN CDF_CODIF CDF_PFMIN ON (CDF_PFMIN.CDF_CODE_PK = IPO.IPO_CDF_FREQMIN_CODE_FK
          AND CDF_PFMIN.CDF_NUMERO_PK = ''''PF'''')
        LEFT JOIN CDF_CODIF CDF_PFMAX ON (CDF_PFMAX.CDF_CODE_PK = IPO.IPO_CDF_FREQMAX_CODE_FK
          AND CDF_PFMAX.CDF_NUMERO_PK = ''''PF'''')
        LEFT JOIN CDF_CODIF CDF_PUMIN ON (CDF_PUMIN.CDF_CODE_PK = IPO.IPO_CDF_UTMIN_CODE_FK
          AND CDF_PUMIN.CDF_NUMERO_PK = ''''PU'''')
        LEFT JOIN CDF_CODIF CDF_PUMAX ON (CDF_PUMAX.CDF_CODE_PK = IPO.IPO_CDF_UTMAX_CODE_FK
          AND CDF_PUMAX.CDF_NUMERO_PK = ''''PU'''')
        JOIN FPOTE_FPOSO_TERRAIN FPOTE ON FPOTE.FPOTE_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
        LEFT JOIN CDF_CODIF CDF_PT ON (CDF_PT.CDF_CODE_PK = FPOTE.FPOTE_CDF_TEPO_CODE_FK_PK
          AND CDF_PT.CDF_NUMERO_PK = ''''PT'''')
        JOIN FPOUT_FPOSO_UTILTH FPOUT ON FPOUT.FPOUT_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
--        LEFT JOIN CDF_CODIF CDF_NN ON (CDF_NN.CDF_CODE_PK = FPOUT.FPOUT_CDF_UTPO_CODE_FK_PK
--          AND CDF_NN.CDF_NUMERO_PK = ''''NN'''')
        LEFT JOIN CIM10V2 CDF_NN ON (CDF_NN.ID = FPOUT.FPOUT_CIM_UTPO_CODE_FK_PK)
        JOIN FPOVO_FPOSO_VOIE FPOVO ON FPOVO.FPOVO_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
        LEFT JOIN CDF_CODIF CDF_18 ON (CDF_18.CDF_CODE_PK = FPOVO.FPOVO_CDF_VO_CODE_FK_PK
          AND CDF_18.CDF_NUMERO_PK = ''''18'''')
          ORDER BY SP.SP_CODE_SQ_PK, FPOSP.FPOSP_FPO_CODE_FK_PK, CDF_PT.CDF_NOM
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK, SP.SP_NOM,
          IPO.IPO_DOSEMIN, IPO.IPO_DOSEMAX, CDF_UDP.CDF_NOM AS UN_PRISE,
          IPO.IPO_FREQMIN, CDF_PFMIN.CDF_NOM AS FREQ_MIN,
          IPO.IPO_FREQMAX, CDF_PFMAX.CDF_NOM AS FREQ_MAX,
          IPO.IPO_DUREEMIN, CDF_PUMIN.CDF_NOM AS DUREE_MIN,
          IPO.IPO_DUREEMAX, CDF_PUMAX.CDF_NOM AS DUREE_MAX,
          CDF_PT.CDF_NOM AS AGE,
          CDF_NN.CIM_LIBELLE AS SYMPTOMES,
          CDF_18.CDF_NOM AS VOIE,
          FPOSP.FPOSP_FPO_CODE_FK_PK AS FIC
        FROM SP_SPECIALITE SP
        JOIN FPOSP_POSO_SPE FPOSP ON FPOSP.FPOSP_SP_CODE_FK_PK = SP.SP_CODE_SQ_PK
        JOIN IPO_INFOPOSO IPO ON (IPO.IPO_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
          AND IPO_CDF_NAPO_CODE_FK IN (''''01'''',''''04''''))
        LEFT JOIN THESORIMED.CDF_CODIF CDF_UDP ON (CDF_UDP.CDF_CODE_PK = IPO.IPO_CDF_UNPO_CODE_FK
          AND CDF_UDP.CDF_NUMERO_PK = ''''PP'''')
        LEFT JOIN CDF_CODIF CDF_PFMIN ON (CDF_PFMIN.CDF_CODE_PK = IPO.IPO_CDF_FREQMIN_CODE_FK
          AND CDF_PFMIN.CDF_NUMERO_PK = ''''PF'''')
        LEFT JOIN CDF_CODIF CDF_PFMAX ON (CDF_PFMAX.CDF_CODE_PK = IPO.IPO_CDF_FREQMAX_CODE_FK
          AND CDF_PFMAX.CDF_NUMERO_PK = ''''PF'''')
        LEFT JOIN CDF_CODIF CDF_PUMIN ON (CDF_PUMIN.CDF_CODE_PK = IPO.IPO_CDF_UTMIN_CODE_FK
          AND CDF_PUMIN.CDF_NUMERO_PK = ''''PU'''')
        LEFT JOIN CDF_CODIF CDF_PUMAX ON (CDF_PUMAX.CDF_CODE_PK = IPO.IPO_CDF_UTMAX_CODE_FK
          AND CDF_PUMAX.CDF_NUMERO_PK = ''''PU'''')
        JOIN FPOTE_FPOSO_TERRAIN FPOTE ON FPOTE.FPOTE_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
        LEFT JOIN CDF_CODIF CDF_PT ON (CDF_PT.CDF_CODE_PK = FPOTE.FPOTE_CDF_TEPO_CODE_FK_PK
          AND CDF_PT.CDF_NUMERO_PK = ''''PT'''')
        JOIN FPOUT_FPOSO_UTILTH FPOUT ON FPOUT.FPOUT_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
--        LEFT JOIN CDF_CODIF CDF_NN ON (CDF_NN.CDF_CODE_PK = FPOUT.FPOUT_CDF_UTPO_CODE_FK_PK
--          AND CDF_NN.CDF_NUMERO_PK = ''''NN'''')
        LEFT JOIN CIM10V2 CDF_NN ON (CDF_NN.ID = FPOUT.FPOUT_CIM_UTPO_CODE_FK_PK)
        JOIN FPOVO_FPOSO_VOIE FPOVO ON FPOVO.FPOVO_FPO_CODE_FK_PK = FPOSP.FPOSP_FPO_CODE_FK_PK
        LEFT JOIN CDF_CODIF CDF_18 ON (CDF_18.CDF_CODE_PK = FPOVO.FPOVO_CDF_VO_CODE_FK_PK
          AND CDF_18.CDF_NUMERO_PK = ''''18'''')

        WHERE SP.SP_CODE_SQ_PK IN (''||LISTID||'')
          ORDER BY SP.SP_CODE_SQ_PK, FPOSP.FPOSP_FPO_CODE_FK_PK, CDF_PT.CDF_NOM
        '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;


-- API GET_THE_COMPO_ALLSUB_SP
-- EXEMPLE: LISTID := '4519,3671,8932,22169,427'

-- DROP FUNCTION GET_THE_COMPO_ALLSUB_SP(NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_COMPO_ALLSUB_SP (NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  CODEID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT ''''SUBAUX'''' AS TYPSUBST, COSAU_DOSAGE AS DOSESUBST, COSAU_UNITEDOSAGE AS UDOSESUBST, SAU_GSAU_CODE_FK AS ID_SUB_PERE, GSAU_NOM AS SUB_PERE, COSAU_SAU_CODE_FK_PK AS ID_SUB, SAU_NOM AS SUB_NOM, COSAU_NUMORD AS NUMORDRE, COSAU_COMPO_NUM_PK AS COMPORDRE
        FROM COSAU_COMPO_SUBAUX, SAU_SUBAUXILIAIRE
        LEFT JOIN GSAU_PERE_SUBAUX ON GSAU_CODE_SQ_PK = SAU_GSAU_CODE_FK
        WHERE COSAU_SP_CODE_FK_PK = ''''''||CODEID||''''''
        AND COSAU_SAU_CODE_FK_PK = SAU_CODE_SQ_PK
        AND GSAU_CODE_SQ_PK = SAU_GSAU_CODE_FK
        UNION
        SELECT ''''SUBAC'''' AS TYPSUBST, COSAC_DOSAGE AS DOSESUBST, COSAC_UNITEDOSAGE AS UDOSESUBST, SAC_GSAC_CODE_FK AS ID_SUB_PERE, GSAC_NOM AS SUB_PERE, COSAC_SAC_CODE_FK_PK AS ID_SUB, SAC_NOM AS SUB_NOM, COSAC_NUMORD AS NUMORDRE, COSAC_COMPO_NUM_PK AS COMPORDRE
        FROM COSAC_COMPO_SUBACT, SAC_SUBACTIVE
        LEFT JOIN GSAC_PERE_SUBACT ON GSAC_CODE_SQ_PK = SAC_GSAC_CODE_FK
        WHERE COSAC_SP_CODE_FK_PK = ''''''||CODEID||''''''
        AND SAC_CODE_SQ_PK = COSAC_SAC_CODE_FK_PK
        AND GSAC_CODE_SQ_PK = SAC_GSAC_CODE_FK
        ORDER BY 1, 8, 9'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API THERAPIES CIBLEES ANTCANCEREUSES
  -- EXEMPLE: LISTID := '157,658,8488' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_THERAP_ANTICANC (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS THERAP_ANTICANC
        FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZB'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS THERAP_ANTICANC
        FROM SP_SPECIALITE SPN
        WHERE SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM  SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZB'''')
        )
        ORDER BY THERAP_ANTICANC DESC, SP_CODE_SQ_PK
        '';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''
    SELECT SP.SP_CIPUCD AS SP_CIPUCD, SP.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SP.SP_NOM AS SP_NOM, ''''O'''' AS THERAP_ANTICANC
        FROM SP_SPECIALITE SP
        WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZB'''')
        UNION
        SELECT SPN.SP_CIPUCD AS SP_CIPUCD, SPN.SP_CODE_SQ_PK AS SP_CODE_SQ_PK, SPN.SP_NOM AS SP_NOM, ''''N'''' AS THERAP_ANTICANC
        FROM SP_SPECIALITE SPN
        WHERE (SPN.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SPN.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
        AND SPN.SP_CODE_SQ_PK NOT IN (
          SELECT DISTINCT SP.SP_CODE_SQ_PK
          FROM SP_SPECIALITE SP
        WHERE SP.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZB'''')
        )
        ORDER BY THERAP_ANTICANC DESC, SP_CODE_SQ_PK
          '';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API GET_THE_DELIVRE_MAX
-- EXEMPLE: LISTID := '5603,16196'

-- DROP FUNCTION GET_THE_DELIVRE_MAX(NUMERIC);
CREATE OR REPLACE FUNCTION GET_THE_DELIVRE_MAX (NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT SP_CODE_SQ_PK AS ID_SPE, SP_NOM,
  TU.PSO_TYP_UNIT_PK AS ID_TY_UNIT, TU.PSO_TYP_UNIT_NAME AS TYP_NAME, UN.PSO_UNIT_PK AS ID_UNIT, PSO.PSO_POS_V_MAX AS QTE_MAX, UN.PSO_UNIT_NAME_SH AS UNIT_NAME,
  BI.PSO_TYP_UNIT_PK AS ID_UN_ADM, PSO.PSO_VAL_UNIT_ADM NB_ADM, UN2.PSO_UNIT_NAME_SH AS UN_ADM_NAME
FROM SP_SPECIALITE
JOIN PSO_SP_POSO PSO ON (PSO_SP_CODE_SQ_PK = SP_CODE_SQ_PK AND PSO_NAT_POSO_ID = 314)
JOIN PSO_TYPE_UNIT TU ON (TU.PSO_TYP_UNIT_PK = PSO.PSO_TYP_UNIT_MAX)
JOIN PSO_UNIT UN ON (UN.PSO_UNIT_PK = PSO.PSO_UNIT_MAX)
JOIN PSO_TYPE_UNIT BI ON (BI.PSO_TYP_UNIT_PK = PSO.PSO_TYP_UNIT_ADM)
JOIN PSO_UNIT UN2 ON (UN2.PSO_UNIT_PK = PSO.PSO_UNIT_ADM)
JOIN PSO_TYPE_POSO NAT ON (NAT.PSO_NAT_POSO_ID = PSO.PSO_POS_V_MAX)
WHERE (SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

  -- API Indique pour une liste de spécialités ou UCD, si cette dernière est d'origine BIOLOGIQUE.
  -- EXEMPLE: LISTID := '4561,19065'
CREATE OR REPLACE FUNCTION GET_THE_SPE_IS_OR_BIO (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK AS ID_SPE, SP.SP_CIPUCD AS UCD, SP.SP_NOM
 , SP.SP_CATC_CODE_FK AS CATC, CATC_NOMF AS CATC_NAME,
 (CASE
	WHEN SP1.SP_CODE_SQ_PK IS NULL THEN ''''N''''
	ELSE ''''O''''
	END) AS IS_BIO
FROM SP_SPECIALITE SP
LEFT JOIN SP_SPECIALITE SP1 ON (SP1.SP_CODE_SQ_PK = SP.SP_CODE_SQ_PK 
AND SP1.SP_CATC_CODE_FK IN (SELECT CATC_CODE_FK_PK FROM ATC_CPH where CPH_CODE_FK_PK = ''''ZZJ''''))
LEFT JOIN CATC_CLASSEATC ON ( CATC_CODE_PK = SP.SP_CATC_CODE_FK)
		WHERE (SP.SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP.SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- DROP FUNCTION GET_THE_SPE_INTEROP(VARCHAR);
CREATE OR REPLACE FUNCTION GET_THE_SPE_INTEROP (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  CURRET REFCURSOR;
BEGIN
    OPEN CURRET FOR EXECUTE ''SELECT SP_CODE_SQ_PK AS ID_SPE,SP_CIPUCD AS UCD7,SP_CIPUCD_LONG AS UCD13,PRE_CODE_PK AS CIP13,PRE_CIP_REF AS CIP7,SP_NOM
      FROM SP_SPECIALITE,PRE_PRESENTATION 
      WHERE PRE_SP_CODE_FK= SP_CODE_SQ_PK'';
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;




  -- API Indique pour une liste de spécialités ou UCD, si le médicament est une hormonothérapie.
  -- EXEMPLE: LISTID := '33454,9075123' et TYPID = 1;
CREATE OR REPLACE FUNCTION GET_THE_SPE_HORMONO (VARCHAR, NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;
  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT sp_cipucd as UCD, sp_code_sq_pk AS IDSPE, sp_nom, sp_catc_code_fk AS CATC, is_hormono(sp_code_sq_pk)
		FROM sp_specialite
		ORDER BY sp_nom'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT sp_cipucd as UCD, sp_code_sq_pk AS IDSPE, sp_nom, sp_catc_code_fk AS CATC, is_hormono(sp_code_sq_pk)
		FROM sp_specialite
		WHERE (SP_CODE_SQ_PK IN (''||LISTID||'') OR cast(SP_CIPUCD as text) = ANY (string_to_array(''''''||LISTID||'''''','''','''')))
		ORDER BY sp_nom'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

-- API retourne le texte d'une interaction
-- DROP FUNCTION GET_THE_GTIAM_TXT(VARCHAR);
CREATE OR REPLACE FUNCTION thesorimed.GET_THE_GTIAM_TXT (VARCHAR) RETURNS REFCURSOR AS '
DECLARE
  LISTFIC ALIAS FOR $1;
  curRet REFCURSOR;
BEGIN
    OPEN curRet FOR EXECUTE ''SELECT FIT_CODE_SQ_PK AS NOFIT, FIT_TEXTE AS TEXTE, FIT_DATECR AS DATE_TXT
FROM FIT_FICHEINTERAC
WHERE FIT_CODE_SQ_PK IN (''||LISTFIC||'')
ORDER BY NOFIT'';
  RETURN curRet;
END;

' LANGUAGE plpgsql;

  -- API RESERVE HOSPITALIERE AU CIP
  -- EXEMPLE: LISTID := '''3400930916292'',''3400955009443'',''3400955026655''' ET TYPID := 1
CREATE OR REPLACE FUNCTION GET_THE_RESERVE_HOSP_CIP (VARCHAR,NUMERIC) RETURNS REFCURSOR AS '
DECLARE
  LISTID ALIAS FOR $1;  TYPID ALIAS FOR $2;
  CURRET REFCURSOR;
BEGIN
  IF TYPID = 0 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK AS ID_SPE, SP.SP_CIPUCD AS SP_CIPUCD, PRE.PRE_CODE_PK AS CIP, SP.SP_NOM AS SP_NOM, 
        CASE WHEN PRE_CDF_RH_CODE_FK = ''''5'''' THEN ''''RH'''' ELSE ''''NON'''' END AS RESERVE_HOSPITALIERE
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON (PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK)
        ORDER BY RESERVE_HOSPITALIERE, SP.SP_NOM'';
  END IF;
  IF TYPID = 1 THEN 
    OPEN CURRET FOR EXECUTE ''SELECT SP.SP_CODE_SQ_PK AS ID_SPE, SP.SP_CIPUCD AS SP_CIPUCD, PRE.PRE_CODE_PK AS CIP, SP.SP_NOM AS SP_NOM, 
        CASE WHEN PRE_CDF_RH_CODE_FK = ''''5'''' THEN ''''RH'''' ELSE ''''NON'''' END AS RESERVE_HOSPITALIERE
        FROM SP_SPECIALITE SP
        JOIN PRE_PRESENTATION PRE ON (PRE.PRE_SP_CODE_FK = SP.SP_CODE_SQ_PK AND PRE.PRE_CODE_PK IN (''||LISTID||''))
        ORDER BY RESERVE_HOSPITALIERE, SP.SP_NOM'';
  END IF;
  RETURN CURRET;
END;

' LANGUAGE PLPGSQL;

